
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Tài liệu kiến trúc và phát triển cho dự án Chuyển đổi số Trường Việt Anh (dx_vas)." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://dx.truongvietanh.edu.vn/services/user-service/design/" rel="canonical"/>
<link href="../../../dev/ops-guide/" rel="prev"/>
<link href="../interface-contract/" rel="next"/>
<link href="../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Tổng quan Thiết kế - DX VAS - Docs</title>
<link href="../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#user-service-thiet-ke-chi-tiet">
          Bỏ qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Đầu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Tổng quan Thiết kế
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Tìm kiếm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Tìm kiếm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Tìm kiếm" class="md-search__options">
<button aria-label="Xoá" class="md-search__icon md-icon" tabindex="-1" title="Xoá" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
          
  
  
    
  
  Kiến trúc Hệ thống

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../dev/dev-guide/">
          
  
  
    
  
  Hướng dẫn Phát triển

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="./">
          
  
  
    
  
  Thiết kế Services

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ADR/">
          
  
  
    
  
  Quyết định Kiến trúc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh điều hướng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem mã nguồn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Kiến trúc Hệ thống
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiến trúc Hệ thống
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    Sơ đồ Hệ thống
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiết
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Hướng dẫn Phát triển
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Hướng dẫn Phát triển
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev/dev-guide/">
<span class="md-ellipsis">
    Tổng quan Phát triển (Dev Guide)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev/backend-dev-guide/">
<span class="md-ellipsis">
    Backend Dev Guide
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev/ops-guide/">
<span class="md-ellipsis">
    Vận hành &amp; DevOps (Ops Guide)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    Thiết kế Services
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Thiết kế Services
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="">
<span class="md-ellipsis">
    User Service
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            User Service
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Tổng quan Thiết kế
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Tổng quan Thiết kế
    
  </span>
</a>
<nav aria-label="Mục lục" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Mục lục
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-scope-responsibilities">
<span class="md-ellipsis">
      1. Scope &amp; Responsibilities
    </span>
</a>
<nav aria-label="1. Scope &amp; Responsibilities" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#trach-nhiem-chinh">
<span class="md-ellipsis">
      Trách nhiệm chính:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#khong-chiu-trach-nhiem">
<span class="md-ellipsis">
      Không chịu trách nhiệm:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tich-hop">
<span class="md-ellipsis">
      Tích hợp:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-api-specification">
<span class="md-ellipsis">
      2. API Specification
    </span>
</a>
<nav aria-label="2. API Specification" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mo-ta-tong-quan">
<span class="md-ellipsis">
      Mô tả tổng quan:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quy-uoc-tra-ve">
<span class="md-ellipsis">
      Quy ước trả về:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bao-mat-phan-quyen">
<span class="md-ellipsis">
      Bảo mật &amp; phân quyền:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-data-model">
<span class="md-ellipsis">
      3. Data Model
    </span>
</a>
<nav aria-label="3. Data Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-quan-cac-bang-chinh">
<span class="md-ellipsis">
      Tổng quan các bảng chính:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-thiet-ke">
<span class="md-ellipsis">
      Ghi chú thiết kế:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-business-logic-flows-luong-nghiep-vu-chinh">
<span class="md-ellipsis">
      4. Business Logic Flows – Luồng nghiệp vụ chính
    </span>
</a>
<nav aria-label="4. Business Logic Flows – Luồng nghiệp vụ chính" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai">
<span class="md-ellipsis">
      4.1. Đăng nhập thành công → Cập nhật người dùng (auto-create nếu chưa tồn tại)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-cap-nhat-trang-thai-nguoi-dung-active-inactive">
<span class="md-ellipsis">
      4.2. Cập nhật trạng thái người dùng (Active / Inactive)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-cap-nhat-rbac-cho-nguoi-dung">
<span class="md-ellipsis">
      4.3. Cập nhật RBAC cho người dùng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis">
<span class="md-ellipsis">
      4.4. Tạo người dùng mới từ hệ thống khác (ví dụ: CRM, SIS)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#45-cap-nhat-phan-quyen-ong">
<span class="md-ellipsis">
      4.5. Cập nhật phân quyền động
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#46-ngung-kich-hoat-tai-khoan-nguoi-dung">
<span class="md-ellipsis">
      4.6. Ngừng kích hoạt tài khoản người dùng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-events-cac-su-kien-user-service-phat-ra">
<span class="md-ellipsis">
      5. Events – Các sự kiện User Service phát ra
    </span>
</a>
<nav aria-label="5. Events – Các sự kiện User Service phát ra" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-user_created">
<span class="md-ellipsis">
      5.1. user_created
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-user_status_changed">
<span class="md-ellipsis">
      5.2. user_status_changed
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-rbac_updated">
<span class="md-ellipsis">
      5.3. rbac_updated
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-authorization-security">
<span class="md-ellipsis">
      6. Authorization &amp; Security
    </span>
</a>
<nav aria-label="6. Authorization &amp; Security" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-cac-permission-yeu-cau-khi-goi-api-tu-gateway">
<span class="md-ellipsis">
      6.1. Các permission yêu cầu khi gọi API từ Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cach-user-service-anh-gia-phan-quyen">
<span class="md-ellipsis">
      6.2. Cách User Service đánh giá phân quyền
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-kiem-soat-thay-oi-rbac">
<span class="md-ellipsis">
      6.3. Kiểm soát thay đổi RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-bao-mat-du-lieu">
<span class="md-ellipsis">
      6.4. Bảo mật dữ liệu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-audit-logging">
<span class="md-ellipsis">
      6.5. Audit Logging
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-configuration-dependencies">
<span class="md-ellipsis">
      7. Configuration &amp; Dependencies
    </span>
</a>
<nav aria-label="7. Configuration &amp; Dependencies" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-env">
<span class="md-ellipsis">
      7.1. Biến môi trường (.env)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file">
<span class="md-ellipsis">
      7.2. Secrets (được inject từ Secret Manager hoặc mounted file)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-phu-thuoc-dich-vu-noi-bo">
<span class="md-ellipsis">
      7.3. Phụ thuộc dịch vụ nội bộ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-quy-uoc-cau-hinh-noi-bo">
<span class="md-ellipsis">
      7.4. Quy ước cấu hình nội bộ
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-testing-strategy">
<span class="md-ellipsis">
      8. Testing Strategy
    </span>
</a>
<nav aria-label="8. Testing Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-test">
<span class="md-ellipsis">
      8.1. Unit Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-test">
<span class="md-ellipsis">
      8.2. Integration Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-pubsub-testing">
<span class="md-ellipsis">
      8.3. Pub/Sub Testing
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      Next Steps
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../interface-contract/">
<span class="md-ellipsis">
    Hợp đồng Giao diện
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data-model/">
<span class="md-ellipsis">
    Mô hình Dữ liệu
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../openapi.yaml">
<span class="md-ellipsis">
    Đặc tả OpenAPI
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ADR/">
<span class="md-ellipsis">
    Quyết định Kiến trúc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyết định Kiến trúc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Mục lục" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Mục lục
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-scope-responsibilities">
<span class="md-ellipsis">
      1. Scope &amp; Responsibilities
    </span>
</a>
<nav aria-label="1. Scope &amp; Responsibilities" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#trach-nhiem-chinh">
<span class="md-ellipsis">
      Trách nhiệm chính:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#khong-chiu-trach-nhiem">
<span class="md-ellipsis">
      Không chịu trách nhiệm:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tich-hop">
<span class="md-ellipsis">
      Tích hợp:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-api-specification">
<span class="md-ellipsis">
      2. API Specification
    </span>
</a>
<nav aria-label="2. API Specification" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mo-ta-tong-quan">
<span class="md-ellipsis">
      Mô tả tổng quan:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quy-uoc-tra-ve">
<span class="md-ellipsis">
      Quy ước trả về:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bao-mat-phan-quyen">
<span class="md-ellipsis">
      Bảo mật &amp; phân quyền:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-data-model">
<span class="md-ellipsis">
      3. Data Model
    </span>
</a>
<nav aria-label="3. Data Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-quan-cac-bang-chinh">
<span class="md-ellipsis">
      Tổng quan các bảng chính:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-thiet-ke">
<span class="md-ellipsis">
      Ghi chú thiết kế:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-business-logic-flows-luong-nghiep-vu-chinh">
<span class="md-ellipsis">
      4. Business Logic Flows – Luồng nghiệp vụ chính
    </span>
</a>
<nav aria-label="4. Business Logic Flows – Luồng nghiệp vụ chính" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai">
<span class="md-ellipsis">
      4.1. Đăng nhập thành công → Cập nhật người dùng (auto-create nếu chưa tồn tại)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-cap-nhat-trang-thai-nguoi-dung-active-inactive">
<span class="md-ellipsis">
      4.2. Cập nhật trạng thái người dùng (Active / Inactive)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-cap-nhat-rbac-cho-nguoi-dung">
<span class="md-ellipsis">
      4.3. Cập nhật RBAC cho người dùng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis">
<span class="md-ellipsis">
      4.4. Tạo người dùng mới từ hệ thống khác (ví dụ: CRM, SIS)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#45-cap-nhat-phan-quyen-ong">
<span class="md-ellipsis">
      4.5. Cập nhật phân quyền động
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#46-ngung-kich-hoat-tai-khoan-nguoi-dung">
<span class="md-ellipsis">
      4.6. Ngừng kích hoạt tài khoản người dùng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-events-cac-su-kien-user-service-phat-ra">
<span class="md-ellipsis">
      5. Events – Các sự kiện User Service phát ra
    </span>
</a>
<nav aria-label="5. Events – Các sự kiện User Service phát ra" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-user_created">
<span class="md-ellipsis">
      5.1. user_created
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-user_status_changed">
<span class="md-ellipsis">
      5.2. user_status_changed
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-rbac_updated">
<span class="md-ellipsis">
      5.3. rbac_updated
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-authorization-security">
<span class="md-ellipsis">
      6. Authorization &amp; Security
    </span>
</a>
<nav aria-label="6. Authorization &amp; Security" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-cac-permission-yeu-cau-khi-goi-api-tu-gateway">
<span class="md-ellipsis">
      6.1. Các permission yêu cầu khi gọi API từ Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cach-user-service-anh-gia-phan-quyen">
<span class="md-ellipsis">
      6.2. Cách User Service đánh giá phân quyền
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-kiem-soat-thay-oi-rbac">
<span class="md-ellipsis">
      6.3. Kiểm soát thay đổi RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-bao-mat-du-lieu">
<span class="md-ellipsis">
      6.4. Bảo mật dữ liệu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-audit-logging">
<span class="md-ellipsis">
      6.5. Audit Logging
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-configuration-dependencies">
<span class="md-ellipsis">
      7. Configuration &amp; Dependencies
    </span>
</a>
<nav aria-label="7. Configuration &amp; Dependencies" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-env">
<span class="md-ellipsis">
      7.1. Biến môi trường (.env)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file">
<span class="md-ellipsis">
      7.2. Secrets (được inject từ Secret Manager hoặc mounted file)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-phu-thuoc-dich-vu-noi-bo">
<span class="md-ellipsis">
      7.3. Phụ thuộc dịch vụ nội bộ
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-quy-uoc-cau-hinh-noi-bo">
<span class="md-ellipsis">
      7.4. Quy ước cấu hình nội bộ
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-testing-strategy">
<span class="md-ellipsis">
      8. Testing Strategy
    </span>
</a>
<nav aria-label="8. Testing Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-test">
<span class="md-ellipsis">
      8.1. Unit Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-test">
<span class="md-ellipsis">
      8.2. Integration Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-pubsub-testing">
<span class="md-ellipsis">
      8.3. Pub/Sub Testing
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      Next Steps
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="user-service-thiet-ke-chi-tiet">User Service – Thiết kế chi tiết<a class="headerlink" href="#user-service-thiet-ke-chi-tiet" title="Permanent link">¶</a></h1>
<h2 id="1-scope-responsibilities">1. Scope &amp; Responsibilities<a class="headerlink" href="#1-scope-responsibilities" title="Permanent link">¶</a></h2>
<p><strong>Mô tả ngắn:</strong>
User Service là service cốt lõi của hệ thống dx-vas, chịu trách nhiệm quản lý thông tin định danh, trạng thái và phân quyền người dùng (RBAC). Đây là trung tâm phân quyền động (condition-based), là nơi duy nhất ghi nhận user-role-permission mapping.</p>
<h3 id="trach-nhiem-chinh">Trách nhiệm chính:<a class="headerlink" href="#trach-nhiem-chinh" title="Permanent link">¶</a></h3>
<ul>
<li>Quản lý dữ liệu định danh người dùng:</li>
<li><code>user_id</code>, <code>name</code>, <code>email</code>, <code>status</code>, <code>created_at</code>, <code>updated_at</code></li>
<li>Quản lý trạng thái tài khoản: <code>pending</code>, <code>active</code>, <code>inactive</code>, <code>deleted</code></li>
<li>Phân quyền động (RBAC):</li>
<li>Quản lý <code>roles</code>, <code>permissions</code></li>
<li>Mapping user → roles → permissions (với <code>condition</code>)</li>
<li>Cung cấp API cho API Gateway kiểm tra quyền (qua Redis hoặc API fallback)</li>
<li>Phát sự kiện <code>rbac_updated</code>, <code>user_status_changed</code> để đồng bộ RBAC cache tại Gateway</li>
</ul>
<h3 id="khong-chiu-trach-nhiem">Không chịu trách nhiệm:<a class="headerlink" href="#khong-chiu-trach-nhiem" title="Permanent link">¶</a></h3>
<ul>
<li>Đăng nhập / xác thực người dùng (thuộc Auth Service)</li>
<li>Gửi thông báo (thuộc Notification Service)</li>
<li>Truy xuất thông tin học sinh / phụ huynh (thuộc SIS)</li>
</ul>
<h3 id="tich-hop">Tích hợp:<a class="headerlink" href="#tich-hop" title="Permanent link">¶</a></h3>
<ul>
<li>Redis Cache: để đẩy RBAC user snapshot phục vụ API Gateway</li>
<li>Pub/Sub: để publish các sự kiện <code>user_status_changed</code>, <code>rbac_updated</code></li>
<li>Cloud SQL (PostgreSQL): lưu trữ dữ liệu chính</li>
</ul>
<hr/>
<h2 id="2-api-specification">2. API Specification<a class="headerlink" href="#2-api-specification" title="Permanent link">¶</a></h2>
<p>Các API của User Service được định nghĩa chi tiết trong file OpenAPI tại:
👉 <a href="../../../openapi/user-service/openapi.yaml"><code>openapi.yaml</code></a></p>
<h3 id="mo-ta-tong-quan">Mô tả tổng quan:<a class="headerlink" href="#mo-ta-tong-quan" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Mô tả ngắn</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/users</code></td>
<td>Lấy danh sách người dùng, có phân trang &amp; lọc</td>
</tr>
<tr>
<td>POST</td>
<td><code>/users</code></td>
<td>Tạo người dùng mới (chỉ dành cho Admin Service)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/users/{id}</code></td>
<td>Lấy chi tiết người dùng</td>
</tr>
<tr>
<td>PATCH</td>
<td><code>/users/{id}</code></td>
<td>Cập nhật thông tin người dùng</td>
</tr>
<tr>
<td>PATCH</td>
<td><code>/users/{id}/status</code></td>
<td>Cập nhật trạng thái hoạt động (is_active)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/users/{id}/permissions</code></td>
<td>Lấy danh sách quyền của user (gồm condition)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/users/{id}/permissions/raw</code></td>
<td>Lấy full RBAC raw (roles, permissions, mapping)</td>
</tr>
</tbody>
</table>
<h3 id="quy-uoc-tra-ve">Quy ước trả về:<a class="headerlink" href="#quy-uoc-tra-ve" title="Permanent link">¶</a></h3>
<ul>
<li>Tuân theo cấu trúc chuẩn đã mô tả trong <code>backend-dev-guide.md</code></li>
<li>Luôn bọc kết quả trong <code>DataEnvelope</code>, lỗi trong <code>ErrorEnvelope</code></li>
<li>Mã lỗi được định nghĩa thống nhất trong hệ thống (4xx, 5xx)</li>
</ul>
<h3 id="bao-mat-phan-quyen">Bảo mật &amp; phân quyền:<a class="headerlink" href="#bao-mat-phan-quyen" title="Permanent link">¶</a></h3>
<ul>
<li>Các endpoint yêu cầu JWT hợp lệ từ Gateway</li>
<li>Một số endpoint yêu cầu <code>X-Permissions</code> tương ứng (<code>user:read</code>, <code>user:update</code>, <code>rbac:view</code>, v.v.)</li>
<li>RBAC được kiểm tra bởi Gateway dựa trên dữ liệu từ Redis hoặc fallback qua <code>GET /users/{id}/permissions</code></li>
</ul>
<p>📌 Để xem mô tả tổng quan về các endpoints, mục tiêu và các quy ước giao tiếp của User Service, vui lòng tham khảo tài liệu Interface Contract:
👉 <strong><a href="../interface-contract/">Interface Contract</a></strong></p>
<p>📌 Chi tiết schema input/output vui lòng xem tại: <strong><a href="../openapi.yaml"><code>openapi.yaml</code></a></strong></p>
<hr/>
<h2 id="3-data-model">3. Data Model<a class="headerlink" href="#3-data-model" title="Permanent link">¶</a></h2>
<p>📄 Chi tiết bảng CSDL được mô tả trong <a href="../data-model/"><code>data-model.md</code></a></p>
<h3 id="tong-quan-cac-bang-chinh">Tổng quan các bảng chính:<a class="headerlink" href="#tong-quan-cac-bang-chinh" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Bảng</th>
<th>Mô tả chức năng</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users</code></td>
<td>Lưu thông tin người dùng và trạng thái hoạt động</td>
</tr>
<tr>
<td><code>roles</code></td>
<td>Định nghĩa các vai trò hệ thống (admin, teacher, ...)</td>
</tr>
<tr>
<td><code>permissions</code></td>
<td>Định nghĩa các quyền chi tiết, gồm <code>condition</code> JSONB</td>
</tr>
<tr>
<td><code>user_role</code></td>
<td>Mapping nhiều-nhiều giữa người dùng và vai trò</td>
</tr>
<tr>
<td><code>role_permission</code></td>
<td>Mapping nhiều-nhiều giữa vai trò và quyền</td>
</tr>
</tbody>
</table>
<h3 id="ghi-chu-thiet-ke">Ghi chú thiết kế:<a class="headerlink" href="#ghi-chu-thiet-ke" title="Permanent link">¶</a></h3>
<ul>
<li><strong>RBAC động:</strong> cột <code>condition</code> trong bảng <code>permissions</code> là kiểu <code>JSONB</code>, cho phép định nghĩa các điều kiện linh hoạt (xem thêm trong <a href="../../../architecture/rbac-deep-dive/#5-permission-có-điều-kiện-condition-jsonb"><code>rbac-deep-dive.md</code></a>)</li>
<li><strong>Tính nhất quán:</strong> các thay đổi liên quan đến phân quyền sẽ phát sự kiện <code>rbac_updated</code>, các thay đổi trạng thái người dùng sẽ phát <code>user_status_changed</code></li>
<li><strong>Mã định danh:</strong> tất cả bảng đều sử dụng UUID (<code>uuid4</code>) làm khóa chính</li>
<li><strong>Truy vết &amp; log:</strong> bảng <code>users</code> có thể mở rộng thêm các cột <code>created_at</code>, <code>updated_at</code>, <code>last_login_at</code> để phục vụ mục đích audit/log</li>
</ul>
<p>📌 Xem chi tiết các cột, chỉ mục, ràng buộc trong <a href="../data-model/"><code>data-model.md</code></a></p>
<hr/>
<h2 id="4-business-logic-flows-luong-nghiep-vu-chinh">4. Business Logic Flows – Luồng nghiệp vụ chính<a class="headerlink" href="#4-business-logic-flows-luong-nghiep-vu-chinh" title="Permanent link">¶</a></h2>
<p>User Service không chỉ lưu trữ thông tin người dùng mà còn là trung tâm điều phối phân quyền động (RBAC) trong toàn bộ hệ thống. Dưới đây là các luồng xử lý nghiệp vụ chính:</p>
<h3 id="41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai">4.1. Đăng nhập thành công → Cập nhật người dùng (auto-create nếu chưa tồn tại)<a class="headerlink" href="#41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Gateway
    participant AuthService
    participant UserService
    Gateway-&gt;&gt;AuthService: Gọi API xác thực (OAuth2 hoặc Local)
    AuthService--&gt;&gt;Gateway: Trả về JWT chứa `user_id`, `email`, `role_hint`
    Gateway-&gt;&gt;UserService: `POST /users/sync-from-token` (kèm info trong token)
    UserService-&gt;&gt;UserService: Kiểm tra `user_id` đã tồn tại?
    alt Chưa tồn tại
        UserService-&gt;&gt;DB: Tạo user mới, trạng thái `active`
    else Đã tồn tại
        UserService-&gt;&gt;DB: Cập nhật `last_login_at`, đồng bộ tên/email nếu thay đổi
    end
    UserService--&gt;&gt;Gateway: OK
</code></pre>
<h3 id="42-cap-nhat-trang-thai-nguoi-dung-active-inactive">4.2. Cập nhật trạng thái người dùng (Active / Inactive)<a class="headerlink" href="#42-cap-nhat-trang-thai-nguoi-dung-active-inactive" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant AdminApp
    participant APIGateway
    participant UserService
    participant DB

    AdminApp-&gt;&gt;APIGateway: PATCH /users/{id}/status (active=false)
    APIGateway-&gt;&gt;UserService: PATCH /users/{id}/status
    UserService-&gt;&gt;DB: UPDATE users SET is_active = false WHERE id = ?
    UserService--&gt;&gt;APIGateway: 200 OK
    APIGateway--&gt;&gt;AdminApp: 200 OK
    Note over UserService: Emit event `user_status_changed`
</code></pre>
<h3 id="43-cap-nhat-rbac-cho-nguoi-dung">4.3. Cập nhật RBAC cho người dùng<a class="headerlink" href="#43-cap-nhat-rbac-cho-nguoi-dung" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant AdminApp
    participant APIGateway
    participant UserService
    participant DB

    AdminApp-&gt;&gt;APIGateway: PATCH /users/{id}/rbac
    APIGateway-&gt;&gt;UserService: PATCH /users/{id}/rbac
    UserService-&gt;&gt;DB: UPDATE user_roles, user_permissions
    UserService--&gt;&gt;APIGateway: 200 OK
    APIGateway--&gt;&gt;AdminApp: 200 OK
    Note over UserService: Emit event `rbac_updated`
</code></pre>
<h3 id="44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis">4.4. Tạo người dùng mới từ hệ thống khác (ví dụ: CRM, SIS)<a class="headerlink" href="#44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Adapter
    participant APIGateway
    participant UserService
    participant DB

    Adapter-&gt;&gt;APIGateway: POST /users
    APIGateway-&gt;&gt;UserService: POST /users
    UserService-&gt;&gt;DB: INSERT INTO users (...)
    UserService--&gt;&gt;APIGateway: 201 Created
    APIGateway--&gt;&gt;Adapter: 201 Created
    Note over UserService: Emit event `user_created`
</code></pre>
<h3 id="45-cap-nhat-phan-quyen-ong">4.5. Cập nhật phân quyền động<a class="headerlink" href="#45-cap-nhat-phan-quyen-ong" title="Permanent link">¶</a></h3>
<ul>
<li>API: <code>PATCH /users/{id}/rbac</code></li>
<li>
<p>Logic:</p>
</li>
<li>
<p>Cập nhật danh sách <code>role_id</code> của user</p>
</li>
<li>Ghi nhận các permission tương ứng thông qua bảng <code>role_permission</code></li>
<li>Phát sự kiện <code>rbac_updated</code> để API Gateway cập nhật cache RBAC nội bộ</li>
</ul>
<h3 id="46-ngung-kich-hoat-tai-khoan-nguoi-dung">4.6. Ngừng kích hoạt tài khoản người dùng<a class="headerlink" href="#46-ngung-kich-hoat-tai-khoan-nguoi-dung" title="Permanent link">¶</a></h3>
<ul>
<li>API: <code>PATCH /users/{id}/status</code></li>
<li>
<p>Logic:</p>
</li>
<li>
<p>Cập nhật <code>is_active = false</code></p>
</li>
<li>Phát sự kiện <code>user_status_changed</code> để các service liên quan thu hồi token/cache</li>
<li>Gateway sẽ từ chối request nếu người dùng bị disable</li>
</ul>
<hr/>
<blockquote>
<p>🔁 Các luồng xử lý này được thiết kế để tuân thủ mô hình event-driven: sau khi cập nhật trạng thái người dùng hoặc phân quyền, User Service sẽ phát sự kiện để các thành phần khác như API Gateway có thể cập nhật cache tương ứng.</p>
</blockquote>
<p>📌 Xem chi tiết các permission và schema RBAC trong <a href="../../../architecture/rbac-deep-dive/"><code>rbac-deep-dive.md</code></a></p>
<hr/>
<h2 id="5-events-cac-su-kien-user-service-phat-ra">5. Events – Các sự kiện User Service phát ra<a class="headerlink" href="#5-events-cac-su-kien-user-service-phat-ra" title="Permanent link">¶</a></h2>
<p>User Service là một trong các Core Service phát sinh sự kiện quan trọng liên quan đến trạng thái người dùng và phân quyền. Tất cả các sự kiện được phát qua Pub/Sub, và dùng để đồng bộ với API Gateway, Notification Service hoặc các service khác.</p>
<h3 id="51-user_created">5.1. <code>user_created</code><a class="headerlink" href="#51-user_created" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Trigger:</strong> Khi một người dùng được khởi tạo thành công qua API hoặc hệ thống tích hợp (CRM/SIS).</li>
<li><strong>Topic:</strong> <code>user.events.user_created</code></li>
<li><strong>Payload:</strong></li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc@example.com"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"role_codes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"parent"</span><span class="p">],</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-01T12:00:00Z"</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> Notification Service (gửi welcome message), API Gateway (preload RBAC cache), CRM adapter (nếu cần sync lại trạng thái người dùng).</li>
</ul>
<hr/>
<h3 id="52-user_status_changed">5.2. <code>user_status_changed</code><a class="headerlink" href="#52-user_status_changed" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Trigger:</strong> Khi trạng thái <code>is_active</code> của người dùng bị thay đổi.</li>
<li><strong>Topic:</strong> <code>user.events.user_status_changed</code></li>
<li><strong>Payload:</strong></li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"is_active"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"updated_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin-uuid"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-02T10:30:00Z"</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> API Gateway (xóa RBAC cache nếu người dùng bị inactive), Notification Service (ngừng gửi thông báo nếu người dùng bị khóa).</li>
</ul>
<hr/>
<h3 id="53-rbac_updated">5.3. <code>rbac_updated</code><a class="headerlink" href="#53-rbac_updated" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Trigger:</strong> Khi role hoặc permission của người dùng thay đổi.</li>
<li><strong>Topic:</strong> <code>user.events.rbac_updated</code></li>
<li><strong>Payload:</strong></li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"teacher"</span><span class="p">],</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">"permissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"VIEW_SCORE_CLASS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EDIT_TIMETABLE"</span><span class="p">],</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">"updated_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin-uuid"</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-02T11:00:00Z"</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> API Gateway (cập nhật lại RBAC cache), Admin Webapp (hiển thị trạng thái phân quyền mới nếu đang mở session).</li>
</ul>
<blockquote>
<p>💡 Tất cả các sự kiện đều đảm bảo <code>idempotency</code> bằng cách bao gồm <code>user_id</code> và <code>timestamp</code>. Các subscriber cần xử lý đúng nguyên tắc đảm bảo trạng thái cuối cùng luôn chính xác.</p>
</blockquote>
<hr/>
<h2 id="6-authorization-security">6. Authorization &amp; Security<a class="headerlink" href="#6-authorization-security" title="Permanent link">¶</a></h2>
<p>User Service là trung tâm phân quyền của toàn hệ thống, đảm nhiệm việc quản lý vai trò (role), quyền (permission), và điều kiện truy cập động (condition-based RBAC).</p>
<hr/>
<h3 id="61-cac-permission-yeu-cau-khi-goi-api-tu-gateway">6.1. Các permission yêu cầu khi gọi API từ Gateway<a class="headerlink" href="#61-cac-permission-yeu-cau-khi-goi-api-tu-gateway" title="Permanent link">¶</a></h3>
<p>Mọi lời gọi đến User Service đều phải thông qua API Gateway, nơi thực hiện xác thực JWT và kiểm tra RBAC động dựa trên các <code>X-Permissions</code> trong token. User Service sẽ <strong>tin tưởng hoàn toàn</strong> các header như <code>X-User-ID</code>, <code>X-Permissions</code> do Gateway truyền xuống, và kiểm tra bổ sung khi cần thực hiện các hành động nhạy cảm (ví dụ: tạo role, phân quyền).</p>
<table>
<thead>
<tr>
<th>API</th>
<th>Permission code yêu cầu tại Gateway</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET /users</td>
<td><code>VIEW_USER_ALL</code></td>
</tr>
<tr>
<td>POST /users</td>
<td><code>CREATE_USER</code></td>
</tr>
<tr>
<td>PATCH /users/{id}</td>
<td><code>UPDATE_USER</code></td>
</tr>
<tr>
<td>PATCH /users/{id}/status</td>
<td><code>UPDATE_USER_STATUS</code></td>
</tr>
<tr>
<td>GET /roles</td>
<td><code>VIEW_ROLE_ALL</code></td>
</tr>
<tr>
<td>POST /roles</td>
<td><code>CREATE_ROLE</code></td>
</tr>
<tr>
<td>PATCH /roles/{id}</td>
<td><code>UPDATE_ROLE</code></td>
</tr>
<tr>
<td>POST /users/{id}/roles</td>
<td><code>ASSIGN_ROLE_TO_USER</code></td>
</tr>
<tr>
<td>DELETE /users/{user_id}/roles/{role_id}</td>
<td><code>REVOKE_ROLE_FROM_USER</code></td>
</tr>
<tr>
<td>GET /permissions</td>
<td><code>VIEW_PERMISSION_ALL</code></td>
</tr>
<tr>
<td>POST /roles/{id}/permissions</td>
<td><code>ASSIGN_PERMISSION_TO_ROLE</code></td>
</tr>
<tr>
<td>DELETE /roles/{role_id}/permissions/{permission_id}</td>
<td><code>REVOKE_PERMISSION_FROM_ROLE</code></td>
</tr>
</tbody>
</table>
<p>📌 Ghi chú:
- Các permission được định nghĩa tĩnh và load vào DB thông qua migration. Không có API cho phép thao tác trực tiếp trên bảng <code>permissions</code>.
- Việc kiểm tra permission diễn ra tại API Gateway theo cơ chế RBAC động đã được mô tả chi tiết trong <code>rbac-deep-dive.md</code>.</p>
<hr/>
<h3 id="62-cach-user-service-anh-gia-phan-quyen">6.2. Cách User Service đánh giá phân quyền<a class="headerlink" href="#62-cach-user-service-anh-gia-phan-quyen" title="Permanent link">¶</a></h3>
<ul>
<li>User Service không đánh giá RBAC trực tiếp cho mỗi request (đã do Gateway làm).</li>
<li>Tuy nhiên, các endpoint quản trị (<code>/permissions</code>, <code>/roles</code>) sẽ có decorator nội bộ kiểm tra <code>X-Permissions</code> header để giới hạn quyền truy cập nhạy cảm.</li>
</ul>
<hr/>
<h3 id="63-kiem-soat-thay-oi-rbac">6.3. Kiểm soát thay đổi RBAC<a class="headerlink" href="#63-kiem-soat-thay-oi-rbac" title="Permanent link">¶</a></h3>
<ul>
<li>Mọi thay đổi role/permission phải được kiểm tra RBAC ở Gateway và log lại tại User Service (audit).</li>
<li>Một số hành động cần "RBAC cấp cao", ví dụ: chỉ <code>rbac:admin</code> mới được cập nhật vai trò giáo viên.</li>
</ul>
<hr/>
<h3 id="64-bao-mat-du-lieu">6.4. Bảo mật dữ liệu<a class="headerlink" href="#64-bao-mat-du-lieu" title="Permanent link">¶</a></h3>
<ul>
<li>Email, password hash, OTP secret đều được lưu trữ mã hóa/băm (tuân thủ ADR-004).</li>
<li>Token không được lưu tại User Service – do Auth Service quản lý.</li>
<li>RBAC cache chỉ được phát tán tới Gateway thông qua Pub/Sub <code>rbac_updated</code>.</li>
</ul>
<hr/>
<h3 id="65-audit-logging">6.5. Audit Logging<a class="headerlink" href="#65-audit-logging" title="Permanent link">¶</a></h3>
<ul>
<li>Mọi hành động ghi thay đổi trạng thái người dùng hoặc RBAC đều ghi vào hệ thống Audit Log.</li>
<li>Ghi nhận:</li>
<li><code>actor_id</code></li>
<li><code>target_user_id</code></li>
<li><code>action</code></li>
<li><code>metadata</code></li>
<li><code>timestamp</code></li>
</ul>
<hr/>
<h2 id="7-configuration-dependencies">7. Configuration &amp; Dependencies<a class="headerlink" href="#7-configuration-dependencies" title="Permanent link">¶</a></h2>
<p>User Service có một số cấu hình môi trường và phụ thuộc cần được khai báo rõ để triển khai đúng và bảo mật.</p>
<hr/>
<h3 id="71-bien-moi-truong-env">7.1. Biến môi trường (<code>.env</code>)<a class="headerlink" href="#71-bien-moi-truong-env" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Biến</th>
<th>Ý nghĩa</th>
<th>Ví dụ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENV</code></td>
<td>Môi trường triển khai</td>
<td><code>production</code>, <code>staging</code>, <code>local</code></td>
</tr>
<tr>
<td><code>SERVICE_NAME</code></td>
<td>Tên service dùng cho logging và header</td>
<td><code>user-service</code></td>
</tr>
<tr>
<td><code>DATABASE_URL</code></td>
<td>Kết nối đến PostgreSQL</td>
<td><code>postgresql+asyncpg://user:pass@host:5432/db</code></td>
</tr>
<tr>
<td><code>REDIS_URL</code></td>
<td>Kết nối đến Redis cache (để load RBAC, status)</td>
<td><code>redis://host:6379/0</code></td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC_RBAC_UPDATED</code></td>
<td>Topic phát sự kiện cập nhật RBAC</td>
<td><code>rbac-updated</code></td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC_USER_STATUS_CHANGED</code></td>
<td>Topic phát sự kiện đổi trạng thái user</td>
<td><code>user-status-changed</code></td>
</tr>
<tr>
<td><code>JWT_PUBLIC_KEY_PATH</code></td>
<td>✅ Dự phòng – Nếu service cần validate một số token nội bộ (không phải JWT người dùng chính), có thể dùng key này. <strong>Thông thường, User Service không cần tự xác thực JWT</strong> vì API Gateway đã làm việc đó.</td>
<td><code>/app/secrets/jwks-public.pem</code></td>
</tr>
<tr>
<td><code>RBAC_CACHE_TTL</code></td>
<td>Thời gian TTL cho RBAC cache Redis</td>
<td><code>900</code> (15 phút)</td>
</tr>
<tr>
<td><code>LOG_LEVEL</code></td>
<td>Mức độ log</td>
<td><code>INFO</code>, <code>DEBUG</code></td>
</tr>
<tr>
<td><code>SENTRY_DSN</code></td>
<td>Endpoint gửi log lỗi (nếu có)</td>
<td><code>https://xxx.ingest.sentry.io/abc</code></td>
</tr>
</tbody>
</table>
<p>📌 Ghi chú:
- Các biến như <code>JWT_PUBLIC_KEY_PATH</code> có thể không cần nếu hệ thống sử dụng hoàn toàn xác thực trung tâm tại API Gateway. Tuy nhiên, vẫn có thể giữ lại để hỗ trợ các cơ chế nội bộ như xác thực mTLS hoặc chữ ký nội bộ giữa service.</p>
<hr/>
<h3 id="72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file">7.2. Secrets (được inject từ Secret Manager hoặc mounted file)<a class="headerlink" href="#72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Secret</th>
<th>Mục đích</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jwt-public-key.pem</code></td>
<td>Được sử dụng để xác thực JWT header từ Gateway</td>
</tr>
<tr>
<td><code>pgpassword</code></td>
<td>Nếu không cấu hình trong URL – lấy từ Secret riêng</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="73-phu-thuoc-dich-vu-noi-bo">7.3. Phụ thuộc dịch vụ nội bộ<a class="headerlink" href="#73-phu-thuoc-dich-vu-noi-bo" title="Permanent link">¶</a></h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>Mục đích</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auth Service (qua Gateway)</td>
<td>Xác thực token, decode metadata</td>
</tr>
<tr>
<td>Notification Service (qua Gateway)</td>
<td>Gửi thông báo khi trạng thái người dùng thay đổi (tùy chọn)</td>
</tr>
<tr>
<td>Audit Logging Service (nếu tách riêng)</td>
<td>Gửi log audit cho các thao tác phân quyền</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="74-quy-uoc-cau-hinh-noi-bo">7.4. Quy ước cấu hình nội bộ<a class="headerlink" href="#74-quy-uoc-cau-hinh-noi-bo" title="Permanent link">¶</a></h3>
<ul>
<li>Toàn bộ config được load qua <code>config.py</code>, phân theo schema chuẩn.</li>
<li>Hỗ trợ cấu hình động (qua JSON config file mount từ GCS hoặc thông qua Firestore, nếu mở rộng sau này).</li>
</ul>
<hr/>
<h2 id="8-testing-strategy">8. Testing Strategy<a class="headerlink" href="#8-testing-strategy" title="Permanent link">¶</a></h2>
<p>User Service là service cốt lõi, nên cần có coverage test tốt ở cả unit test và integration test:</p>
<h3 id="81-unit-test">8.1. Unit Test<a class="headerlink" href="#81-unit-test" title="Permanent link">¶</a></h3>
<ul>
<li>Service methods như <code>get_user_by_id</code>, <code>update_user_status</code>, <code>update_user_rbac</code> nên được test độc lập.</li>
<li>Mọi logic liên quan đến RBAC, sự kiện, và transform schema cần test rõ ràng.</li>
<li>Sử dụng mock cho DB session, repo và Pub/Sub client.</li>
</ul>
<h3 id="82-integration-test">8.2. Integration Test<a class="headerlink" href="#82-integration-test" title="Permanent link">¶</a></h3>
<ul>
<li>Test các API endpoint chính: <code>GET /users</code>, <code>PATCH /users/{id}/status</code>, <code>GET /users/{id}/permissions</code>, v.v.</li>
<li>Dùng DB test riêng biệt và rollback giữa các test.</li>
<li>Kiểm tra logic RBAC ở cả 2 chiều:</li>
<li>Có quyền → được trả về kết quả đúng.</li>
<li>Không có quyền → trả về 403 hoặc error envelope phù hợp.</li>
</ul>
<h3 id="83-pubsub-testing">8.3. Pub/Sub Testing<a class="headerlink" href="#83-pubsub-testing" title="Permanent link">¶</a></h3>
<ul>
<li>Kiểm tra việc publish sự kiện <code>rbac_updated</code>, <code>user_status_changed</code> sau các hành động tương ứng.</li>
<li>Idempotency đảm bảo qua test double-publish và reprocessing.</li>
</ul>
<p>📌 Tham khảo chi tiết <a href="../../../dev/backend-dev-guide/#10-test-đơn-vị--tích-hợp">Backend Dev Guide – Mục 10 (Test)</a></p>
<hr/>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">¶</a></h2>
<ul>
<li>Create <code>data-model.md</code></li>
<li>Complete OpenAPI YAML (ensure sync with implemented handlers)</li>
<li>Review <code>dx-service-template</code> for conformance</li>
<li>Start implementation based on this design</li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trở lại mục lục
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>