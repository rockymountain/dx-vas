
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="T√†i li·ªáu ki·∫øn tr√∫c v√† ph√°t tri·ªÉn cho d·ª± √°n Chuy·ªÉn ƒë·ªïi s·ªë Tr∆∞·ªùng Vi·ªát Anh (dx_vas)." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://dx.truongvietanh.edu.vn/services/user-service/design/" rel="canonical"/>
<link href="../../../dev/ops-guide/" rel="prev"/>
<link href="../interface-contract/" rel="next"/>
<link href="../../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>T·ªïng quan Thi·∫øt k·∫ø - DX VAS - Docs</title>
<link href="../../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#user-service-thiet-ke-chi-tiet">
          B·ªè qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="ƒê·∫ßu trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              T·ªïng quan Thi·∫øt k·∫ø
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="T√¨m ki·∫øm" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="T√¨m ki·∫øm" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="T√¨m ki·∫øm" class="md-search__options">
<button aria-label="Xo√°" class="md-search__icon md-icon" tabindex="-1" title="Xo√°" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem m√£ ngu·ªìn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
          
  
  
    
  
  Ki·∫øn tr√∫c H·ªá th·ªëng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../dev/dev-guide/">
          
  
  
    
  
  H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="./">
          
  
  
    
  
  Thi·∫øt k·∫ø Services

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../ADR/">
          
  
  
    
  
  Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DX VAS - Docs">
<img alt="logo" src="../../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem m√£ ngu·ªìn">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Ki·∫øn tr√∫c H·ªá th·ªëng
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Ki·∫øn tr√∫c H·ªá th·ªëng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/system-diagrams/">
<span class="md-ellipsis">
    S∆° ƒë·ªì H·ªá th·ªëng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi ti·∫øt
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            H∆∞·ªõng d·∫´n Ph√°t tri·ªÉn
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev/dev-guide/">
<span class="md-ellipsis">
    T·ªïng quan Ph√°t tri·ªÉn (Dev Guide)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev/backend-dev-guide/">
<span class="md-ellipsis">
    Backend Dev Guide
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../dev/ops-guide/">
<span class="md-ellipsis">
    V·∫≠n h√†nh &amp; DevOps (Ops Guide)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    Thi·∫øt k·∫ø Services
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Thi·∫øt k·∫ø Services
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="">
<span class="md-ellipsis">
    User Service
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            User Service
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    T·ªïng quan Thi·∫øt k·∫ø
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    T·ªïng quan Thi·∫øt k·∫ø
    
  </span>
</a>
<nav aria-label="M·ª•c l·ª•c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      M·ª•c l·ª•c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-scope-responsibilities">
<span class="md-ellipsis">
      1. Scope &amp; Responsibilities
    </span>
</a>
<nav aria-label="1. Scope &amp; Responsibilities" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#trach-nhiem-chinh">
<span class="md-ellipsis">
      Tr√°ch nhi·ªám ch√≠nh:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#khong-chiu-trach-nhiem">
<span class="md-ellipsis">
      Kh√¥ng ch·ªãu tr√°ch nhi·ªám:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tich-hop">
<span class="md-ellipsis">
      T√≠ch h·ª£p:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-api-specification">
<span class="md-ellipsis">
      2. API Specification
    </span>
</a>
<nav aria-label="2. API Specification" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mo-ta-tong-quan">
<span class="md-ellipsis">
      M√¥ t·∫£ t·ªïng quan:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quy-uoc-tra-ve">
<span class="md-ellipsis">
      Quy ∆∞·ªõc tr·∫£ v·ªÅ:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bao-mat-phan-quyen">
<span class="md-ellipsis">
      B·∫£o m·∫≠t &amp; ph√¢n quy·ªÅn:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-data-model">
<span class="md-ellipsis">
      3. Data Model
    </span>
</a>
<nav aria-label="3. Data Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-quan-cac-bang-chinh">
<span class="md-ellipsis">
      T·ªïng quan c√°c b·∫£ng ch√≠nh:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-thiet-ke">
<span class="md-ellipsis">
      Ghi ch√∫ thi·∫øt k·∫ø:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-business-logic-flows-luong-nghiep-vu-chinh">
<span class="md-ellipsis">
      4. Business Logic Flows ‚Äì Lu·ªìng nghi·ªáp v·ª• ch√≠nh
    </span>
</a>
<nav aria-label="4. Business Logic Flows ‚Äì Lu·ªìng nghi·ªáp v·ª• ch√≠nh" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai">
<span class="md-ellipsis">
      4.1. ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚Üí C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng (auto-create n·∫øu ch∆∞a t·ªìn t·∫°i)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-cap-nhat-trang-thai-nguoi-dung-active-inactive">
<span class="md-ellipsis">
      4.2. C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng (Active / Inactive)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-cap-nhat-rbac-cho-nguoi-dung">
<span class="md-ellipsis">
      4.3. C·∫≠p nh·∫≠t RBAC cho ng∆∞·ªùi d√πng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis">
<span class="md-ellipsis">
      4.4. T·∫°o ng∆∞·ªùi d√πng m·ªõi t·ª´ h·ªá th·ªëng kh√°c (v√≠ d·ª•: CRM, SIS)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#45-cap-nhat-phan-quyen-ong">
<span class="md-ellipsis">
      4.5. C·∫≠p nh·∫≠t ph√¢n quy·ªÅn ƒë·ªông
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#46-ngung-kich-hoat-tai-khoan-nguoi-dung">
<span class="md-ellipsis">
      4.6. Ng·ª´ng k√≠ch ho·∫°t t√†i kho·∫£n ng∆∞·ªùi d√πng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-events-cac-su-kien-user-service-phat-ra">
<span class="md-ellipsis">
      5. Events ‚Äì C√°c s·ª± ki·ªán User Service ph√°t ra
    </span>
</a>
<nav aria-label="5. Events ‚Äì C√°c s·ª± ki·ªán User Service ph√°t ra" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-user_created">
<span class="md-ellipsis">
      5.1. user_created
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-user_status_changed">
<span class="md-ellipsis">
      5.2. user_status_changed
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-rbac_updated">
<span class="md-ellipsis">
      5.3. rbac_updated
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-authorization-security">
<span class="md-ellipsis">
      6. Authorization &amp; Security
    </span>
</a>
<nav aria-label="6. Authorization &amp; Security" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-cac-permission-yeu-cau-khi-goi-api-tu-gateway">
<span class="md-ellipsis">
      6.1. C√°c permission y√™u c·∫ßu khi g·ªçi API t·ª´ Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cach-user-service-anh-gia-phan-quyen">
<span class="md-ellipsis">
      6.2. C√°ch User Service ƒë√°nh gi√° ph√¢n quy·ªÅn
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-kiem-soat-thay-oi-rbac">
<span class="md-ellipsis">
      6.3. Ki·ªÉm so√°t thay ƒë·ªïi RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-bao-mat-du-lieu">
<span class="md-ellipsis">
      6.4. B·∫£o m·∫≠t d·ªØ li·ªáu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-audit-logging">
<span class="md-ellipsis">
      6.5. Audit Logging
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-configuration-dependencies">
<span class="md-ellipsis">
      7. Configuration &amp; Dependencies
    </span>
</a>
<nav aria-label="7. Configuration &amp; Dependencies" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-env">
<span class="md-ellipsis">
      7.1. Bi·∫øn m√¥i tr∆∞·ªùng (.env)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file">
<span class="md-ellipsis">
      7.2. Secrets (ƒë∆∞·ª£c inject t·ª´ Secret Manager ho·∫∑c mounted file)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-phu-thuoc-dich-vu-noi-bo">
<span class="md-ellipsis">
      7.3. Ph·ª• thu·ªôc d·ªãch v·ª• n·ªôi b·ªô
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-quy-uoc-cau-hinh-noi-bo">
<span class="md-ellipsis">
      7.4. Quy ∆∞·ªõc c·∫•u h√¨nh n·ªôi b·ªô
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-testing-strategy">
<span class="md-ellipsis">
      8. Testing Strategy
    </span>
</a>
<nav aria-label="8. Testing Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-test">
<span class="md-ellipsis">
      8.1. Unit Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-test">
<span class="md-ellipsis">
      8.2. Integration Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-pubsub-testing">
<span class="md-ellipsis">
      8.3. Pub/Sub Testing
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      Next Steps
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../interface-contract/">
<span class="md-ellipsis">
    H·ª£p ƒë·ªìng Giao di·ªán
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../data-model/">
<span class="md-ellipsis">
    M√¥ h√¨nh D·ªØ li·ªáu
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../openapi.yaml">
<span class="md-ellipsis">
    ƒê·∫∑c t·∫£ OpenAPI
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../ADR/">
<span class="md-ellipsis">
    Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="M·ª•c l·ª•c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      M·ª•c l·ª•c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-scope-responsibilities">
<span class="md-ellipsis">
      1. Scope &amp; Responsibilities
    </span>
</a>
<nav aria-label="1. Scope &amp; Responsibilities" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#trach-nhiem-chinh">
<span class="md-ellipsis">
      Tr√°ch nhi·ªám ch√≠nh:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#khong-chiu-trach-nhiem">
<span class="md-ellipsis">
      Kh√¥ng ch·ªãu tr√°ch nhi·ªám:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tich-hop">
<span class="md-ellipsis">
      T√≠ch h·ª£p:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-api-specification">
<span class="md-ellipsis">
      2. API Specification
    </span>
</a>
<nav aria-label="2. API Specification" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mo-ta-tong-quan">
<span class="md-ellipsis">
      M√¥ t·∫£ t·ªïng quan:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quy-uoc-tra-ve">
<span class="md-ellipsis">
      Quy ∆∞·ªõc tr·∫£ v·ªÅ:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bao-mat-phan-quyen">
<span class="md-ellipsis">
      B·∫£o m·∫≠t &amp; ph√¢n quy·ªÅn:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-data-model">
<span class="md-ellipsis">
      3. Data Model
    </span>
</a>
<nav aria-label="3. Data Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tong-quan-cac-bang-chinh">
<span class="md-ellipsis">
      T·ªïng quan c√°c b·∫£ng ch√≠nh:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-chu-thiet-ke">
<span class="md-ellipsis">
      Ghi ch√∫ thi·∫øt k·∫ø:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-business-logic-flows-luong-nghiep-vu-chinh">
<span class="md-ellipsis">
      4. Business Logic Flows ‚Äì Lu·ªìng nghi·ªáp v·ª• ch√≠nh
    </span>
</a>
<nav aria-label="4. Business Logic Flows ‚Äì Lu·ªìng nghi·ªáp v·ª• ch√≠nh" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai">
<span class="md-ellipsis">
      4.1. ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚Üí C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng (auto-create n·∫øu ch∆∞a t·ªìn t·∫°i)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#42-cap-nhat-trang-thai-nguoi-dung-active-inactive">
<span class="md-ellipsis">
      4.2. C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng (Active / Inactive)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#43-cap-nhat-rbac-cho-nguoi-dung">
<span class="md-ellipsis">
      4.3. C·∫≠p nh·∫≠t RBAC cho ng∆∞·ªùi d√πng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis">
<span class="md-ellipsis">
      4.4. T·∫°o ng∆∞·ªùi d√πng m·ªõi t·ª´ h·ªá th·ªëng kh√°c (v√≠ d·ª•: CRM, SIS)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#45-cap-nhat-phan-quyen-ong">
<span class="md-ellipsis">
      4.5. C·∫≠p nh·∫≠t ph√¢n quy·ªÅn ƒë·ªông
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#46-ngung-kich-hoat-tai-khoan-nguoi-dung">
<span class="md-ellipsis">
      4.6. Ng·ª´ng k√≠ch ho·∫°t t√†i kho·∫£n ng∆∞·ªùi d√πng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-events-cac-su-kien-user-service-phat-ra">
<span class="md-ellipsis">
      5. Events ‚Äì C√°c s·ª± ki·ªán User Service ph√°t ra
    </span>
</a>
<nav aria-label="5. Events ‚Äì C√°c s·ª± ki·ªán User Service ph√°t ra" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-user_created">
<span class="md-ellipsis">
      5.1. user_created
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-user_status_changed">
<span class="md-ellipsis">
      5.2. user_status_changed
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-rbac_updated">
<span class="md-ellipsis">
      5.3. rbac_updated
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-authorization-security">
<span class="md-ellipsis">
      6. Authorization &amp; Security
    </span>
</a>
<nav aria-label="6. Authorization &amp; Security" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-cac-permission-yeu-cau-khi-goi-api-tu-gateway">
<span class="md-ellipsis">
      6.1. C√°c permission y√™u c·∫ßu khi g·ªçi API t·ª´ Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-cach-user-service-anh-gia-phan-quyen">
<span class="md-ellipsis">
      6.2. C√°ch User Service ƒë√°nh gi√° ph√¢n quy·ªÅn
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-kiem-soat-thay-oi-rbac">
<span class="md-ellipsis">
      6.3. Ki·ªÉm so√°t thay ƒë·ªïi RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-bao-mat-du-lieu">
<span class="md-ellipsis">
      6.4. B·∫£o m·∫≠t d·ªØ li·ªáu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-audit-logging">
<span class="md-ellipsis">
      6.5. Audit Logging
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-configuration-dependencies">
<span class="md-ellipsis">
      7. Configuration &amp; Dependencies
    </span>
</a>
<nav aria-label="7. Configuration &amp; Dependencies" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-bien-moi-truong-env">
<span class="md-ellipsis">
      7.1. Bi·∫øn m√¥i tr∆∞·ªùng (.env)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file">
<span class="md-ellipsis">
      7.2. Secrets (ƒë∆∞·ª£c inject t·ª´ Secret Manager ho·∫∑c mounted file)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-phu-thuoc-dich-vu-noi-bo">
<span class="md-ellipsis">
      7.3. Ph·ª• thu·ªôc d·ªãch v·ª• n·ªôi b·ªô
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#74-quy-uoc-cau-hinh-noi-bo">
<span class="md-ellipsis">
      7.4. Quy ∆∞·ªõc c·∫•u h√¨nh n·ªôi b·ªô
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-testing-strategy">
<span class="md-ellipsis">
      8. Testing Strategy
    </span>
</a>
<nav aria-label="8. Testing Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#81-unit-test">
<span class="md-ellipsis">
      8.1. Unit Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#82-integration-test">
<span class="md-ellipsis">
      8.2. Integration Test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#83-pubsub-testing">
<span class="md-ellipsis">
      8.3. Pub/Sub Testing
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#next-steps">
<span class="md-ellipsis">
      Next Steps
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="user-service-thiet-ke-chi-tiet">User Service ‚Äì Thi·∫øt k·∫ø chi ti·∫øt<a class="headerlink" href="#user-service-thiet-ke-chi-tiet" title="Permanent link">¬∂</a></h1>
<h2 id="1-scope-responsibilities">1. Scope &amp; Responsibilities<a class="headerlink" href="#1-scope-responsibilities" title="Permanent link">¬∂</a></h2>
<p><strong>M√¥ t·∫£ ng·∫Øn:</strong>
User Service l√† service c·ªët l√µi c·ªßa h·ªá th·ªëng dx-vas, ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω th√¥ng tin ƒë·ªãnh danh, tr·∫°ng th√°i v√† ph√¢n quy·ªÅn ng∆∞·ªùi d√πng (RBAC). ƒê√¢y l√† trung t√¢m ph√¢n quy·ªÅn ƒë·ªông (condition-based), l√† n∆°i duy nh·∫•t ghi nh·∫≠n user-role-permission mapping.</p>
<h3 id="trach-nhiem-chinh">Tr√°ch nhi·ªám ch√≠nh:<a class="headerlink" href="#trach-nhiem-chinh" title="Permanent link">¬∂</a></h3>
<ul>
<li>Qu·∫£n l√Ω d·ªØ li·ªáu ƒë·ªãnh danh ng∆∞·ªùi d√πng:</li>
<li><code>user_id</code>, <code>name</code>, <code>email</code>, <code>status</code>, <code>created_at</code>, <code>updated_at</code></li>
<li>Qu·∫£n l√Ω tr·∫°ng th√°i t√†i kho·∫£n: <code>pending</code>, <code>active</code>, <code>inactive</code>, <code>deleted</code></li>
<li>Ph√¢n quy·ªÅn ƒë·ªông (RBAC):</li>
<li>Qu·∫£n l√Ω <code>roles</code>, <code>permissions</code></li>
<li>Mapping user ‚Üí roles ‚Üí permissions (v·ªõi <code>condition</code>)</li>
<li>Cung c·∫•p API cho API Gateway ki·ªÉm tra quy·ªÅn (qua Redis ho·∫∑c API fallback)</li>
<li>Ph√°t s·ª± ki·ªán <code>rbac_updated</code>, <code>user_status_changed</code> ƒë·ªÉ ƒë·ªìng b·ªô RBAC cache t·∫°i Gateway</li>
</ul>
<h3 id="khong-chiu-trach-nhiem">Kh√¥ng ch·ªãu tr√°ch nhi·ªám:<a class="headerlink" href="#khong-chiu-trach-nhiem" title="Permanent link">¬∂</a></h3>
<ul>
<li>ƒêƒÉng nh·∫≠p / x√°c th·ª±c ng∆∞·ªùi d√πng (thu·ªôc Auth Service)</li>
<li>G·ª≠i th√¥ng b√°o (thu·ªôc Notification Service)</li>
<li>Truy xu·∫•t th√¥ng tin h·ªçc sinh / ph·ª• huynh (thu·ªôc SIS)</li>
</ul>
<h3 id="tich-hop">T√≠ch h·ª£p:<a class="headerlink" href="#tich-hop" title="Permanent link">¬∂</a></h3>
<ul>
<li>Redis Cache: ƒë·ªÉ ƒë·∫©y RBAC user snapshot ph·ª•c v·ª• API Gateway</li>
<li>Pub/Sub: ƒë·ªÉ publish c√°c s·ª± ki·ªán <code>user_status_changed</code>, <code>rbac_updated</code></li>
<li>Cloud SQL (PostgreSQL): l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh</li>
</ul>
<hr/>
<h2 id="2-api-specification">2. API Specification<a class="headerlink" href="#2-api-specification" title="Permanent link">¬∂</a></h2>
<p>C√°c API c·ªßa User Service ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a chi ti·∫øt trong file OpenAPI t·∫°i:
üëâ <a href="../../../openapi/user-service/openapi.yaml"><code>openapi.yaml</code></a></p>
<h3 id="mo-ta-tong-quan">M√¥ t·∫£ t·ªïng quan:<a class="headerlink" href="#mo-ta-tong-quan" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>M√¥ t·∫£ ng·∫Øn</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code>/users</code></td>
<td>L·∫•y danh s√°ch ng∆∞·ªùi d√πng, c√≥ ph√¢n trang &amp; l·ªçc</td>
</tr>
<tr>
<td>POST</td>
<td><code>/users</code></td>
<td>T·∫°o ng∆∞·ªùi d√πng m·ªõi (ch·ªâ d√†nh cho Admin Service)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/users/{id}</code></td>
<td>L·∫•y chi ti·∫øt ng∆∞·ªùi d√πng</td>
</tr>
<tr>
<td>PATCH</td>
<td><code>/users/{id}</code></td>
<td>C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng</td>
</tr>
<tr>
<td>PATCH</td>
<td><code>/users/{id}/status</code></td>
<td>C·∫≠p nh·∫≠t tr·∫°ng th√°i ho·∫°t ƒë·ªông (is_active)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/users/{id}/permissions</code></td>
<td>L·∫•y danh s√°ch quy·ªÅn c·ªßa user (g·ªìm condition)</td>
</tr>
<tr>
<td>GET</td>
<td><code>/users/{id}/permissions/raw</code></td>
<td>L·∫•y full RBAC raw (roles, permissions, mapping)</td>
</tr>
</tbody>
</table>
<h3 id="quy-uoc-tra-ve">Quy ∆∞·ªõc tr·∫£ v·ªÅ:<a class="headerlink" href="#quy-uoc-tra-ve" title="Permanent link">¬∂</a></h3>
<ul>
<li>Tu√¢n theo c·∫•u tr√∫c chu·∫©n ƒë√£ m√¥ t·∫£ trong <code>backend-dev-guide.md</code></li>
<li>Lu√¥n b·ªçc k·∫øt qu·∫£ trong <code>DataEnvelope</code>, l·ªói trong <code>ErrorEnvelope</code></li>
<li>M√£ l·ªói ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a th·ªëng nh·∫•t trong h·ªá th·ªëng (4xx, 5xx)</li>
</ul>
<h3 id="bao-mat-phan-quyen">B·∫£o m·∫≠t &amp; ph√¢n quy·ªÅn:<a class="headerlink" href="#bao-mat-phan-quyen" title="Permanent link">¬∂</a></h3>
<ul>
<li>C√°c endpoint y√™u c·∫ßu JWT h·ª£p l·ªá t·ª´ Gateway</li>
<li>M·ªôt s·ªë endpoint y√™u c·∫ßu <code>X-Permissions</code> t∆∞∆°ng ·ª©ng (<code>user:read</code>, <code>user:update</code>, <code>rbac:view</code>, v.v.)</li>
<li>RBAC ƒë∆∞·ª£c ki·ªÉm tra b·ªüi Gateway d·ª±a tr√™n d·ªØ li·ªáu t·ª´ Redis ho·∫∑c fallback qua <code>GET /users/{id}/permissions</code></li>
</ul>
<p>üìå ƒê·ªÉ xem m√¥ t·∫£ t·ªïng quan v·ªÅ c√°c endpoints, m·ª•c ti√™u v√† c√°c quy ∆∞·ªõc giao ti·∫øp c·ªßa User Service, vui l√≤ng tham kh·∫£o t√†i li·ªáu Interface Contract:
üëâ <strong><a href="../interface-contract/">Interface Contract</a></strong></p>
<p>üìå Chi ti·∫øt schema input/output vui l√≤ng xem t·∫°i: <strong><a href="../openapi.yaml"><code>openapi.yaml</code></a></strong></p>
<hr/>
<h2 id="3-data-model">3. Data Model<a class="headerlink" href="#3-data-model" title="Permanent link">¬∂</a></h2>
<p>üìÑ Chi ti·∫øt b·∫£ng CSDL ƒë∆∞·ª£c m√¥ t·∫£ trong <a href="../data-model/"><code>data-model.md</code></a></p>
<h3 id="tong-quan-cac-bang-chinh">T·ªïng quan c√°c b·∫£ng ch√≠nh:<a class="headerlink" href="#tong-quan-cac-bang-chinh" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>B·∫£ng</th>
<th>M√¥ t·∫£ ch·ª©c nƒÉng</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users</code></td>
<td>L∆∞u th√¥ng tin ng∆∞·ªùi d√πng v√† tr·∫°ng th√°i ho·∫°t ƒë·ªông</td>
</tr>
<tr>
<td><code>roles</code></td>
<td>ƒê·ªãnh nghƒ©a c√°c vai tr√≤ h·ªá th·ªëng (admin, teacher, ...)</td>
</tr>
<tr>
<td><code>permissions</code></td>
<td>ƒê·ªãnh nghƒ©a c√°c quy·ªÅn chi ti·∫øt, g·ªìm <code>condition</code> JSONB</td>
</tr>
<tr>
<td><code>user_role</code></td>
<td>Mapping nhi·ªÅu-nhi·ªÅu gi·ªØa ng∆∞·ªùi d√πng v√† vai tr√≤</td>
</tr>
<tr>
<td><code>role_permission</code></td>
<td>Mapping nhi·ªÅu-nhi·ªÅu gi·ªØa vai tr√≤ v√† quy·ªÅn</td>
</tr>
</tbody>
</table>
<h3 id="ghi-chu-thiet-ke">Ghi ch√∫ thi·∫øt k·∫ø:<a class="headerlink" href="#ghi-chu-thiet-ke" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>RBAC ƒë·ªông:</strong> c·ªôt <code>condition</code> trong b·∫£ng <code>permissions</code> l√† ki·ªÉu <code>JSONB</code>, cho ph√©p ƒë·ªãnh nghƒ©a c√°c ƒëi·ªÅu ki·ªán linh ho·∫°t (xem th√™m trong <a href="../../../architecture/rbac-deep-dive/#5-permission-c√≥-ƒëi·ªÅu-ki·ªán-condition-jsonb"><code>rbac-deep-dive.md</code></a>)</li>
<li><strong>T√≠nh nh·∫•t qu√°n:</strong> c√°c thay ƒë·ªïi li√™n quan ƒë·∫øn ph√¢n quy·ªÅn s·∫Ω ph√°t s·ª± ki·ªán <code>rbac_updated</code>, c√°c thay ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng s·∫Ω ph√°t <code>user_status_changed</code></li>
<li><strong>M√£ ƒë·ªãnh danh:</strong> t·∫•t c·∫£ b·∫£ng ƒë·ªÅu s·ª≠ d·ª•ng UUID (<code>uuid4</code>) l√†m kh√≥a ch√≠nh</li>
<li><strong>Truy v·∫øt &amp; log:</strong> b·∫£ng <code>users</code> c√≥ th·ªÉ m·ªü r·ªông th√™m c√°c c·ªôt <code>created_at</code>, <code>updated_at</code>, <code>last_login_at</code> ƒë·ªÉ ph·ª•c v·ª• m·ª•c ƒë√≠ch audit/log</li>
</ul>
<p>üìå Xem chi ti·∫øt c√°c c·ªôt, ch·ªâ m·ª•c, r√†ng bu·ªôc trong <a href="../data-model/"><code>data-model.md</code></a></p>
<hr/>
<h2 id="4-business-logic-flows-luong-nghiep-vu-chinh">4. Business Logic Flows ‚Äì Lu·ªìng nghi·ªáp v·ª• ch√≠nh<a class="headerlink" href="#4-business-logic-flows-luong-nghiep-vu-chinh" title="Permanent link">¬∂</a></h2>
<p>User Service kh√¥ng ch·ªâ l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng m√† c√≤n l√† trung t√¢m ƒëi·ªÅu ph·ªëi ph√¢n quy·ªÅn ƒë·ªông (RBAC) trong to√†n b·ªô h·ªá th·ªëng. D∆∞·ªõi ƒë√¢y l√† c√°c lu·ªìng x·ª≠ l√Ω nghi·ªáp v·ª• ch√≠nh:</p>
<h3 id="41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai">4.1. ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚Üí C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng (auto-create n·∫øu ch∆∞a t·ªìn t·∫°i)<a class="headerlink" href="#41-ang-nhap-thanh-cong-cap-nhat-nguoi-dung-auto-create-neu-chua-ton-tai" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Gateway
    participant AuthService
    participant UserService
    Gateway-&gt;&gt;AuthService: G·ªçi API x√°c th·ª±c (OAuth2 ho·∫∑c Local)
    AuthService--&gt;&gt;Gateway: Tr·∫£ v·ªÅ JWT ch·ª©a `user_id`, `email`, `role_hint`
    Gateway-&gt;&gt;UserService: `POST /users/sync-from-token` (k√®m info trong token)
    UserService-&gt;&gt;UserService: Ki·ªÉm tra `user_id` ƒë√£ t·ªìn t·∫°i?
    alt Ch∆∞a t·ªìn t·∫°i
        UserService-&gt;&gt;DB: T·∫°o user m·ªõi, tr·∫°ng th√°i `active`
    else ƒê√£ t·ªìn t·∫°i
        UserService-&gt;&gt;DB: C·∫≠p nh·∫≠t `last_login_at`, ƒë·ªìng b·ªô t√™n/email n·∫øu thay ƒë·ªïi
    end
    UserService--&gt;&gt;Gateway: OK
</code></pre>
<h3 id="42-cap-nhat-trang-thai-nguoi-dung-active-inactive">4.2. C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng (Active / Inactive)<a class="headerlink" href="#42-cap-nhat-trang-thai-nguoi-dung-active-inactive" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant AdminApp
    participant APIGateway
    participant UserService
    participant DB

    AdminApp-&gt;&gt;APIGateway: PATCH /users/{id}/status (active=false)
    APIGateway-&gt;&gt;UserService: PATCH /users/{id}/status
    UserService-&gt;&gt;DB: UPDATE users SET is_active = false WHERE id = ?
    UserService--&gt;&gt;APIGateway: 200 OK
    APIGateway--&gt;&gt;AdminApp: 200 OK
    Note over UserService: Emit event `user_status_changed`
</code></pre>
<h3 id="43-cap-nhat-rbac-cho-nguoi-dung">4.3. C·∫≠p nh·∫≠t RBAC cho ng∆∞·ªùi d√πng<a class="headerlink" href="#43-cap-nhat-rbac-cho-nguoi-dung" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant AdminApp
    participant APIGateway
    participant UserService
    participant DB

    AdminApp-&gt;&gt;APIGateway: PATCH /users/{id}/rbac
    APIGateway-&gt;&gt;UserService: PATCH /users/{id}/rbac
    UserService-&gt;&gt;DB: UPDATE user_roles, user_permissions
    UserService--&gt;&gt;APIGateway: 200 OK
    APIGateway--&gt;&gt;AdminApp: 200 OK
    Note over UserService: Emit event `rbac_updated`
</code></pre>
<h3 id="44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis">4.4. T·∫°o ng∆∞·ªùi d√πng m·ªõi t·ª´ h·ªá th·ªëng kh√°c (v√≠ d·ª•: CRM, SIS)<a class="headerlink" href="#44-tao-nguoi-dung-moi-tu-he-thong-khac-vi-du-crm-sis" title="Permanent link">¬∂</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant Adapter
    participant APIGateway
    participant UserService
    participant DB

    Adapter-&gt;&gt;APIGateway: POST /users
    APIGateway-&gt;&gt;UserService: POST /users
    UserService-&gt;&gt;DB: INSERT INTO users (...)
    UserService--&gt;&gt;APIGateway: 201 Created
    APIGateway--&gt;&gt;Adapter: 201 Created
    Note over UserService: Emit event `user_created`
</code></pre>
<h3 id="45-cap-nhat-phan-quyen-ong">4.5. C·∫≠p nh·∫≠t ph√¢n quy·ªÅn ƒë·ªông<a class="headerlink" href="#45-cap-nhat-phan-quyen-ong" title="Permanent link">¬∂</a></h3>
<ul>
<li>API: <code>PATCH /users/{id}/rbac</code></li>
<li>
<p>Logic:</p>
</li>
<li>
<p>C·∫≠p nh·∫≠t danh s√°ch <code>role_id</code> c·ªßa user</p>
</li>
<li>Ghi nh·∫≠n c√°c permission t∆∞∆°ng ·ª©ng th√¥ng qua b·∫£ng <code>role_permission</code></li>
<li>Ph√°t s·ª± ki·ªán <code>rbac_updated</code> ƒë·ªÉ API Gateway c·∫≠p nh·∫≠t cache RBAC n·ªôi b·ªô</li>
</ul>
<h3 id="46-ngung-kich-hoat-tai-khoan-nguoi-dung">4.6. Ng·ª´ng k√≠ch ho·∫°t t√†i kho·∫£n ng∆∞·ªùi d√πng<a class="headerlink" href="#46-ngung-kich-hoat-tai-khoan-nguoi-dung" title="Permanent link">¬∂</a></h3>
<ul>
<li>API: <code>PATCH /users/{id}/status</code></li>
<li>
<p>Logic:</p>
</li>
<li>
<p>C·∫≠p nh·∫≠t <code>is_active = false</code></p>
</li>
<li>Ph√°t s·ª± ki·ªán <code>user_status_changed</code> ƒë·ªÉ c√°c service li√™n quan thu h·ªìi token/cache</li>
<li>Gateway s·∫Ω t·ª´ ch·ªëi request n·∫øu ng∆∞·ªùi d√πng b·ªã disable</li>
</ul>
<hr/>
<blockquote>
<p>üîÅ C√°c lu·ªìng x·ª≠ l√Ω n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ tu√¢n th·ªß m√¥ h√¨nh event-driven: sau khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng ho·∫∑c ph√¢n quy·ªÅn, User Service s·∫Ω ph√°t s·ª± ki·ªán ƒë·ªÉ c√°c th√†nh ph·∫ßn kh√°c nh∆∞ API Gateway c√≥ th·ªÉ c·∫≠p nh·∫≠t cache t∆∞∆°ng ·ª©ng.</p>
</blockquote>
<p>üìå Xem chi ti·∫øt c√°c permission v√† schema RBAC trong <a href="../../../architecture/rbac-deep-dive/"><code>rbac-deep-dive.md</code></a></p>
<hr/>
<h2 id="5-events-cac-su-kien-user-service-phat-ra">5. Events ‚Äì C√°c s·ª± ki·ªán User Service ph√°t ra<a class="headerlink" href="#5-events-cac-su-kien-user-service-phat-ra" title="Permanent link">¬∂</a></h2>
<p>User Service l√† m·ªôt trong c√°c Core Service ph√°t sinh s·ª± ki·ªán quan tr·ªçng li√™n quan ƒë·∫øn tr·∫°ng th√°i ng∆∞·ªùi d√πng v√† ph√¢n quy·ªÅn. T·∫•t c·∫£ c√°c s·ª± ki·ªán ƒë∆∞·ª£c ph√°t qua Pub/Sub, v√† d√πng ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi API Gateway, Notification Service ho·∫∑c c√°c service kh√°c.</p>
<h3 id="51-user_created">5.1. <code>user_created</code><a class="headerlink" href="#51-user_created" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Trigger:</strong> Khi m·ªôt ng∆∞·ªùi d√πng ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng qua API ho·∫∑c h·ªá th·ªëng t√≠ch h·ª£p (CRM/SIS).</li>
<li><strong>Topic:</strong> <code>user.events.user_created</code></li>
<li><strong>Payload:</strong></li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc@example.com"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">"role_codes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"parent"</span><span class="p">],</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-01T12:00:00Z"</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> Notification Service (g·ª≠i welcome message), API Gateway (preload RBAC cache), CRM adapter (n·∫øu c·∫ßn sync l·∫°i tr·∫°ng th√°i ng∆∞·ªùi d√πng).</li>
</ul>
<hr/>
<h3 id="52-user_status_changed">5.2. <code>user_status_changed</code><a class="headerlink" href="#52-user_status_changed" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Trigger:</strong> Khi tr·∫°ng th√°i <code>is_active</code> c·ªßa ng∆∞·ªùi d√πng b·ªã thay ƒë·ªïi.</li>
<li><strong>Topic:</strong> <code>user.events.user_status_changed</code></li>
<li><strong>Payload:</strong></li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">"is_active"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">"updated_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin-uuid"</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-02T10:30:00Z"</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> API Gateway (x√≥a RBAC cache n·∫øu ng∆∞·ªùi d√πng b·ªã inactive), Notification Service (ng·ª´ng g·ª≠i th√¥ng b√°o n·∫øu ng∆∞·ªùi d√πng b·ªã kh√≥a).</li>
</ul>
<hr/>
<h3 id="53-rbac_updated">5.3. <code>rbac_updated</code><a class="headerlink" href="#53-rbac_updated" title="Permanent link">¬∂</a></h3>
<ul>
<li><strong>Trigger:</strong> Khi role ho·∫∑c permission c·ªßa ng∆∞·ªùi d√πng thay ƒë·ªïi.</li>
<li><strong>Topic:</strong> <code>user.events.rbac_updated</code></li>
<li><strong>Payload:</strong></li>
</ul>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"uuid"</span><span class="p">,</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nt">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"teacher"</span><span class="p">],</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nt">"permissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"VIEW_SCORE_CLASS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EDIT_TIMETABLE"</span><span class="p">],</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">"updated_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin-uuid"</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-06-02T11:00:00Z"</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li><strong>Consumer:</strong> API Gateway (c·∫≠p nh·∫≠t l·∫°i RBAC cache), Admin Webapp (hi·ªÉn th·ªã tr·∫°ng th√°i ph√¢n quy·ªÅn m·ªõi n·∫øu ƒëang m·ªü session).</li>
</ul>
<blockquote>
<p>üí° T·∫•t c·∫£ c√°c s·ª± ki·ªán ƒë·ªÅu ƒë·∫£m b·∫£o <code>idempotency</code> b·∫±ng c√°ch bao g·ªìm <code>user_id</code> v√† <code>timestamp</code>. C√°c subscriber c·∫ßn x·ª≠ l√Ω ƒë√∫ng nguy√™n t·∫Øc ƒë·∫£m b·∫£o tr·∫°ng th√°i cu·ªëi c√πng lu√¥n ch√≠nh x√°c.</p>
</blockquote>
<hr/>
<h2 id="6-authorization-security">6. Authorization &amp; Security<a class="headerlink" href="#6-authorization-security" title="Permanent link">¬∂</a></h2>
<p>User Service l√† trung t√¢m ph√¢n quy·ªÅn c·ªßa to√†n h·ªá th·ªëng, ƒë·∫£m nhi·ªám vi·ªác qu·∫£n l√Ω vai tr√≤ (role), quy·ªÅn (permission), v√† ƒëi·ªÅu ki·ªán truy c·∫≠p ƒë·ªông (condition-based RBAC).</p>
<hr/>
<h3 id="61-cac-permission-yeu-cau-khi-goi-api-tu-gateway">6.1. C√°c permission y√™u c·∫ßu khi g·ªçi API t·ª´ Gateway<a class="headerlink" href="#61-cac-permission-yeu-cau-khi-goi-api-tu-gateway" title="Permanent link">¬∂</a></h3>
<p>M·ªçi l·ªùi g·ªçi ƒë·∫øn User Service ƒë·ªÅu ph·∫£i th√¥ng qua API Gateway, n∆°i th·ª±c hi·ªán x√°c th·ª±c JWT v√† ki·ªÉm tra RBAC ƒë·ªông d·ª±a tr√™n c√°c <code>X-Permissions</code> trong token. User Service s·∫Ω <strong>tin t∆∞·ªüng ho√†n to√†n</strong> c√°c header nh∆∞ <code>X-User-ID</code>, <code>X-Permissions</code> do Gateway truy·ªÅn xu·ªëng, v√† ki·ªÉm tra b·ªï sung khi c·∫ßn th·ª±c hi·ªán c√°c h√†nh ƒë·ªông nh·∫°y c·∫£m (v√≠ d·ª•: t·∫°o role, ph√¢n quy·ªÅn).</p>
<table>
<thead>
<tr>
<th>API</th>
<th>Permission code y√™u c·∫ßu t·∫°i Gateway</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET /users</td>
<td><code>VIEW_USER_ALL</code></td>
</tr>
<tr>
<td>POST /users</td>
<td><code>CREATE_USER</code></td>
</tr>
<tr>
<td>PATCH /users/{id}</td>
<td><code>UPDATE_USER</code></td>
</tr>
<tr>
<td>PATCH /users/{id}/status</td>
<td><code>UPDATE_USER_STATUS</code></td>
</tr>
<tr>
<td>GET /roles</td>
<td><code>VIEW_ROLE_ALL</code></td>
</tr>
<tr>
<td>POST /roles</td>
<td><code>CREATE_ROLE</code></td>
</tr>
<tr>
<td>PATCH /roles/{id}</td>
<td><code>UPDATE_ROLE</code></td>
</tr>
<tr>
<td>POST /users/{id}/roles</td>
<td><code>ASSIGN_ROLE_TO_USER</code></td>
</tr>
<tr>
<td>DELETE /users/{user_id}/roles/{role_id}</td>
<td><code>REVOKE_ROLE_FROM_USER</code></td>
</tr>
<tr>
<td>GET /permissions</td>
<td><code>VIEW_PERMISSION_ALL</code></td>
</tr>
<tr>
<td>POST /roles/{id}/permissions</td>
<td><code>ASSIGN_PERMISSION_TO_ROLE</code></td>
</tr>
<tr>
<td>DELETE /roles/{role_id}/permissions/{permission_id}</td>
<td><code>REVOKE_PERMISSION_FROM_ROLE</code></td>
</tr>
</tbody>
</table>
<p>üìå Ghi ch√∫:
- C√°c permission ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a tƒ©nh v√† load v√†o DB th√¥ng qua migration. Kh√¥ng c√≥ API cho ph√©p thao t√°c tr·ª±c ti·∫øp tr√™n b·∫£ng <code>permissions</code>.
- Vi·ªác ki·ªÉm tra permission di·ªÖn ra t·∫°i API Gateway theo c∆° ch·∫ø RBAC ƒë·ªông ƒë√£ ƒë∆∞·ª£c m√¥ t·∫£ chi ti·∫øt trong <code>rbac-deep-dive.md</code>.</p>
<hr/>
<h3 id="62-cach-user-service-anh-gia-phan-quyen">6.2. C√°ch User Service ƒë√°nh gi√° ph√¢n quy·ªÅn<a class="headerlink" href="#62-cach-user-service-anh-gia-phan-quyen" title="Permanent link">¬∂</a></h3>
<ul>
<li>User Service kh√¥ng ƒë√°nh gi√° RBAC tr·ª±c ti·∫øp cho m·ªói request (ƒë√£ do Gateway l√†m).</li>
<li>Tuy nhi√™n, c√°c endpoint qu·∫£n tr·ªã (<code>/permissions</code>, <code>/roles</code>) s·∫Ω c√≥ decorator n·ªôi b·ªô ki·ªÉm tra <code>X-Permissions</code> header ƒë·ªÉ gi·ªõi h·∫°n quy·ªÅn truy c·∫≠p nh·∫°y c·∫£m.</li>
</ul>
<hr/>
<h3 id="63-kiem-soat-thay-oi-rbac">6.3. Ki·ªÉm so√°t thay ƒë·ªïi RBAC<a class="headerlink" href="#63-kiem-soat-thay-oi-rbac" title="Permanent link">¬∂</a></h3>
<ul>
<li>M·ªçi thay ƒë·ªïi role/permission ph·∫£i ƒë∆∞·ª£c ki·ªÉm tra RBAC ·ªü Gateway v√† log l·∫°i t·∫°i User Service (audit).</li>
<li>M·ªôt s·ªë h√†nh ƒë·ªông c·∫ßn "RBAC c·∫•p cao", v√≠ d·ª•: ch·ªâ <code>rbac:admin</code> m·ªõi ƒë∆∞·ª£c c·∫≠p nh·∫≠t vai tr√≤ gi√°o vi√™n.</li>
</ul>
<hr/>
<h3 id="64-bao-mat-du-lieu">6.4. B·∫£o m·∫≠t d·ªØ li·ªáu<a class="headerlink" href="#64-bao-mat-du-lieu" title="Permanent link">¬∂</a></h3>
<ul>
<li>Email, password hash, OTP secret ƒë·ªÅu ƒë∆∞·ª£c l∆∞u tr·ªØ m√£ h√≥a/bƒÉm (tu√¢n th·ªß ADR-004).</li>
<li>Token kh√¥ng ƒë∆∞·ª£c l∆∞u t·∫°i User Service ‚Äì do Auth Service qu·∫£n l√Ω.</li>
<li>RBAC cache ch·ªâ ƒë∆∞·ª£c ph√°t t√°n t·ªõi Gateway th√¥ng qua Pub/Sub <code>rbac_updated</code>.</li>
</ul>
<hr/>
<h3 id="65-audit-logging">6.5. Audit Logging<a class="headerlink" href="#65-audit-logging" title="Permanent link">¬∂</a></h3>
<ul>
<li>M·ªçi h√†nh ƒë·ªông ghi thay ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng ho·∫∑c RBAC ƒë·ªÅu ghi v√†o h·ªá th·ªëng Audit Log.</li>
<li>Ghi nh·∫≠n:</li>
<li><code>actor_id</code></li>
<li><code>target_user_id</code></li>
<li><code>action</code></li>
<li><code>metadata</code></li>
<li><code>timestamp</code></li>
</ul>
<hr/>
<h2 id="7-configuration-dependencies">7. Configuration &amp; Dependencies<a class="headerlink" href="#7-configuration-dependencies" title="Permanent link">¬∂</a></h2>
<p>User Service c√≥ m·ªôt s·ªë c·∫•u h√¨nh m√¥i tr∆∞·ªùng v√† ph·ª• thu·ªôc c·∫ßn ƒë∆∞·ª£c khai b√°o r√µ ƒë·ªÉ tri·ªÉn khai ƒë√∫ng v√† b·∫£o m·∫≠t.</p>
<hr/>
<h3 id="71-bien-moi-truong-env">7.1. Bi·∫øn m√¥i tr∆∞·ªùng (<code>.env</code>)<a class="headerlink" href="#71-bien-moi-truong-env" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Bi·∫øn</th>
<th>√ù nghƒ©a</th>
<th>V√≠ d·ª•</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENV</code></td>
<td>M√¥i tr∆∞·ªùng tri·ªÉn khai</td>
<td><code>production</code>, <code>staging</code>, <code>local</code></td>
</tr>
<tr>
<td><code>SERVICE_NAME</code></td>
<td>T√™n service d√πng cho logging v√† header</td>
<td><code>user-service</code></td>
</tr>
<tr>
<td><code>DATABASE_URL</code></td>
<td>K·∫øt n·ªëi ƒë·∫øn PostgreSQL</td>
<td><code>postgresql+asyncpg://user:pass@host:5432/db</code></td>
</tr>
<tr>
<td><code>REDIS_URL</code></td>
<td>K·∫øt n·ªëi ƒë·∫øn Redis cache (ƒë·ªÉ load RBAC, status)</td>
<td><code>redis://host:6379/0</code></td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC_RBAC_UPDATED</code></td>
<td>Topic ph√°t s·ª± ki·ªán c·∫≠p nh·∫≠t RBAC</td>
<td><code>rbac-updated</code></td>
</tr>
<tr>
<td><code>PUBSUB_TOPIC_USER_STATUS_CHANGED</code></td>
<td>Topic ph√°t s·ª± ki·ªán ƒë·ªïi tr·∫°ng th√°i user</td>
<td><code>user-status-changed</code></td>
</tr>
<tr>
<td><code>JWT_PUBLIC_KEY_PATH</code></td>
<td>‚úÖ D·ª± ph√≤ng ‚Äì N·∫øu service c·∫ßn validate m·ªôt s·ªë token n·ªôi b·ªô (kh√¥ng ph·∫£i JWT ng∆∞·ªùi d√πng ch√≠nh), c√≥ th·ªÉ d√πng key n√†y. <strong>Th√¥ng th∆∞·ªùng, User Service kh√¥ng c·∫ßn t·ª± x√°c th·ª±c JWT</strong> v√¨ API Gateway ƒë√£ l√†m vi·ªác ƒë√≥.</td>
<td><code>/app/secrets/jwks-public.pem</code></td>
</tr>
<tr>
<td><code>RBAC_CACHE_TTL</code></td>
<td>Th·ªùi gian TTL cho RBAC cache Redis</td>
<td><code>900</code> (15 ph√∫t)</td>
</tr>
<tr>
<td><code>LOG_LEVEL</code></td>
<td>M·ª©c ƒë·ªô log</td>
<td><code>INFO</code>, <code>DEBUG</code></td>
</tr>
<tr>
<td><code>SENTRY_DSN</code></td>
<td>Endpoint g·ª≠i log l·ªói (n·∫øu c√≥)</td>
<td><code>https://xxx.ingest.sentry.io/abc</code></td>
</tr>
</tbody>
</table>
<p>üìå Ghi ch√∫:
- C√°c bi·∫øn nh∆∞ <code>JWT_PUBLIC_KEY_PATH</code> c√≥ th·ªÉ kh√¥ng c·∫ßn n·∫øu h·ªá th·ªëng s·ª≠ d·ª•ng ho√†n to√†n x√°c th·ª±c trung t√¢m t·∫°i API Gateway. Tuy nhi√™n, v·∫´n c√≥ th·ªÉ gi·ªØ l·∫°i ƒë·ªÉ h·ªó tr·ª£ c√°c c∆° ch·∫ø n·ªôi b·ªô nh∆∞ x√°c th·ª±c mTLS ho·∫∑c ch·ªØ k√Ω n·ªôi b·ªô gi·ªØa service.</p>
<hr/>
<h3 id="72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file">7.2. Secrets (ƒë∆∞·ª£c inject t·ª´ Secret Manager ho·∫∑c mounted file)<a class="headerlink" href="#72-secrets-uoc-inject-tu-secret-manager-hoac-mounted-file" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Secret</th>
<th>M·ª•c ƒë√≠ch</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jwt-public-key.pem</code></td>
<td>ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ x√°c th·ª±c JWT header t·ª´ Gateway</td>
</tr>
<tr>
<td><code>pgpassword</code></td>
<td>N·∫øu kh√¥ng c·∫•u h√¨nh trong URL ‚Äì l·∫•y t·ª´ Secret ri√™ng</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="73-phu-thuoc-dich-vu-noi-bo">7.3. Ph·ª• thu·ªôc d·ªãch v·ª• n·ªôi b·ªô<a class="headerlink" href="#73-phu-thuoc-dich-vu-noi-bo" title="Permanent link">¬∂</a></h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>M·ª•c ƒë√≠ch</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auth Service (qua Gateway)</td>
<td>X√°c th·ª±c token, decode metadata</td>
</tr>
<tr>
<td>Notification Service (qua Gateway)</td>
<td>G·ª≠i th√¥ng b√°o khi tr·∫°ng th√°i ng∆∞·ªùi d√πng thay ƒë·ªïi (t√πy ch·ªçn)</td>
</tr>
<tr>
<td>Audit Logging Service (n·∫øu t√°ch ri√™ng)</td>
<td>G·ª≠i log audit cho c√°c thao t√°c ph√¢n quy·ªÅn</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="74-quy-uoc-cau-hinh-noi-bo">7.4. Quy ∆∞·ªõc c·∫•u h√¨nh n·ªôi b·ªô<a class="headerlink" href="#74-quy-uoc-cau-hinh-noi-bo" title="Permanent link">¬∂</a></h3>
<ul>
<li>To√†n b·ªô config ƒë∆∞·ª£c load qua <code>config.py</code>, ph√¢n theo schema chu·∫©n.</li>
<li>H·ªó tr·ª£ c·∫•u h√¨nh ƒë·ªông (qua JSON config file mount t·ª´ GCS ho·∫∑c th√¥ng qua Firestore, n·∫øu m·ªü r·ªông sau n√†y).</li>
</ul>
<hr/>
<h2 id="8-testing-strategy">8. Testing Strategy<a class="headerlink" href="#8-testing-strategy" title="Permanent link">¬∂</a></h2>
<p>User Service l√† service c·ªët l√µi, n√™n c·∫ßn c√≥ coverage test t·ªët ·ªü c·∫£ unit test v√† integration test:</p>
<h3 id="81-unit-test">8.1. Unit Test<a class="headerlink" href="#81-unit-test" title="Permanent link">¬∂</a></h3>
<ul>
<li>Service methods nh∆∞ <code>get_user_by_id</code>, <code>update_user_status</code>, <code>update_user_rbac</code> n√™n ƒë∆∞·ª£c test ƒë·ªôc l·∫≠p.</li>
<li>M·ªçi logic li√™n quan ƒë·∫øn RBAC, s·ª± ki·ªán, v√† transform schema c·∫ßn test r√µ r√†ng.</li>
<li>S·ª≠ d·ª•ng mock cho DB session, repo v√† Pub/Sub client.</li>
</ul>
<h3 id="82-integration-test">8.2. Integration Test<a class="headerlink" href="#82-integration-test" title="Permanent link">¬∂</a></h3>
<ul>
<li>Test c√°c API endpoint ch√≠nh: <code>GET /users</code>, <code>PATCH /users/{id}/status</code>, <code>GET /users/{id}/permissions</code>, v.v.</li>
<li>D√πng DB test ri√™ng bi·ªát v√† rollback gi·ªØa c√°c test.</li>
<li>Ki·ªÉm tra logic RBAC ·ªü c·∫£ 2 chi·ªÅu:</li>
<li>C√≥ quy·ªÅn ‚Üí ƒë∆∞·ª£c tr·∫£ v·ªÅ k·∫øt qu·∫£ ƒë√∫ng.</li>
<li>Kh√¥ng c√≥ quy·ªÅn ‚Üí tr·∫£ v·ªÅ 403 ho·∫∑c error envelope ph√π h·ª£p.</li>
</ul>
<h3 id="83-pubsub-testing">8.3. Pub/Sub Testing<a class="headerlink" href="#83-pubsub-testing" title="Permanent link">¬∂</a></h3>
<ul>
<li>Ki·ªÉm tra vi·ªác publish s·ª± ki·ªán <code>rbac_updated</code>, <code>user_status_changed</code> sau c√°c h√†nh ƒë·ªông t∆∞∆°ng ·ª©ng.</li>
<li>Idempotency ƒë·∫£m b·∫£o qua test double-publish v√† reprocessing.</li>
</ul>
<p>üìå Tham kh·∫£o chi ti·∫øt <a href="../../../dev/backend-dev-guide/#10-test-ƒë∆°n-v·ªã--t√≠ch-h·ª£p">Backend Dev Guide ‚Äì M·ª•c 10 (Test)</a></p>
<hr/>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">¬∂</a></h2>
<ul>
<li>Create <code>data-model.md</code></li>
<li>Complete OpenAPI YAML (ensure sync with implemented handlers)</li>
<li>Review <code>dx-service-template</code> for conformance</li>
<li>Start implementation based on this design</li>
</ul>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Tr·ªü l·∫°i m·ª•c l·ª•c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>