openapi: 3.0.3
info:
  title: User Service API
  description: API cho quản lý người dùng, vai trò và phân quyền trong hệ thống dx_vas.
  version: 1.0.0
  contact:
    name: DX VAS Platform Team
    email: dev@truongvietanh.edu.vn
servers:
- url: https://user.truongvietanh.edu.vn/api/v1
tags:
- name: User
  description: Các API liên quan đến người dùng, vai trò, phân quyền và audit.
paths:
  /users:
    get:
      tags:
      - User
      summary: Lấy danh sách người dùng
      description: Trả về danh sách người dùng có phân trang và bộ lọc.
      operationId: getUsers
      parameters:
      - name: page
        in: query
        required: false
        schema:
          type: integer
          example: 1
        description: Số trang (bắt đầu từ 1)
      - name: search
        in: query
        required: false
        schema:
          type: string
        description: Tìm theo tên hoặc email
      - name: role
        in: query
        required: false
        schema:
          type: string
        description: Lọc theo role
      - name: status
        in: query
        required: false
        schema:
          type: string
          enum:
          - active
          - inactive
        description: Trạng thái người dùng
      responses:
        '200':
          description: Danh sách người dùng
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Danh sách người dùng
                  value:
                    data:
                    - id: u_123
                      email: alice@example.com
                      role: teacher
                      is_active: true
                    - id: u_456
                      email: bob@example.com
                      role: admin
                      is_active: false
                    error: null
                    meta:
                      timestamp: '2025-07-10T10:00:00Z'
                      trace_id: trace-users-example
                      total_items: 2
                      total_pages: 1
                      current_page: 1
                      per_page: 10
        '400':
          description: Lỗi truy vấn không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_page:
                  summary: Tham số page không hợp lệ
                  value:
                    error:
                      code: INVALID_QUERY_PARAM
                      message: Giá trị 'page' phải là số nguyên dương
                      details:
                        param: page
                    meta:
                      timestamp: '2025-07-10T10:01:00Z'
                      trace_id: trace-invalid-page
                invalid_status:
                  summary: Tham số status không hợp lệ
                  value:
                    error:
                      code: INVALID_QUERY_PARAM
                      message: Giá trị 'status' phải là 'active' hoặc 'inactive'
                      details:
                        param: status
                    meta:
                      timestamp: '2025-07-10T10:02:00Z'
                      trace_id: trace-invalid-status
      security:
      - BearerAuth: []
    post:
      tags:
      - User
      summary: Tạo mới người dùng
      description: Tạo một tài khoản người dùng mới với email và vai trò chỉ định.
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
            examples:
              example:
                summary: Người dùng mới
                value:
                  email: newuser@example.com
                  role: admin
      responses:
        '200':
          description: Tạo người dùng thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UserOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Người dùng đã tạo
                  value:
                    data:
                      id: u_789
                      email: newuser@example.com
                      role: admin
                      is_active: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T10:30:00Z'
                      trace_id: trace-create-user
        '400':
          description: Lỗi khi tạo người dùng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_email:
                  summary: Email không hợp lệ
                  value:
                    error:
                      code: INVALID_INPUT
                      message: Email không hợp lệ hoặc đã tồn tại
                      details:
                        field: email
                    meta:
                      timestamp: '2025-07-10T10:31:00Z'
                      trace_id: trace-invalid-email
        '409':
          description: Email đã tồn tại
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                email_exists:
                  summary: Email đã được sử dụng
                  value:
                    error:
                      code: EMAIL_ALREADY_EXISTS
                      message: Email này đã được đăng ký bởi người dùng khác
                      details:
                        field: email
                    meta:
                      timestamp: '2025-07-10T10:32:00Z'
                      trace_id: trace-email-exists
      security:
      - BearerAuth: []
  /users/{id}:
    get:
      tags:
      - User
      summary: Lấy thông tin người dùng theo ID
      description: Trả về thông tin chi tiết của người dùng với ID tương ứng.
      operationId: getUserById
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: u_123
        description: ID người dùng (UUID)
      responses:
        '200':
          description: Thông tin người dùng
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UserOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Người dùng được tìm thấy
                  value:
                    data:
                      id: u_123
                      email: alice@example.com
                      role: teacher
                      is_active: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T11:00:00Z'
                      trace_id: trace-get-user-by-id
        '404':
          description: Không tìm thấy người dùng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                not_found:
                  summary: Người dùng không tồn tại
                  value:
                    error:
                      code: USER_NOT_FOUND
                      message: Không tìm thấy người dùng với ID đã cho
                      details:
                        id: u_123
                    meta:
                      timestamp: '2025-07-10T11:01:00Z'
                      trace_id: trace-user-not-found
      security:
      - BearerAuth: []
    patch:
      tags:
      - User
      summary: Cập nhật thông tin người dùng
      description: |
        Cập nhật thông tin cơ bản của người dùng như tên và email.
        Người gọi cần có quyền: `UPDATE_USER`.
      operationId: updateUser
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: u_123
        description: ID người dùng cần cập nhật
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
            examples:
              update_email:
                summary: Cập nhật email người dùng
                value:
                  email: updated@example.com
              update_role:
                summary: Cập nhật vai trò người dùng
                value:
                  role: admin
      responses:
        '200':
          description: Cập nhật thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UserOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Người dùng sau khi cập nhật
                  value:
                    data:
                      id: u_123
                      email: updated@example.com
                      role: admin
                      is_active: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T11:02:00Z'
                      trace_id: trace-update-user
        '400':
          description: Dữ liệu cập nhật không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_email_format:
                  summary: Email sai định dạng
                  value:
                    error:
                      code: INVALID_INPUT
                      message: Email không đúng định dạng
                      details:
                        field: email
                    meta:
                      timestamp: '2025-07-10T11:03:00Z'
                      trace_id: trace-invalid-email-format
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /users/{id}/status:
    patch:
      tags:
      - User
      summary: Cập nhật trạng thái hoạt động người dùng
      description: Thay đổi trạng thái hoạt động của người dùng (active hoặc inactive).
      operationId: setUserActiveStatus
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: u_123
        description: ID người dùng cần thay đổi trạng thái
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetActiveRequest'
            examples:
              deactivate:
                summary: Vô hiệu hóa tài khoản
                value:
                  is_active: false
              activate:
                summary: Kích hoạt lại tài khoản
                value:
                  is_active: true
      responses:
        '200':
          description: Thay đổi trạng thái thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UserOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Trạng thái sau cập nhật
                  value:
                    data:
                      id: u_123
                      email: alice@example.com
                      role: teacher
                      is_active: false
                    error: null
                    meta:
                      timestamp: '2025-07-10T11:10:00Z'
                      trace_id: trace-set-user-status
        '400':
          description: Yêu cầu không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                missing_flag:
                  summary: Thiếu trường is_active
                  value:
                    error:
                      code: INVALID_INPUT
                      message: Trường is_active là bắt buộc
                      details:
                        field: is_active
                    meta:
                      timestamp: '2025-07-10T11:11:00Z'
                      trace_id: trace-missing-flag
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /roles:
    get:
      tags:
      - User
      summary: Lấy danh sách vai trò
      description: Trả về danh sách tất cả các vai trò trong hệ thống.
      operationId: getRoles
      responses:
        '200':
          description: Danh sách vai trò
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RoleOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Danh sách vai trò
                  value:
                    data:
                    - id: r_admin
                      name: Administrator
                      permissions:
                      - VIEW_USER_ALL
                      - EDIT_USER
                    - id: r_teacher
                      name: Teacher
                      permissions:
                      - VIEW_USER_OWN
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:00:00Z'
                      trace_id: trace-get-roles
      security:
      - BearerAuth: []
    post:
      tags:
      - User
      summary: Tạo vai trò mới
      description: Tạo một vai trò mới và gán các quyền nếu có.
      operationId: createRole
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleCreate'
            examples:
              example:
                summary: Vai trò mới
                value:
                  name: Librarian
                  permission_codes:
                  - VIEW_USER_ALL
      responses:
        '200':
          description: Vai trò đã tạo
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/RoleOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò đã tạo
                  value:
                    data:
                      id: r_lib
                      name: Librarian
                      permissions:
                      - VIEW_USER_ALL
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:01:00Z'
                      trace_id: trace-create-role
        '400':
          description: Dữ liệu không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                missing_name:
                  summary: Thiếu tên vai trò
                  value:
                    error:
                      code: INVALID_INPUT
                      message: Trường name là bắt buộc
                      details:
                        field: name
                    meta:
                      timestamp: '2025-07-10T12:02:00Z'
                      trace_id: trace-missing-name
      security:
      - BearerAuth: []
  /permissions:
    get:
      tags:
      - User
      summary: Lấy danh sách quyền hệ thống
      description: Trả về tất cả các quyền có thể gán cho người dùng hoặc vai trò
        trong hệ thống.
      operationId: getPermissions
      responses:
        '200':
          description: Danh sách quyền
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PermissionOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Danh sách quyền
                  value:
                    data:
                    - code: VIEW_USER_ALL
                      description: Xem tất cả người dùng
                    - code: EDIT_USER
                      description: Chỉnh sửa thông tin người dùng
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:10:00Z'
                      trace_id: trace-get-permissions
      security:
      - BearerAuth: []
  /roles/{id}:
    get:
      tags:
      - User
      summary: Lấy thông tin chi tiết vai trò
      description: Trả về thông tin chi tiết của một vai trò dựa trên ID.
      operationId: getRoleById
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: r_admin
        description: ID của vai trò cần lấy thông tin
      responses:
        '200':
          description: Thông tin vai trò
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/RoleOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò tìm thấy
                  value:
                    data:
                      id: r_admin
                      name: Administrator
                      permissions:
                      - VIEW_USER_ALL
                      - EDIT_USER
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:20:00Z'
                      trace_id: trace-get-role-id
        '404':
          description: Không tìm thấy vai trò
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                not_found:
                  summary: Vai trò không tồn tại
                  value:
                    error:
                      code: ROLE_NOT_FOUND
                      message: Không tìm thấy vai trò với ID đã cho
                      details:
                        id: r_admin
                    meta:
                      timestamp: '2025-07-10T12:21:00Z'
                      trace_id: trace-role-not-found
      security:
      - BearerAuth: []
    patch:
      tags:
      - User
      summary: Cập nhật vai trò
      description: |
        Cập nhật thông tin tên và mô tả cho vai trò.
        Không dùng để gán/thay đổi permissions (sử dụng endpoint riêng).
        Người gọi cần có quyền: `UPDATE_ROLE`.
      operationId: updateRole
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: r_admin
        description: ID của vai trò cần cập nhật
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleUpdate'
            examples:
              change_name:
                summary: Cập nhật tên vai trò
                value:
                  name: System Administrator
              change_permissions:
                summary: Cập nhật quyền
                value:
                  permission_codes:
                  - VIEW_USER_ALL
                  - EDIT_USER
      responses:
        '200':
          description: Vai trò đã cập nhật
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/RoleOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò sau cập nhật
                  value:
                    data:
                      id: r_admin
                      name: System Administrator
                      permissions:
                      - VIEW_USER_ALL
                      - EDIT_USER
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:22:00Z'
                      trace_id: trace-update-role
        '400':
          description: Dữ liệu không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_field:
                  summary: Tên vai trò không hợp lệ
                  value:
                    error:
                      code: INVALID_INPUT
                      message: Tên vai trò không được để trống
                      details:
                        field: name
                    meta:
                      timestamp: '2025-07-10T12:23:00Z'
                      trace_id: trace-invalid-role
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
    delete:
      tags:
      - User
      summary: Xóa vai trò
      description: Xóa một vai trò khỏi hệ thống.
      operationId: deleteRole
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: r_admin
        description: ID của vai trò cần xóa
      responses:
        '200':
          description: Xóa thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    description: Kết quả xóa
                    properties:
                      deleted:
                        type: boolean
                        example: true
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò đã được xóa
                  value:
                    data:
                      deleted: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:24:00Z'
                      trace_id: trace-delete-role
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /roles/{id}/permissions:
    post:
      tags:
      - User
      summary: Gán quyền cho vai trò
      description: Gán một hoặc nhiều quyền cho vai trò cụ thể.
      operationId: assignPermissionsToRole
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: r_admin
        description: ID của vai trò cần gán quyền
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignPermissionsToRoleRequest'
            examples:
              assign_permissions:
                summary: Gán quyền VIEW_USER_ALL và EDIT_USER
                value:
                  permission_codes:
                  - VIEW_USER_ALL
                  - EDIT_USER
      responses:
        '200':
          description: Vai trò sau khi gán quyền
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/RoleOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò đã được gán quyền
                  value:
                    data:
                      id: r_admin
                      name: Administrator
                      permissions:
                      - VIEW_USER_ALL
                      - EDIT_USER
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:30:00Z'
                      trace_id: trace-role-add-permissions
        '400':
          description: Danh sách quyền không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_permissions:
                  summary: Permission không tồn tại
                  value:
                    error:
                      code: INVALID_PERMISSION_CODE
                      message: Một hoặc nhiều mã quyền không tồn tại
                      details:
                        permission_codes:
                        - INVALID_CODE
                    meta:
                      timestamp: '2025-07-10T12:31:00Z'
                      trace_id: trace-invalid-permission
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /roles/{id}/permissions/{permission_id}:
    delete:
      tags:
      - User
      summary: Thu hồi quyền khỏi vai trò
      description: Xóa một quyền cụ thể khỏi vai trò.
      operationId: revokePermissionFromRole
      parameters:
      - name: id # ID của vai trò
        in: path
        required: true
        schema:
          type: string
          example: r_admin
        description: ID của vai trò cần thu hồi quyền
      - name: permission_id # Đổi tên parameter
        in: path
        required: true
        schema:
          type: string # Giữ là string nếu ID của permission là UUID dạng string
          example: p_001 # Hoặc một UUID ví dụ nếu permission_id là UUID
        description: ID quyền cần thu hồi khỏi vai trò
      responses:
        '200':
          description: Thu hồi quyền thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      removed:
                        type: boolean
                        example: true
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Quyền đã được thu hồi
                  value:
                    data:
                      removed: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:32:00Z'
                      trace_id: trace-remove-permission
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /users/{id}/roles:
    post:
      tags:
      - User
      summary: Gán vai trò cho người dùng
      description: Gán một hoặc nhiều vai trò cho người dùng cụ thể.
      operationId: assignRolesToUser
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: u_123
        description: ID của người dùng
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignRolesToUserRequest'
            examples:
              assign_roles:
                summary: Gán vai trò admin và teacher
                value:
                  role_ids:
                  - r_admin
                  - r_teacher
      responses:
        '200':
          description: Người dùng sau khi gán vai trò
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UserOut'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò đã được gán
                  value:
                    data:
                      id: u_123
                      email: alice@example.com
                      role: admin
                      is_active: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:40:00Z'
                      trace_id: trace-assign-roles
        '400':
          description: ID vai trò không hợp lệ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalid_roles:
                  summary: ID vai trò không tồn tại
                  value:
                    error:
                      code: INVALID_ROLE_ID
                      message: Một hoặc nhiều ID vai trò không hợp lệ
                      details:
                        role_ids:
                        - r_fake
                    meta:
                      timestamp: '2025-07-10T12:41:00Z'
                      trace_id: trace-invalid-role-id
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /users/{id}/roles/{role_id}:
    delete:
      tags:
      - User
      summary: Thu hồi vai trò khỏi người dùng
      description: Thu hồi một vai trò cụ thể khỏi người dùng.
      operationId: removeRoleFromUser
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          example: u_123
        description: ID của người dùng
      - name: role_id
        in: path
        required: true
        schema:
          type: string
          example: r_teacher
        description: ID vai trò cần thu hồi
      responses:
        '200':
          description: Thu hồi vai trò thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      removed:
                        type: boolean
                        example: true
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: Vai trò đã được thu hồi
                  value:
                    data:
                      removed: true
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:42:00Z'
                      trace_id: trace-remove-role-user
        '404':
          description: Không tìm thấy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
      security:
      - BearerAuth: []
  /audit-logs:
    get:
      tags:
      - User
      summary: Lấy danh sách audit log
      description: Truy xuất các hành động ghi nhận audit trên hệ thống với các bộ
        lọc tùy chọn.
      operationId: getAuditLogs
      parameters:
      - name: user_id_actor
        in: query
        schema:
          type: string
        description: Lọc theo ID người thực hiện
      - name: resource_type
        in: query
        schema:
          type: string
        description: Lọc theo loại tài nguyên
      - name: resource_id
        in: query
        schema:
          type: string
        description: Lọc theo ID tài nguyên
      - name: action
        in: query
        schema:
          type: string
        description: Lọc theo tên hành động
      - name: date_from
        in: query
        schema:
          type: string
          format: date
        description: Ngày bắt đầu (YYYY-MM-DD)
      - name: date_to
        in: query
        schema:
          type: string
          format: date
        description: Ngày kết thúc (YYYY-MM-DD)
      - name: page
        in: query
        schema:
          type: integer
        description: Số trang
      - name: limit
        in: query
        schema:
          type: integer
        description: Số bản ghi mỗi trang
      responses:
        '200':
          description: Danh sách audit log
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLogEntry'
                  error:
                    type: object
                    nullable: true
                    description: Trường error sẽ là null khi thành công
                    example: null
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
              examples:
                success:
                  summary: 2 log cập nhật người dùng
                  value:
                    data:
                    - id: log_001
                      user_id_actor: u_123
                      action: UPDATE_USER
                      resource_type: user
                      resource_id: u_456
                      timestamp: '2025-07-10T12:50:00Z'
                      old_value:
                        is_active: false
                      new_value:
                        is_active: true
                      details: {}
                    - id: log_002
                      user_id_actor: u_456
                      action: ASSIGN_ROLE
                      resource_type: user
                      resource_id: u_789
                      timestamp: '2025-07-10T12:51:00Z'
                      details:
                        role_id: r_teacher
                    error: null
                    meta:
                      timestamp: '2025-07-10T12:52:00Z'
                      trace_id: trace-audit-logs
                      total_items: 2
                      total_pages: 1
                      current_page: 1
                      per_page: 10
      security:
      - BearerAuth: []
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    ErrorResponse:
      description: Lỗi xảy ra trong quá trình xử lý
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
  schemas:
    ErrorEnvelope:
      type: object
      properties:
        error:
          type: object
          required:
          - code
          - message
          properties:
            code:
              type: string
              example: GENERIC_ERROR
            message:
              type: string
              example: Đã có lỗi xảy ra.
            details:
              type: object
              additionalProperties: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    ResponseMeta:
      type: object
      required:
      - timestamp
      - trace_id
      properties:
        timestamp:
          type: string
          format: date-time
          description: Thời điểm phản hồi
        trace_id:
          type: string
          description: Mã trace ID để liên kết log/tracing
        total_items:
          type: integer
          description: Tổng số bản ghi
        total_pages:
          type: integer
          description: Tổng số trang
        current_page:
          type: integer
          description: Trang hiện tại
        per_page:
          type: integer
          description: Số bản ghi mỗi trang
    StandardSuccessResponse_Example:
      type: object
      properties:
        data:
          type: object
          properties:
            example_field:
              type: string
              example: example value
        error:
          type: object
          nullable: true
          description: Trường error sẽ là null khi thành công
          example: null
        meta:
          $ref: '#/components/schemas/ResponseMeta'
      description: Cấu trúc phản hồi thành công chuẩn theo ADR-012.
    UserOut:
      type: object
      properties:
        id:
          type: string
          example: u_123
          description: ID nội bộ của người dùng (UUID)
        email:
          type: string
          format: email
          description: Địa chỉ email đăng nhập của người dùng
        name:
          type: string
        roles: # Đổi tên từ role sang roles
          type: array
          items:
            type: string # Hoặc $ref: '#/components/schemas/RoleSimpleOut'
          example: ["teacher", "editor"]
          description: Danh sách các vai trò của người dùng
        is_active:
          type: boolean
          example: true
          description: Trạng thái hoạt động của tài khoản người dùng
      required:
      - id
      - email
      - roles
      - is_active
    UserCreate:
      type: object
      required: [email, name]
      properties:
        email:
          type: string
          example: newuser@example.com
          description: Email của người dùng mới
        name:
          type: string
        roles:
          type: array
          items:
            type: string # Hoặc $ref: '#/components/schemas/RoleSimpleCreate'
          example: ["teacher", "editor"]
          description: Các vai trò ban đầu của người dùng
    UserUpdate:
      type: object
      properties:
        name: # Thêm trường name
          type: string
          description: Tên mới của người dùng (nếu thay đổi)
          example: "Alice Updated"
        email:
          type: string
          description: Email mới của người dùng (nếu thay đổi)
    SetActiveRequest:
      type: object
      properties:
        is_active:
          type: boolean
          example: true
          description: 'Trạng thái hoạt động: true = kích hoạt, false = vô hiệu hóa'
      required:
      - is_active
    RoleOut:
      type: object
      properties:
        id:
          type: string
          description: ID của vai trò (UUID)
          example: r_admin
        name:
          type: string
          description: Tên hiển thị của vai trò
          example: Administrator
        permissions:
          type: array
          description: Danh sách quyền gán cho vai trò
          items:
            type: string
            example: VIEW_USER_ALL
      required:
      - id
      - name
      - permissions
    RoleCreate:
      type: object
      properties:
        name:
          type: string
          description: Tên vai trò mới
          example: Support Staff
        permission_codes:
          type: array
          description: Mã quyền sẽ gán cho vai trò mới
          items:
            type: string
            example: VIEW_USER_ALL
      required:
      - name
    PermissionOut:
      type: object
      properties:
        code:
          type: string
          description: Mã quyền duy nhất trong hệ thống
          example: VIEW_USER_ALL
        description:
          type: string
          description: Mô tả quyền
          example: Xem tất cả người dùng
      required:
      - code
      - description
    RoleUpdate:
      type: object
      properties:
        name:
          type: string
          description: Tên mới của vai trò (nếu thay đổi)
          example: System Administrator
        description: # Thêm trường description nếu có
          type: string
          description: Mô tả mới cho vai trò
    AssignPermissionsToRoleRequest:
      type: object
      properties:
        permission_codes:
          type: array
          description: Danh sách mã quyền cần gán cho vai trò
          items:
            type: string
            example: VIEW_USER_ALL
      required:
      - permission_codes
    AssignRolesToUserRequest:
      type: object
      properties:
        role_ids:
          type: array
          description: Danh sách ID vai trò cần gán cho người dùng
          items:
            type: string
            example: r_admin
      required:
      - role_ids
    AuditLogEntry:
      type: object
      properties:
        id:
          type: string
          description: ID bản ghi audit log
          example: log_001
        user_id_actor:
          type: string
          description: ID người thực hiện hành động
          example: u_123
        action:
          type: string
          description: Tên hành động được ghi nhận
          example: UPDATE_USER
        resource_type:
          type: string
          description: Loại tài nguyên bị tác động
          example: user
        resource_id:
          type: string
          description: ID của tài nguyên bị tác động
          example: u_456
        timestamp:
          type: string
          format: date-time
          description: Thời điểm hành động diễn ra
          example: '2025-07-10T12:50:00Z'
        old_value:
          type: object
          description: Giá trị cũ của tài nguyên (nếu có)
        new_value:
          type: object
          description: Giá trị mới của tài nguyên (nếu có)
        details:
          type: object
          description: Thông tin chi tiết bổ sung (nếu có)
      required:
      - id
      - user_id_actor
      - action
      - resource_type
      - resource_id
      - timestamp
