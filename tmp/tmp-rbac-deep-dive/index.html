
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh (dx_vas)." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://dx.truongvietanh.edu.vn/tmp/tmp-rbac-deep-dive/" rel="canonical"/>
<link href="../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>PhÃ¢n tÃ­ch ChuyÃªn sÃ¢u: Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC) trong Há»‡ thá»‘ng dx-vas - DX VAS - Docs</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#phan-tich-chuyen-sau-kien-truc-phan-quyen-ong-rbac-trong-he-thong-dx-vas">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              PhÃ¢n tÃ­ch ChuyÃªn sÃ¢u: Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC) trong Há»‡ thá»‘ng dx-vas
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../dev/dev-guide/">
          
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../services/user-service/design/">
          
  
  
    
  
  Thiáº¿t káº¿ Services

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev/dev-guide/">
<span class="md-ellipsis">
    Tá»•ng quan PhÃ¡t triá»ƒn (Dev Guide)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev/backend-dev-guide/">
<span class="md-ellipsis">
    Backend Dev Guide
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev/ops-guide/">
<span class="md-ellipsis">
    Váº­n hÃ nh &amp; DevOps (Ops Guide)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Thiáº¿t káº¿ Services
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
<span class="md-ellipsis">
    User Service
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            User Service
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/design/">
<span class="md-ellipsis">
    Tá»•ng quan Thiáº¿t káº¿
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/interface-contract/">
<span class="md-ellipsis">
    Há»£p Ä‘á»“ng Giao diá»‡n
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/data-model/">
<span class="md-ellipsis">
    MÃ´ hÃ¬nh Dá»¯ liá»‡u
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/openapi.yaml">
<span class="md-ellipsis">
    Äáº·c táº£ OpenAPI
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-tong-quan-inh-nghia-rbac">
<span class="md-ellipsis">
      1. Tá»•ng quan &amp; Äá»‹nh nghÄ©a RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-phan-tang-quan-ly-inh-danh-phan-quyen">
<span class="md-ellipsis">
      2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n
    </span>
</a>
<nav aria-label="2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#user-service-master">
<span class="md-ellipsis">
      ğŸ§  User Service Master
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sub-user-service-per-tenant">
<span class="md-ellipsis">
      ğŸ§© Sub User Service (per Tenant)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-luong-xac-thuc-phan-quyen-multi-tenant">
<span class="md-ellipsis">
      3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)
    </span>
</a>
<nav aria-label="3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#luong-phat-hanh-jwt">
<span class="md-ellipsis">
      ğŸ” Luá»“ng phÃ¡t hÃ nh JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#api-gateway-anh-gia-rbac">
<span class="md-ellipsis">
      ğŸ›¡ï¸ API Gateway Ä‘Ã¡nh giÃ¡ RBAC
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-mo-hinh-du-lieu-rbac-master-vs-sub">
<span class="md-ellipsis">
      4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)
    </span>
</a>
<nav aria-label="4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-user-service-master">
<span class="md-ellipsis">
      ğŸ“¦ Táº¡i User Service Master
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-sub-user-service-moi-tenant">
<span class="md-ellipsis">
      ğŸ“¦ Táº¡i Sub User Service (má»—i tenant)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-permission-co-ieu-kien-condition-jsonb">
<span class="md-ellipsis">
      5. Permission cÃ³ Ä‘iá»u kiá»‡n (Condition JSONB)
    </span>
</a>
<nav aria-label="5. Permission cÃ³ Ä‘iá»u kiá»‡n (Condition JSONB)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vi-du-ve-permission-co-ieu-kien">
<span class="md-ellipsis">
      ğŸ“Œ VÃ­ dá»¥ vá» permission cÃ³ Ä‘iá»u kiá»‡n:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#context-ho-tro-khi-evaluate">
<span class="md-ellipsis">
      ğŸ›  Context há»— trá»£ khi evaluate:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#anh-gia-ieu-kien">
<span class="md-ellipsis">
      ğŸ§  ÄÃ¡nh giÃ¡ Ä‘iá»u kiá»‡n:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-chien-luoc-cache-rbac-tai-api-gateway">
<span class="md-ellipsis">
      6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway
    </span>
</a>
<nav aria-label="6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#key-cache">
<span class="md-ellipsis">
      ğŸ”‘ Key cache:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#value-cache">
<span class="md-ellipsis">
      ğŸ“¦ Value cache:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ttl-lam-moi">
<span class="md-ellipsis">
      â± TTL &amp; LÃ m má»›i:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#invalidation-qua-pubsub">
<span class="md-ellipsis">
      ğŸ” Invalidation qua Pub/Sub:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-chien-luoc-ong-bo-rbac">
<span class="md-ellipsis">
      7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC
    </span>
</a>
<nav aria-label="7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ke-thua-tuy-chinh">
<span class="md-ellipsis">
      ğŸ“š Káº¿ thá»«a &amp; tÃ¹y chá»‰nh:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gan-role-cho-nguoi-dung">
<span class="md-ellipsis">
      ğŸ§© GÃ¡n role cho ngÆ°á»i dÃ¹ng:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ong-bo-inh-ky-tuy-chon">
<span class="md-ellipsis">
      ğŸ” Äá»“ng bá»™ Ä‘á»‹nh ká»³ (tÃ¹y chá»n):
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-hieu-nang-kha-nang-mo-rong">
<span class="md-ellipsis">
      8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng
    </span>
</a>
<nav aria-label="8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ky-thuat-toi-uu">
<span class="md-ellipsis">
      ğŸ”§ Ká»¹ thuáº­t tá»‘i Æ°u:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cloud-scale">
<span class="md-ellipsis">
      â˜ï¸ Cloud Scale:
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring">
<span class="md-ellipsis">
      ğŸ” Monitoring:
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-bao-mat-chuyen-sau-trong-rbac">
<span class="md-ellipsis">
      9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC
    </span>
</a>
<nav aria-label="9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#isolation-theo-tenant">
<span class="md-ellipsis">
      ğŸ” Isolation theo Tenant
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-inh-danh-va-khong-gian-rbac">
<span class="md-ellipsis">
      ğŸ” TÃªn Ä‘á»‹nh danh vÃ  khÃ´ng gian RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#chong-gia-mao-jwt">
<span class="md-ellipsis">
      ğŸ” Chá»‘ng giáº£ máº¡o JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#api-rbac-luon-bao-ve-boi-auth-role">
<span class="md-ellipsis">
      ğŸ” API RBAC luÃ´n báº£o vá»‡ bá»Ÿi Auth + Role
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-giam-sat-go-loi">
<span class="md-ellipsis">
      10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i
    </span>
</a>
<nav aria-label="10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#audit-trail">
<span class="md-ellipsis">
      ğŸªµ Audit Trail
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#debug-flow-tai-gateway">
<span class="md-ellipsis">
      ğŸ§ª Debug Flow táº¡i Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#metrics">
<span class="md-ellipsis">
      ğŸ“ˆ Metrics
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-best-practices-cho-quan-tri-rbac">
<span class="md-ellipsis">
      11. Best Practices cho Quáº£n trá»‹ RBAC
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-cong-cu-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan
    </span>
</a>
<nav aria-label="12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-rbac-phan-tang-user-master-va-sub-user-services">
<span class="md-ellipsis">
      ğŸ” SÆ¡ Ä‘á»“ RBAC PhÃ¢n táº§ng â€“ User Master vÃ  Sub User Services
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-luong-kiem-tra-rbac-tai-api-gateway">
<span class="md-ellipsis">
      ğŸ” SÆ¡ Ä‘á»“ Luá»“ng Kiá»ƒm tra RBAC táº¡i API Gateway
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-luong-phat-hanh-jwt-a-tenant">
<span class="md-ellipsis">
      ğŸ”‘ SÆ¡ Ä‘á»“ Luá»“ng PhÃ¡t hÃ nh JWT Äa-Tenant
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="phan-tich-chuyen-sau-kien-truc-phan-quyen-ong-rbac-trong-he-thong-dx-vas">PhÃ¢n tÃ­ch ChuyÃªn sÃ¢u: Kiáº¿n trÃºc PhÃ¢n quyá»n Äá»™ng (RBAC) trong Há»‡ thá»‘ng dx-vas<a class="headerlink" href="#phan-tich-chuyen-sau-kien-truc-phan-quyen-ong-rbac-trong-he-thong-dx-vas" title="Permanent link">Â¶</a></h1>
<h2 id="1-tong-quan-inh-nghia-rbac">1. Tá»•ng quan &amp; Äá»‹nh nghÄ©a RBAC<a class="headerlink" href="#1-tong-quan-inh-nghia-rbac" title="Permanent link">Â¶</a></h2>
<p>RBAC (Role-Based Access Control) trong há»‡ thá»‘ng dx-vas cho phÃ©p kiá»ƒm soÃ¡t quyá»n truy cáº­p má»™t cÃ¡ch linh hoáº¡t vÃ  cÃ³ thá»ƒ má»Ÿ rá»™ng, dá»±a trÃªn:</p>
<ul>
<li><strong>Vai trÃ² ngÆ°á»i dÃ¹ng</strong> (Role) trong tá»«ng trÆ°á»ng thÃ nh viÃªn (tenant)</li>
<li><strong>Táº­p há»£p quyá»n</strong> (Permission) Ä‘Æ°á»£c gÃ¡n cho má»—i role</li>
<li><strong>Äiá»u kiá»‡n thá»±c thi</strong> (Condition, náº¿u cÃ³) Ã¡p dá»¥ng á»Ÿ cáº¥p permission</li>
</ul>
<p>MÃ´ hÃ¬nh RBAC nÃ y hoáº¡t Ä‘á»™ng trong bá»‘i cáº£nh <strong>multi-tenant</strong>, nÆ¡i má»—i tenant (trÆ°á»ng thÃ nh viÃªn) cÃ³ <strong>RBAC Ä‘á»™c láº­p</strong>, nhÆ°ng váº«n káº¿ thá»«a má»™t pháº§n tá»« <strong>template toÃ n há»‡ thá»‘ng</strong> do User Service Master cung cáº¥p.</p>
<hr/>
<h2 id="2-phan-tang-quan-ly-inh-danh-phan-quyen">2. PhÃ¢n táº§ng Quáº£n lÃ½ Äá»‹nh danh &amp; PhÃ¢n quyá»n<a class="headerlink" href="#2-phan-tang-quan-ly-inh-danh-phan-quyen" title="Permanent link">Â¶</a></h2>
<h3 id="user-service-master">ğŸ§  User Service Master<a class="headerlink" href="#user-service-master" title="Permanent link">Â¶</a></h3>
<ul>
<li>LÃ  nguá»“n chÃ¢n lÃ½ duy nháº¥t cho toÃ n bá»™ ngÆ°á»i dÃ¹ng (<code>users_global</code>)</li>
<li>Quáº£n lÃ½:</li>
<li>Danh sÃ¡ch tenant (<code>tenants</code>)</li>
<li>Má»‘i quan há»‡ user â†” tenant (<code>user_tenant_assignments</code>)</li>
<li>CÃ¡c template vai trÃ² vÃ  quyá»n toÃ n há»‡ thá»‘ng:<ul>
<li><code>global_roles_templates</code></li>
<li><code>global_permissions_templates</code></li>
</ul>
</li>
<li>KhÃ´ng trá»±c tiáº¿p Ä‘Ã¡nh giÃ¡ RBAC, mÃ  cung cáº¥p Ä‘á»‹nh danh vÃ  template cho Sub Services</li>
</ul>
<h3 id="sub-user-service-per-tenant">ğŸ§© Sub User Service (per Tenant)<a class="headerlink" href="#sub-user-service-per-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i tenant cÃ³ 1 instance riÃªng, quáº£n lÃ½:</li>
<li>NgÆ°á»i dÃ¹ng thuá»™c tenant (<code>users_in_tenant</code>) â€“ Ã¡nh xáº¡ Ä‘áº¿n <code>user_id_global</code></li>
<li>Tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng ná»™i bá»™: <code>is_active_in_tenant</code></li>
<li>Vai trÃ² (<code>roles_in_tenant</code>), quyá»n (<code>permissions_in_tenant</code>)</li>
<li>Mapping:<ul>
<li><code>user_role_in_tenant</code></li>
<li><code>role_permission_in_tenant</code></li>
</ul>
</li>
<li>Cho phÃ©p káº¿ thá»«a tá»« template Master hoáº·c tá»± Ä‘á»‹nh nghÄ©a</li>
</ul>
<hr/>
<h2 id="3-luong-xac-thuc-phan-quyen-multi-tenant">3. Luá»“ng XÃ¡c thá»±c &amp; PhÃ¢n quyá»n (Multi-Tenant)<a class="headerlink" href="#3-luong-xac-thuc-phan-quyen-multi-tenant" title="Permanent link">Â¶</a></h2>
<h3 id="luong-phat-hanh-jwt">ğŸ” Luá»“ng phÃ¡t hÃ nh JWT<a class="headerlink" href="#luong-phat-hanh-jwt" title="Permanent link">Â¶</a></h3>
<ol>
<li>NgÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p qua:</li>
<li>Google OAuth2 â†’ Auth Master</li>
<li>OTP/Local â†’ Sub Auth Service</li>
<li>Sau khi xÃ¡c thá»±c:</li>
<li><code>tenant_id</code> Ä‘Æ°á»£c chá»n (náº¿u ngÆ°á»i dÃ¹ng thuá»™c nhiá»u tenant)</li>
<li>Auth Service gá»i User Service Master â†’ kiá»ƒm tra <code>user_id_global</code> + quyá»n truy cáº­p tenant</li>
<li>Gá»i Sub User Service â†’ láº¥y <code>roles</code>, <code>permissions</code></li>
<li>JWT Ä‘Æ°á»£c phÃ¡t hÃ nh vá»›i:</li>
<li><code>user_id</code>, <code>tenant_id</code>, <code>roles</code>, <code>permissions</code>, <code>auth_provider</code></li>
</ol>
<h3 id="api-gateway-anh-gia-rbac">ğŸ›¡ï¸ API Gateway Ä‘Ã¡nh giÃ¡ RBAC<a class="headerlink" href="#api-gateway-anh-gia-rbac" title="Permanent link">Â¶</a></h3>
<ul>
<li>TrÃ­ch xuáº¥t <code>tenant_id</code> tá»« JWT</li>
<li>Kiá»ƒm tra <code>is_active</code> + <code>is_active_in_tenant</code></li>
<li>Truy váº¥n Redis cache: <code>rbac:{user_id}:{tenant_id}</code></li>
<li>Náº¿u khÃ´ng cÃ³ cache, gá»i Sub User Service Ä‘á»ƒ load láº¡i RBAC</li>
<li>ÄÃ¡nh giÃ¡ <code>condition</code> náº¿u permission cÃ³ rÃ ng buá»™c Ä‘á»™ng</li>
</ul>
<hr/>
<h2 id="4-mo-hinh-du-lieu-rbac-master-vs-sub">4. MÃ´ hÃ¬nh Dá»¯ liá»‡u RBAC (Master vs Sub)<a class="headerlink" href="#4-mo-hinh-du-lieu-rbac-master-vs-sub" title="Permanent link">Â¶</a></h2>
<h3 id="tai-user-service-master">ğŸ“¦ Táº¡i User Service Master<a class="headerlink" href="#tai-user-service-master" title="Permanent link">Â¶</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">-- Danh sÃ¡ch ngÆ°á»i dÃ¹ng toÃ n há»‡ thá»‘ng</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users_global</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="n">full_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="n">phone</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="n">auth_provider</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">auth_provider</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'google'</span><span class="p">,</span><span class="w"> </span><span class="s1">'local'</span><span class="p">)),</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="n">local_auth_tenant_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="n">is_active</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">);</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="c1">-- Danh sÃ¡ch tenant</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tenants</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">  </span><span class="n">tenant_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span><span class="w"> </span><span class="s1">'inactive'</span><span class="p">))</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="p">);</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="c1">-- GÃ¡n user vÃ o tenant</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_tenant_assignments</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users_global</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">  </span><span class="n">tenant_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">tenants</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">),</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="n">assigned_by</span><span class="w"> </span><span class="n">UUID</span><span class="p">,</span>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">  </span><span class="n">assigned_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">tenant_id</span><span class="p">)</span>
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">);</span>
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="c1">-- Template vai trÃ² vÃ  quyá»n toÃ n há»‡ thá»‘ng</span>
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">global_roles_templates</span><span class="w"> </span><span class="p">(...);</span>
</span><span id="__span-0-30"><a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">global_permissions_templates</span><span class="w"> </span><span class="p">(...);</span>
</span></code></pre></div>
<h3 id="tai-sub-user-service-moi-tenant">ğŸ“¦ Táº¡i Sub User Service (má»—i tenant)<a class="headerlink" href="#tai-sub-user-service-moi-tenant" title="Permanent link">Â¶</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">-- NgÆ°á»i dÃ¹ng ná»™i bá»™ tenant (tham chiáº¿u user toÃ n cá»¥c)</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">users_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="n">user_id_global</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users_global</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="n">is_active_in_tenant</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">TRUE</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">);</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="c1">-- Vai trÃ² vÃ  quyá»n cá»§a tenant</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">roles_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="n">role_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="n">role_code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="n">role_name</span><span class="w"> </span><span class="nb">TEXT</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="p">);</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">permissions_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="n">permission_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="n">permission_code</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="n">action</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="n">resource</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">  </span><span class="n">condition</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="c1">-- chá»©a rÃ ng buá»™c nhÆ° { "class_id": "$user.class_id" }</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="p">);</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="c1">-- Mapping vai trÃ² â†” ngÆ°á»i dÃ¹ng</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">user_role_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">  </span><span class="n">user_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">users_in_tenant</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">  </span><span class="n">role_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">roles_in_tenant</span><span class="p">(</span><span class="n">role_id</span><span class="p">),</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">role_id</span><span class="p">)</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="p">);</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="c1">-- Mapping quyá»n â†” vai trÃ²</span>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">role_permission_in_tenant</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">  </span><span class="n">role_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">roles_in_tenant</span><span class="p">(</span><span class="n">role_id</span><span class="p">),</span>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">  </span><span class="n">permission_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">permissions_in_tenant</span><span class="p">(</span><span class="n">permission_id</span><span class="p">),</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span><span class="w"> </span><span class="n">permission_id</span><span class="p">)</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="p">);</span>
</span></code></pre></div>
<p>ğŸ“˜ ToÃ n bá»™ mÃ´ hÃ¬nh dá»¯ liá»‡u Ä‘áº§y Ä‘á»§ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong:</p>
<ul>
<li><a href="../services/user-service/master/data-model.md"><code>user-service/master/data-model.md</code></a></li>
<li><a href="../services/user-service/tenant/data-model.md"><code>user-service/tenant/data-model.md</code></a></li>
</ul>
<hr/>
<h2 id="5-permission-co-ieu-kien-condition-jsonb">5. Permission cÃ³ Ä‘iá»u kiá»‡n (Condition JSONB)<a class="headerlink" href="#5-permission-co-ieu-kien-condition-jsonb" title="Permanent link">Â¶</a></h2>
<p>Há»‡ thá»‘ng dx-vas há»— trá»£ <strong>permission cÃ³ Ä‘iá»u kiá»‡n</strong> â€“ cho phÃ©p kiá»ƒm soÃ¡t truy cáº­p Ä‘á»™ng dá»±a trÃªn ngá»¯ cáº£nh request vÃ  Ä‘áº·c tÃ­nh cá»§a ngÆ°á»i dÃ¹ng. Má»—i permission cÃ³ thá»ƒ khai bÃ¡o má»™t <code>condition</code> dÆ°á»›i dáº¡ng JSONB.</p>
<h3 id="vi-du-ve-permission-co-ieu-kien">ğŸ“Œ VÃ­ dá»¥ vá» permission cÃ³ Ä‘iá»u kiá»‡n:<a class="headerlink" href="#vi-du-ve-permission-co-ieu-kien" title="Permanent link">Â¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">{</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="nt">"class_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$user.class_id"</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>Ã nghÄ©a: Chá»‰ cho phÃ©p truy cáº­p khi <code>class_id</code> trong request <strong>trÃ¹ng khá»›p vá»›i</strong> <code>class_id</code> cá»§a user hiá»‡n táº¡i (do Sub User Service cung cáº¥p trong JWT).</p>
<h3 id="context-ho-tro-khi-evaluate">ğŸ›  Context há»— trá»£ khi evaluate:<a class="headerlink" href="#context-ho-tro-khi-evaluate" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>User context</strong>: <code>$user.{field}</code> â€“ Ä‘áº¿n tá»« <code>users_in_tenant</code></li>
<li><strong>Request context</strong>: <code>$request.{field}</code> â€“ tá»« body/query/header</li>
<li><strong>Tenant context</strong>: <code>$tenant.{field}</code> â€“ náº¿u cÃ³ metadata</li>
</ul>
<h3 id="anh-gia-ieu-kien">ğŸ§  ÄÃ¡nh giÃ¡ Ä‘iá»u kiá»‡n:<a class="headerlink" href="#anh-gia-ieu-kien" title="Permanent link">Â¶</a></h3>
<ul>
<li>ÄÆ°á»£c thá»±c hiá»‡n táº¡i <strong>API Gateway</strong></li>
<li>Engine so sÃ¡nh giÃ¡ trá»‹ thá»±c táº¿ trong request vá»›i Ä‘iá»u kiá»‡n JSONB</li>
<li>Náº¿u má»™t permission cÃ³ <code>condition = null</code> â†’ luÃ´n Ä‘Ãºng</li>
</ul>
<p>ğŸ“˜ CÃ¡c tenant cÃ³ thá»ƒ tá»± Ä‘á»‹nh nghÄ©a Ä‘iá»u kiá»‡n riÃªng theo logic Ä‘áº·c thÃ¹.</p>
<hr/>
<h2 id="6-chien-luoc-cache-rbac-tai-api-gateway">6. Chiáº¿n lÆ°á»£c Cache RBAC táº¡i API Gateway<a class="headerlink" href="#6-chien-luoc-cache-rbac-tai-api-gateway" title="Permanent link">Â¶</a></h2>
<p>Äá»ƒ giáº£m táº£i truy váº¥n RBAC thÆ°á»ng xuyÃªn, há»‡ thá»‘ng sá»­ dá»¥ng cache RBAC táº¡i API Gateway vá»›i chiáº¿n lÆ°á»£c sau:</p>
<h3 id="key-cache">ğŸ”‘ Key cache:<a class="headerlink" href="#key-cache" title="Permanent link">Â¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>rbac:{user_id}:{tenant_id}
</span></code></pre></div>
<h3 id="value-cache">ğŸ“¦ Value cache:<a class="headerlink" href="#value-cache" title="Permanent link">Â¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">"permissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">"issued_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-07-01T12:00:00Z"</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="ttl-lam-moi">â± TTL &amp; LÃ m má»›i:<a class="headerlink" href="#ttl-lam-moi" title="Permanent link">Â¶</a></h3>
<ul>
<li>TTL máº·c Ä‘á»‹nh: 5â€“15 phÃºt tÃ¹y dá»‹ch vá»¥</li>
<li>CÃ³ thá»ƒ lÃ m má»›i thá»§ cÃ´ng khi gÃ¡n quyá»n má»›i</li>
<li>Cache sáº½ tá»± Ä‘á»™ng lÃ m má»›i náº¿u JWT má»›i chá»©a RBAC má»›i</li>
</ul>
<h3 id="invalidation-qua-pubsub">ğŸ” Invalidation qua Pub/Sub:<a class="headerlink" href="#invalidation-qua-pubsub" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Khi Sub User Service cáº­p nháº­t RBAC:</p>
</li>
<li>
<p>PhÃ¡t sá»± kiá»‡n <code>rbac_updated</code> â†’ Gateway subscribe â†’ xoÃ¡ cache</p>
</li>
<li>
<p>Khi user bá»‹ vÃ´ hiá»‡u hÃ³a:</p>
</li>
<li>
<p>PhÃ¡t sá»± kiá»‡n <code>user_status_changed</code> (tá»« Master hoáº·c Sub) â†’ Gateway huá»· JWT vÃ  cache</p>
</li>
</ul>
<p>ğŸ“˜ Äá»‹nh nghÄ©a event schema trong <a href="./rbac-events.md"><code>rbac-events.md</code></a></p>
<hr/>
<h2 id="7-chien-luoc-ong-bo-rbac">7. Chiáº¿n lÆ°á»£c Äá»“ng bá»™ RBAC<a class="headerlink" href="#7-chien-luoc-ong-bo-rbac" title="Permanent link">Â¶</a></h2>
<p>Há»‡ thá»‘ng há»— trá»£ kháº£ nÄƒng <strong>káº¿ thá»«a template tá»« Master</strong>, <strong>tuá»³ chá»‰nh</strong>, vÃ  <strong>giao diá»‡n quáº£n lÃ½ phÃ¢n quyá»n riÃªng cho tá»«ng tenant</strong>.</p>
<h3 id="ke-thua-tuy-chinh">ğŸ“š Káº¿ thá»«a &amp; tÃ¹y chá»‰nh:<a class="headerlink" href="#ke-thua-tuy-chinh" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Má»—i tenant cÃ³ thá»ƒ:</p>
</li>
<li>
<p>DÃ¹ng <code>global_roles_templates</code> &amp; <code>global_permissions_templates</code> tá»« Master</p>
</li>
<li>Clone vá» lÃ m báº£n riÃªng â†’ Ä‘á»•i tÃªn/logic/condition</li>
<li>Hoáº·c tá»± táº¡o tá»« Ä‘áº§u hoÃ n toÃ n</li>
</ul>
<h3 id="gan-role-cho-nguoi-dung">ğŸ§© GÃ¡n role cho ngÆ°á»i dÃ¹ng:<a class="headerlink" href="#gan-role-cho-nguoi-dung" title="Permanent link">Â¶</a></h3>
<ul>
<li>
<p>Sub User Service cung cáº¥p API cho Admin Webapp tenant:</p>
</li>
<li>
<p>GÃ¡n <code>role_id</code> cho <code>user_id</code></p>
</li>
<li>Cáº­p nháº­t <code>is_active_in_tenant</code></li>
<li>Táº¡o vai trÃ² tÃ¹y chá»‰nh (náº¿u Ä‘Æ°á»£c cáº¥p quyá»n)</li>
</ul>
<h3 id="ong-bo-inh-ky-tuy-chon">ğŸ” Äá»“ng bá»™ Ä‘á»‹nh ká»³ (tÃ¹y chá»n):<a class="headerlink" href="#ong-bo-inh-ky-tuy-chon" title="Permanent link">Â¶</a></h3>
<ul>
<li>Náº¿u tenant cho phÃ©p, cÃ³ thá»ƒ Ä‘á»“ng bá»™ láº¡i template má»—i tuáº§n/thÃ¡ng tá»« Master</li>
</ul>
<hr/>
<h2 id="8-hieu-nang-kha-nang-mo-rong">8. Hiá»‡u nÄƒng &amp; Kháº£ nÄƒng má»Ÿ rá»™ng<a class="headerlink" href="#8-hieu-nang-kha-nang-mo-rong" title="Permanent link">Â¶</a></h2>
<p>Há»‡ thá»‘ng RBAC cá»§a dx-vas Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ há»— trá»£ <strong>sá»‘ lÆ°á»£ng lá»›n tenant</strong>, má»—i tenant cÃ³ thá»ƒ cÃ³ hÃ ng trÄƒm vai trÃ² vÃ  ngÆ°á»i dÃ¹ng.</p>
<h3 id="ky-thuat-toi-uu">ğŸ”§ Ká»¹ thuáº­t tá»‘i Æ°u:<a class="headerlink" href="#ky-thuat-toi-uu" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Cache táº¡i Gateway</strong> â†’ trÃ¡nh truy váº¥n Sub Service má»—i request</li>
<li><strong>Fan-out pub/sub invalidate</strong> â†’ tá»‘i thiá»ƒu hoÃ¡ latency cáº­p nháº­t RBAC</li>
<li><strong>Permission condition JSONB</strong> cho phÃ©p RBAC má»m dáº»o mÃ  khÃ´ng cáº§n phÃ¢n máº£nh báº£ng</li>
</ul>
<h3 id="cloud-scale">â˜ï¸ Cloud Scale:<a class="headerlink" href="#cloud-scale" title="Permanent link">Â¶</a></h3>
<ul>
<li>Redis RBAC cache Ä‘Æ°á»£c chia namespace theo <code>tenant_id</code></li>
<li>Sub User Service Ä‘Æ°á»£c autoscale Ä‘á»™c láº­p â†’ phÃ¢n táº£i dá»… dÃ ng</li>
<li>RBAC API cÃ³ thá»ƒ batch (gÃ¡n nhiá»u role/user cÃ¹ng lÃºc)</li>
</ul>
<h3 id="monitoring">ğŸ” Monitoring:<a class="headerlink" href="#monitoring" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i láº§n cache hit/miss Ä‘Æ°á»£c log kÃ¨m <code>tenant_id</code></li>
<li>CÃ³ cáº£nh bÃ¡o náº¿u role mapping báº¥t thÆ°á»ng (VD: user cÃ³ 100+ role)</li>
</ul>
<p>ğŸ“˜ Äá»ƒ tá»‘i Æ°u hÆ¡n ná»¯a, cÃ³ thá»ƒ tÃ­ch há»£p JWT RBAC claims kÃ½ cá»©ng vá»›i TTL ngáº¯n + checksum (Ä‘ang Ä‘Æ°á»£c nghiÃªn cá»©u)</p>
<hr/>
<h2 id="9-bao-mat-chuyen-sau-trong-rbac">9. Báº£o máº­t chuyÃªn sÃ¢u trong RBAC<a class="headerlink" href="#9-bao-mat-chuyen-sau-trong-rbac" title="Permanent link">Â¶</a></h2>
<p>RBAC lÃ  lá»›p kiá»ƒm soÃ¡t truy cáº­p trá»ng yáº¿u, nÃªn cÃ¡c nguyÃªn táº¯c báº£o máº­t sau Ä‘Æ°á»£c Ã¡p dá»¥ng nghiÃªm ngáº·t trong há»‡ thá»‘ng dx-vas:</p>
<h3 id="isolation-theo-tenant">ğŸ” Isolation theo Tenant<a class="headerlink" href="#isolation-theo-tenant" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i Sub User Service chá»‰ truy xuáº¥t dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vÃ  role/permission cá»§a chÃ­nh tenant Ä‘Ã³</li>
<li>KhÃ´ng cÃ³ API cho phÃ©p thao tÃ¡c chÃ©o tenant</li>
</ul>
<h3 id="ten-inh-danh-va-khong-gian-rbac">ğŸ” TÃªn Ä‘á»‹nh danh vÃ  khÃ´ng gian RBAC<a class="headerlink" href="#ten-inh-danh-va-khong-gian-rbac" title="Permanent link">Â¶</a></h3>
<ul>
<li>CÃ¡c vai trÃ² (<code>role_code</code>) vÃ  quyá»n (<code>permission_code</code>) pháº£i lÃ  duy nháº¥t <strong>trong pháº¡m vi tenant</strong></li>
<li>KhÃ´ng cho phÃ©p â€œshadowâ€ vai trÃ² tá»« tenant khÃ¡c</li>
</ul>
<h3 id="chong-gia-mao-jwt">ğŸ” Chá»‘ng giáº£ máº¡o JWT<a class="headerlink" href="#chong-gia-mao-jwt" title="Permanent link">Â¶</a></h3>
<ul>
<li>RBAC trong JWT pháº£i Ä‘Æ°á»£c kÃ½ vÃ  xÃ¡c thá»±c bá»Ÿi Gateway</li>
<li>KhÃ´ng tin tÆ°á»Ÿng RBAC trong request tá»« client frontend</li>
</ul>
<h3 id="api-rbac-luon-bao-ve-boi-auth-role">ğŸ” API RBAC luÃ´n báº£o vá»‡ bá»Ÿi Auth + Role<a class="headerlink" href="#api-rbac-luon-bao-ve-boi-auth-role" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»i thao tÃ¡c gÃ¡n quyá»n, gÃ¡n vai trÃ², cáº­p nháº­t pháº£i cÃ³ quyá»n cá»¥ thá»ƒ (<code>manage_rbac</code>, <code>assign_role</code>, v.v.)</li>
</ul>
<hr/>
<h2 id="10-giam-sat-go-loi">10. GiÃ¡m sÃ¡t &amp; Gá»¡ lá»—i<a class="headerlink" href="#10-giam-sat-go-loi" title="Permanent link">Â¶</a></h2>
<p>Äá»ƒ há»— trá»£ váº­n hÃ nh vÃ  báº£o máº­t, cÃ¡c hÃ nh Ä‘á»™ng liÃªn quan Ä‘áº¿n RBAC Ä‘Æ°á»£c log vÃ  theo dÃµi chi tiáº¿t:</p>
<h3 id="audit-trail">ğŸªµ Audit Trail<a class="headerlink" href="#audit-trail" title="Permanent link">Â¶</a></h3>
<ul>
<li>Má»—i hÃ nh Ä‘á»™ng:</li>
<li>GÃ¡n vai trÃ²</li>
<li>Táº¡o permission</li>
<li>Cáº­p nháº­t condition</li>
<li>ÄÆ°á»£c log kÃ¨m:</li>
<li><code>user_id</code>, <code>actor_id</code>, <code>tenant_id</code>, <code>timestamp</code>, <code>payload_before</code>, <code>payload_after</code></li>
</ul>
<h3 id="debug-flow-tai-gateway">ğŸ§ª Debug Flow táº¡i Gateway<a class="headerlink" href="#debug-flow-tai-gateway" title="Permanent link">Â¶</a></h3>
<ul>
<li>Gáº¯n <code>X-RBAC-Trace-ID</code> vÃ o má»—i request náº¿u báº­t debug</li>
<li>Log cÃ¡c bÆ°á»›c Ä‘Ã¡nh giÃ¡: permission match, condition eval, cache hit/miss</li>
<li>CÃ³ thá»ƒ báº­t cháº¿ Ä‘á»™ â€œdry-runâ€ RBAC trÃªn staging Ä‘á»ƒ kiá»ƒm tra rule má»›i</li>
</ul>
<h3 id="metrics">ğŸ“ˆ Metrics<a class="headerlink" href="#metrics" title="Permanent link">Â¶</a></h3>
<ul>
<li>Sá»‘ lÆ°á»£ng permission theo tenant</li>
<li>Tá»· lá»‡ cache hit/miss RBAC</li>
<li>Cáº£nh bÃ¡o náº¿u user cÃ³ sá»‘ role vÆ°á»£t ngÆ°á»¡ng</li>
</ul>
<hr/>
<h2 id="11-best-practices-cho-quan-tri-rbac">11. Best Practices cho Quáº£n trá»‹ RBAC<a class="headerlink" href="#11-best-practices-cho-quan-tri-rbac" title="Permanent link">Â¶</a></h2>
<p>Má»™t sá»‘ khuyáº¿n nghá»‹ Ä‘Æ°á»£c Ã¡p dá»¥ng vÃ  kiá»ƒm soÃ¡t qua Superadmin Webapp hoáº·c Admin Webapp táº¡i tenant:</p>
<ul>
<li>âœ… Äáº·t tÃªn <code>role_code</code>, <code>permission_code</code> rÃµ rÃ ng, snake_case</li>
<li>âœ… TÃ¡ch vai trÃ² theo domain chá»©c nÄƒng: <code>academic_staff</code>, <code>finance_admin</code>, <code>class_teacher</code></li>
<li>âœ… Giá»›i háº¡n sá»‘ vai trÃ²/user â‰¤ 10 Ä‘á»ƒ dá»… kiá»ƒm soÃ¡t</li>
<li>âœ… Æ¯u tiÃªn dÃ¹ng permission cÃ³ <code>condition</code> hÆ¡n lÃ  táº¡o thÃªm role má»›i</li>
<li>âœ… DÃ¹ng template náº¿u tenant khÃ´ng cÃ³ nhu cáº§u tuá»³ chá»‰nh</li>
<li>âŒ KhÃ´ng cho phÃ©p sá»­a <code>role_code</code> sau khi gÃ¡n cho user</li>
<li>âŒ KhÃ´ng cáº¥p quyá»n <code>manage_rbac</code> Ä‘áº¡i trÃ  â€“ nÃªn gÃ¡n cho 1â€“2 ngÆ°á»i cÃ³ trÃ¡ch nhiá»‡m</li>
</ul>
<hr/>
<h2 id="12-cong-cu-tai-lieu-lien-quan">12. CÃ´ng cá»¥ &amp; TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#12-cong-cu-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<p>ğŸ“˜ TÃ i liá»‡u ká»¹ thuáº­t chi tiáº¿t liÃªn quan Ä‘áº¿n RBAC:</p>
<table>
<thead>
<tr>
<th>Má»¥c</th>
<th>File</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kiáº¿n trÃºc tá»•ng quan RBAC</td>
<td><a href="../../#2-Ä‘Äƒng-nháº­p--phÃ¢n-quyá»n-Ä‘á»™ng-rbac"><code>README.md</code></a></td>
</tr>
<tr>
<td>MÃ´ hÃ¬nh dá»¯ liá»‡u User Master</td>
<td><a href="../services/user-service/master/data-model.md"><code>user-service/master/data-model.md</code></a></td>
</tr>
<tr>
<td>MÃ´ hÃ¬nh dá»¯ liá»‡u Sub User Service</td>
<td><a href="../services/user-service/tenant/data-model.md"><code>user-service/tenant/data-model.md</code></a></td>
</tr>
<tr>
<td>Giao diá»‡n quáº£n trá»‹ RBAC</td>
<td><a href="../../interfaces/ic-02-admin-webapp/"><code>ic-02-admin-webapp.md</code></a></td>
</tr>
<tr>
<td>Kiá»ƒm soÃ¡t xÃ¡c thá»±c &amp; JWT</td>
<td><a href="../../ADR/adr-006-auth-strategy/"><code>adr-006-auth-strategy.md</code></a></td>
</tr>
<tr>
<td>Quy táº¯c Ä‘iá»u kiá»‡n &amp; JSONB</td>
<td><a href="./rbac-condition-schema.md"><code>rbac-condition-schema.md</code></a></td>
</tr>
<tr>
<td>Sá»± kiá»‡n RBAC &amp; Cache Invalidation</td>
<td><a href="./rbac-events.md"><code>rbac-events.md</code></a></td>
</tr>
<tr>
<td>Danh sÃ¡ch role máº«u toÃ n há»‡ thá»‘ng</td>
<td><a href="../templates/global-roles-template.yaml"><code>global-roles-template.yaml</code></a></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="so-o-rbac-phan-tang-user-master-va-sub-user-services">ğŸ” SÆ¡ Ä‘á»“ RBAC PhÃ¢n táº§ng â€“ User Master vÃ  Sub User Services<a class="headerlink" href="#so-o-rbac-phan-tang-user-master-va-sub-user-services" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart TD

  subgraph Master["User Service Master"]
    UGM[users_global]
    TENTS[tenants]
    UTA[user_tenant_assignments]
    GRT[global_roles_templates]
    GPT[global_permissions_templates]
  end

  subgraph Tenant_A["Sub User Service â€“ Tenant A"]
    UTA1[users_in_tenant]
    RA1[roles_in_tenant]
    PA1[permissions_in_tenant]
    URA1[user_role_in_tenant]
    RPA1[role_permission_in_tenant]
  end

  subgraph Tenant_B["Sub User Service â€“ Tenant B"]
    UTA2[users_in_tenant]
    RA2[roles_in_tenant]
    PA2[permissions_in_tenant]
    URA2[user_role_in_tenant]
    RPA2[role_permission_in_tenant]
  end

  %% Mapping
  UGM --&gt; UTA
  TENTS --&gt; UTA
  UGM --&gt; UTA1
  UGM --&gt; UTA2

  GRT --&gt; RA1
  GRT --&gt; RA2
  GPT --&gt; PA1
  GPT --&gt; PA2

  UTA1 --&gt; URA1
  RA1 --&gt; URA1
  RA1 --&gt; RPA1
  PA1 --&gt; RPA1

  UTA2 --&gt; URA2
  RA2 --&gt; URA2
  RA2 --&gt; RPA2
  PA2 --&gt; RPA2
</code></pre>
<p>ğŸ“Œ <strong>Giáº£i thÃ­ch:</strong></p>
<ul>
<li><code>users_global</code> lÃ  nguá»“n Ä‘á»‹nh danh chung, dÃ¹ng cho táº¥t cáº£ cÃ¡c tenant.</li>
<li>
<p>Má»—i tenant cÃ³ Sub User Service quáº£n lÃ½ riÃªng:</p>
</li>
<li>
<p><code>users_in_tenant</code> Ã¡nh xáº¡ tá»›i <code>user_id_global</code></p>
</li>
<li>Vai trÃ² &amp; quyá»n cá»¥c bá»™, cÃ³ thá»ƒ káº¿ thá»«a tá»« Master hoáº·c tá»± Ä‘á»‹nh nghÄ©a</li>
<li>Mapping RBAC (<code>user â†” role â†” permission</code>) lÃ  Ä‘á»™c láº­p giá»¯a cÃ¡c tenant.</li>
</ul>
<p>ğŸ“˜ SÆ¡ Ä‘á»“ nÃ y giÃºp Superadmin, DevOps vÃ  Dev hiá»ƒu rÃµ luá»“ng phÃ¢n quyá»n, vá»‹ trÃ­ source of truth, vÃ  cÃ¡ch tÃ¡ch biá»‡t báº£o máº­t giá»¯a cÃ¡c tenant.</p>
<hr/>
<h3 id="so-o-luong-kiem-tra-rbac-tai-api-gateway">ğŸ” SÆ¡ Ä‘á»“ Luá»“ng Kiá»ƒm tra RBAC táº¡i API Gateway<a class="headerlink" href="#so-o-luong-kiem-tra-rbac-tai-api-gateway" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant Client as ğŸŒ Client (Frontend)
    participant Gateway as ğŸ›¡ï¸ API Gateway
    participant Auth as ğŸ” Auth Service (Master/Sub)
    participant JWT as ğŸ“¦ JWT Token
    participant Redis as âš¡ RBAC Cache
    participant SubUser as ğŸ§© Sub User Service (per tenant)

    Client-&gt;&gt;Auth: ÄÄƒng nháº­p (OAuth2 / OTP)
    Auth-&gt;&gt;JWT: PhÃ¡t hÃ nh JWT chá»©a\nuser_id, tenant_id, roles, permissions
    Client-&gt;&gt;Gateway: Gá»­i request kÃ¨m JWT

    Gateway-&gt;&gt;JWT: Giáº£i mÃ£ JWT
    Gateway-&gt;&gt;JWT: Láº¥y user_id, tenant_id, permissions
    alt Cache Hit
        Gateway-&gt;&gt;Redis: Láº¥y RBAC tá»« cache\nrbac:{user_id}:{tenant_id}
    else Cache Miss
        Gateway-&gt;&gt;SubUser: Gá»i API Ä‘á»ƒ láº¥y roles &amp; permissions
        SubUser--&gt;&gt;Gateway: Tráº£ vá» roles, permissions
        Gateway-&gt;&gt;Redis: Ghi cache RBAC
    end

    alt CÃ³ permission khá»›p + Ä‘iá»u kiá»‡n Ä‘Ãºng
        Gateway--&gt;&gt;Client: âœ… 200 OK (forward tá»›i backend)
    else KhÃ´ng cÃ³ quyá»n / Sai Ä‘iá»u kiá»‡n
        Gateway--&gt;&gt;Client: âŒ 403 Forbidden
    end
</code></pre>
<p>ğŸ“Œ <strong>Giáº£i thÃ­ch nhanh:</strong></p>
<ul>
<li>Gateway lÃ  nÆ¡i trung tÃ¢m Ä‘Ã¡nh giÃ¡ quyá»n dá»±a trÃªn JWT vÃ  RBAC.</li>
<li>DÃ¹ng cache Redis Ä‘á»ƒ trÃ¡nh gá»i Sub User Service quÃ¡ thÆ°á»ng xuyÃªn.</li>
<li>Há»— trá»£ <code>condition JSONB</code> Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ táº¡i Gateway báº±ng context tá»« JWT vÃ  request.</li>
</ul>
<p>ğŸ“˜ RBAC cache invalidation Ä‘Æ°á»£c Ä‘iá»u phá»‘i bá»Ÿi Pub/Sub events tá»« Sub User Service nhÆ° <code>rbac_updated</code> hoáº·c <code>user_status_changed</code>.</p>
<hr/>
<h3 id="so-o-luong-phat-hanh-jwt-a-tenant">ğŸ”‘ SÆ¡ Ä‘á»“ Luá»“ng PhÃ¡t hÃ nh JWT Äa-Tenant<a class="headerlink" href="#so-o-luong-phat-hanh-jwt-a-tenant" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant User as ğŸ‘¤ NgÆ°á»i dÃ¹ng
    participant Frontend as ğŸŒ Frontend App
    participant AuthM as ğŸ” Auth Service Master
    participant AuthT as ğŸ” Sub Auth Service (per tenant)
    participant UserMaster as ğŸ§  User Service Master
    participant UserSub as ğŸ§© Sub User Service (per tenant)
    participant JWT as ğŸ“¦ JWT Token

    rect rgba(220,220,220,0.1)
    Note over User, AuthM: ÄÄƒng nháº­p Google OAuth2
    User-&gt;&gt;Frontend: Má»Ÿ á»©ng dá»¥ng
    Frontend-&gt;&gt;AuthM: Login via Google
    AuthM-&gt;&gt;Google: OAuth2 Authorization
    Google--&gt;&gt;AuthM: Access Token
    AuthM-&gt;&gt;UserMaster: XÃ¡c minh user + láº¥y user_id_global
    UserMaster--&gt;&gt;AuthM: user_id_global + danh sÃ¡ch tenant

    alt User thuá»™c nhiá»u tenant
        AuthM-&gt;&gt;Frontend: YÃªu cáº§u chá»n tenant
        Frontend-&gt;&gt;AuthM: tenant_id Ä‘Ã£ chá»n
    else Chá»‰ má»™t tenant
        AuthM: Bá» qua bÆ°á»›c chá»n
    end

    AuthM-&gt;&gt;UserSub: Láº¥y roles &amp; permissions trong tenant Ä‘Ã£ chá»n
    UserSub--&gt;&gt;AuthM: Tráº£ danh sÃ¡ch role/permission
    AuthM-&gt;&gt;JWT: KÃ½ &amp; phÃ¡t JWT chá»©a:\nuser_id, tenant_id, roles, permissions
    AuthM--&gt;&gt;Frontend: Tráº£ JWT
    end

    rect rgba(220,220,220,0.1)
    Note over User, AuthT: ÄÄƒng nháº­p Local/OTP
    User-&gt;&gt;Frontend: Má»Ÿ á»©ng dá»¥ng (trÆ°á»ng khÃ´ng dÃ¹ng Google)
    Frontend-&gt;&gt;AuthT: Login OTP
    AuthT-&gt;&gt;UserMaster: Kiá»ƒm tra user / Ä‘Äƒng kÃ½ má»›i
    UserMaster--&gt;&gt;AuthT: user_id_global
    AuthT-&gt;&gt;UserSub: Láº¥y roles &amp; permissions trong tenant
    UserSub--&gt;&gt;AuthT: Tráº£ roles, permissions
    AuthT-&gt;&gt;JWT: PhÃ¡t JWT Ä‘áº§y Ä‘á»§
    AuthT--&gt;&gt;Frontend: Tráº£ JWT
    end
</code></pre>
<p>ğŸ“Œ <strong>Äiá»ƒm chÃ­nh:</strong></p>
<ul>
<li>Auth Master xá»­ lÃ½ Google OAuth2 + lá»±a chá»n tenant.</li>
<li>Sub Auth xá»­ lÃ½ xÃ¡c thá»±c Local/OTP táº¡i tenant.</li>
<li>Má»i JWT phÃ¡t ra Ä‘á»u chá»©a <code>user_id_global</code>, <code>tenant_id</code>, <code>roles</code>, <code>permissions</code>.</li>
</ul>
<p>ğŸ“˜ Tham kháº£o chi tiáº¿t cáº¥u trÃºc JWT trong <a href="../../ADR/adr-006-auth-strategy/"><code>adr-006-auth-strategy.md</code></a></p>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>