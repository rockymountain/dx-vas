
<!DOCTYPE html>

<html class="no-js" lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="TÃ i liá»‡u kiáº¿n trÃºc vÃ  phÃ¡t triá»ƒn cho dá»± Ã¡n Chuyá»ƒn Ä‘á»•i sá»‘ TrÆ°á»ng Viá»‡t Anh (dx_vas)." name="description"/>
<meta content="DX VAS Team" name="author"/>
<link href="https://dx.truongvietanh.edu.vn/dev/backend-dev-guide/" rel="canonical"/>
<link href="../dev-guide/" rel="prev"/>
<link href="../ops-guide/" rel="next"/>
<link href="../../assets/images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Backend Dev Guide - DX VAS - Docs</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="pink" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#backend-dev-guide-dx-vas">
          Bá» qua
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Äáº§u trang" class="md-header__inner md-grid">
<a aria-label="DX VAS - Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DX VAS - Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Backend Dev Guide
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="pink" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="lime" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="TÃ¬m kiáº¿m" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="TÃ¬m kiáº¿m" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="TÃ¬m kiáº¿m" class="md-search__options">
<button aria-label="XoÃ¡" class="md-search__icon md-icon" tabindex="-1" title="XoÃ¡" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
          
  
  
    
  
  Kiáº¿n trÃºc Há»‡ thá»‘ng

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../dev-guide/">
          
  
  
    
  
  HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../services/user-service/design/">
          
  
  
    
  
  Thiáº¿t káº¿ Services

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../ADR/">
          
  
  
    
  
  Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Thanh Ä‘iá»u hÆ°á»›ng" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DX VAS - Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="DX VAS - Docs">
<img alt="logo" src="../../assets/images/logo.png"/>
</a>
    DX VAS - Docs
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/rockymountain/dx-vas.git" title="Xem mÃ£ nguá»“n">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    rockymountain/dx-vas
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Kiáº¿n trÃºc Há»‡ thá»‘ng
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Kiáº¿n trÃºc Há»‡ thá»‘ng
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/system-diagrams/">
<span class="md-ellipsis">
    SÆ¡ Ä‘á»“ Há»‡ thá»‘ng
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/rbac-deep-dive/">
<span class="md-ellipsis">
    RBAC Chi tiáº¿t
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-ellipsis">
    HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            HÆ°á»›ng dáº«n PhÃ¡t triá»ƒn
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../dev-guide/">
<span class="md-ellipsis">
    Tá»•ng quan PhÃ¡t triá»ƒn (Dev Guide)
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Backend Dev Guide
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Backend Dev Guide
    
  </span>
</a>
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-luc">
<span class="md-ellipsis">
      Má»¥c lá»¥c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-nguyen-tac">
<span class="md-ellipsis">
      1. Pháº¡m vi &amp; nguyÃªn táº¯c
    </span>
</a>
<nav aria-label="1. Pháº¡m vi &amp; nguyÃªn táº¯c" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-tieu">
<span class="md-ellipsis">
      Má»¥c tiÃªu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pham-vi-ap-dung">
<span class="md-ellipsis">
      Pháº¡m vi Ã¡p dá»¥ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nguyen-tac-cot-loi">
<span class="md-ellipsis">
      NguyÃªn táº¯c cá»‘t lÃµi
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-cau-truc-thu-muc-backend-chuan">
<span class="md-ellipsis">
      2. Cáº¥u trÃºc thÆ° má»¥c backend chuáº©n
    </span>
</a>
<nav aria-label="2. Cáº¥u trÃºc thÆ° má»¥c backend chuáº©n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mot-so-quy-uoc-chung">
<span class="md-ellipsis">
      ğŸ“Œ Má»™t sá»‘ quy Æ°á»›c chung
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y">
<span class="md-ellipsis">
      ğŸ“ Gá»£i Ã½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quan-ly-dependency-depspy">
<span class="md-ellipsis">
      ğŸ”§ Quáº£n lÃ½ Dependency (deps.py)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-phan-tang-logic-vai-tro">
<span class="md-ellipsis">
      3. PhÃ¢n táº§ng logic &amp; vai trÃ²
    </span>
</a>
<nav aria-label="3. PhÃ¢n táº§ng logic &amp; vai trÃ²" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tang-1-api-handler-appapi">
<span class="md-ellipsis">
      ğŸ§± Táº§ng 1: API Handler (app/api/)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tang-2-service-layer-appservices">
<span class="md-ellipsis">
      âš™ï¸ Táº§ng 2: Service Layer (app/services/)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tang-3-repository-layer-apprepositories">
<span class="md-ellipsis">
      ğŸ—ƒï¸ Táº§ng 3: Repository Layer (app/repositories/)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-bo-sung">
<span class="md-ellipsis">
      ğŸ’¡ LÆ°u Ã½ bá»• sung
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-kien-truc-3-layer-luong-xu-ly-ien-hinh-trong-mot-backend-service">
<span class="md-ellipsis">
      ğŸ“Š SÆ¡ Ä‘á»“ kiáº¿n trÃºc 3-layer â€“ luá»“ng xá»­ lÃ½ Ä‘iá»ƒn hÃ¬nh trong má»™t backend service
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-nang-cao-unit-of-work-uow">
<span class="md-ellipsis">
      ğŸ’¡ Gá»£i Ã½ nÃ¢ng cao â€“ Unit of Work (UoW)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-at-ten-convention-code">
<span class="md-ellipsis">
      4. Äáº·t tÃªn &amp; convention code
    </span>
</a>
<nav aria-label="4. Äáº·t tÃªn &amp; convention code" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-file-thu-muc">
<span class="md-ellipsis">
      ğŸ“ TÃªn file &amp; thÆ° má»¥c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-class">
<span class="md-ellipsis">
      ğŸ”¤ TÃªn class
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#at-ten-route-api-path">
<span class="md-ellipsis">
      ğŸŒ Äáº·t tÃªn route (API path)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-bien-ham">
<span class="md-ellipsis">
      ğŸ’¬ TÃªn biáº¿n &amp; hÃ m
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-xu-ly-nghiep-vu-usecase-mau">
<span class="md-ellipsis">
      5. Xá»­ lÃ½ nghiá»‡p vá»¥ &amp; usecase máº«u
    </span>
</a>
<nav aria-label="5. Xá»­ lÃ½ nghiá»‡p vá»¥ &amp; usecase máº«u" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mot-usecase-mau-cap-nhat-thong-tin-hoc-sinh">
<span class="md-ellipsis">
      ğŸ§© Má»™t usecase máº«u â€“ Cáº­p nháº­t thÃ´ng tin há»c sinh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-nho-khi-viet-usecase">
<span class="md-ellipsis">
      âœ… Ghi nhá»› khi viáº¿t usecase
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-nang-cao-idempotency-cho-usecase-ong-bo">
<span class="md-ellipsis">
      ğŸ” LÆ°u Ã½ nÃ¢ng cao: Idempotency cho usecase Ä‘á»“ng bá»™
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-schema-validation-pydantic">
<span class="md-ellipsis">
      6. Schema &amp; validation (Pydantic)
    </span>
</a>
<nav aria-label="6. Schema &amp; validation (Pydantic)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#phan-loai-schema">
<span class="md-ellipsis">
      ğŸ“¦ PhÃ¢n loáº¡i schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vi-du-schema-student">
<span class="md-ellipsis">
      âœ… VÃ­ dá»¥ schema â€“ Student
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#custom-validator-vi-du">
<span class="md-ellipsis">
      ğŸ§ª Custom validator vÃ­ dá»¥
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-khi-dung-schema">
<span class="md-ellipsis">
      âš ï¸ LÆ°u Ã½ khi dÃ¹ng schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tips-nang-cao">
<span class="md-ellipsis">
      ğŸ“ Tips nÃ¢ng cao
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-xu-ly-loi-thong-bao">
<span class="md-ellipsis">
      7. Xá»­ lÃ½ lá»—i &amp; thÃ´ng bÃ¡o
    </span>
</a>
<nav aria-label="7. Xá»­ lÃ½ lá»—i &amp; thÃ´ng bÃ¡o" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-loi-chuan">
<span class="md-ellipsis">
      ğŸš§ Cáº¥u trÃºc lá»—i chuáº©n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phan-tang-xu-ly-loi">
<span class="md-ellipsis">
      ğŸ’¢ PhÃ¢n táº§ng xá»­ lÃ½ lá»—i
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#base-error-dung-chung">
<span class="md-ellipsis">
      ğŸ§± Base error dÃ¹ng chung
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mapping-loi-ma-http">
<span class="md-ellipsis">
      ğŸ” Mapping lá»—i â†’ mÃ£ HTTP
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-repository-truy-xuat-du-lieu">
<span class="md-ellipsis">
      8. Repository &amp; truy xuáº¥t dá»¯ liá»‡u
    </span>
</a>
<nav aria-label="8. Repository &amp; truy xuáº¥t dá»¯ liá»‡u" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vai-tro-cua-repository">
<span class="md-ellipsis">
      ğŸ“¦ Vai trÃ² cá»§a repository
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mau-repository-studentrepo">
<span class="md-ellipsis">
      ğŸ§± Máº«u repository â€“ StudentRepo
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y">
<span class="md-ellipsis">
      ğŸ§¯ LÆ°u Ã½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tao-session-db">
<span class="md-ellipsis">
      ğŸ›  Táº¡o session DB
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-pubsub-subscriber-idempotency">
<span class="md-ellipsis">
      9. Pub/Sub subscriber &amp; idempotency
    </span>
</a>
<nav aria-label="9. Pub/Sub subscriber &amp; idempotency" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-thu-muc-goi-y">
<span class="md-ellipsis">
      ğŸ“¦ Cáº¥u trÃºc thÆ° má»¥c gá»£i Ã½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#viet-mot-subscriber-handler">
<span class="md-ellipsis">
      ğŸ“¥ Viáº¿t má»™t subscriber handler
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#idempotency-cach-am-bao">
<span class="md-ellipsis">
      ğŸ§ª Idempotency: cÃ¡ch Ä‘áº£m báº£o
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#framework-ho-tro">
<span class="md-ellipsis">
      ğŸ§­ Framework há»— trá»£
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cleanup">
<span class="md-ellipsis">
      ğŸ§¼ Cleanup
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-test-on-vi-tich-hop">
<span class="md-ellipsis">
      10. Test Ä‘Æ¡n vá»‹ &amp; tÃ­ch há»£p
    </span>
</a>
<nav aria-label="10. Test Ä‘Æ¡n vá»‹ &amp; tÃ­ch há»£p" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-thu-muc-test">
<span class="md-ellipsis">
      ğŸ§ª Cáº¥u trÃºc thÆ° má»¥c test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#unit-test-service-khong-phu-thuoc-db">
<span class="md-ellipsis">
      âœ… Unit test â€“ Service khÃ´ng phá»¥ thuá»™c DB
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#integration-test-route-db">
<span class="md-ellipsis">
      ğŸ” Integration test â€“ Route + DB
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pytest-fixture-goi-y-conftestpy">
<span class="md-ellipsis">
      ğŸ§© Pytest fixture gá»£i Ã½ (conftest.py)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-khi-viet-test">
<span class="md-ellipsis">
      ğŸ’¡ LÆ°u Ã½ khi viáº¿t test
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-checklist-khi-tao-pr-backend">
<span class="md-ellipsis">
      11. Checklist khi táº¡o PR backend
    </span>
</a>
<nav aria-label="11. Checklist khi táº¡o PR backend" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#checklist-ky-thuat">
<span class="md-ellipsis">
      âœ… Checklist ká»¹ thuáº­t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#checklist-logic-nghiep-vu">
<span class="md-ellipsis">
      ğŸ“ Checklist logic nghiá»‡p vá»¥
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-review">
<span class="md-ellipsis">
      ğŸ” Gá»£i Ã½ review
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. TÃ i liá»‡u liÃªn quan
    </span>
</a>
<nav aria-label="12. TÃ i liá»‡u liÃªn quan" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-lieu-kien-truc-luong-he-thong">
<span class="md-ellipsis">
      ğŸ“š TÃ i liá»‡u kiáº¿n trÃºc &amp; luá»“ng há»‡ thá»‘ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dev-guide-cicd">
<span class="md-ellipsis">
      ğŸ§ª Dev Guide &amp; CI/CD
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#service-template-example">
<span class="md-ellipsis">
      ğŸ›  Service template &amp; example
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-logging-best-practices">
<span class="md-ellipsis">
      13. Logging Best Practices
    </span>
</a>
<nav aria-label="13. Logging Best Practices" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cap-o-log">
<span class="md-ellipsis">
      ğŸ” Cáº¥p Ä‘á»™ log
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-log">
<span class="md-ellipsis">
      ğŸ“¦ Cáº¥u trÃºc log
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-log-theo-tang">
<span class="md-ellipsis">
      ğŸ§­ Gá»£i Ã½ log theo táº§ng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-security-considerations-can-nhac-bao-mat-cho-backend">
<span class="md-ellipsis">
      14. Security Considerations â€“ CÃ¢n nháº¯c báº£o máº­t cho Backend
    </span>
</a>
<nav aria-label="14. Security Considerations â€“ CÃ¢n nháº¯c báº£o máº­t cho Backend" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#nguyen-tac-cot-loi_1">
<span class="md-ellipsis">
      ğŸ” NguyÃªn táº¯c cá»‘t lÃµi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#input-validation-sanity-check">
<span class="md-ellipsis">
      ğŸ§ª Input validation &amp; Sanity Check
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quan-ly-secret-cau-hinh-an-toan">
<span class="md-ellipsis">
      ğŸ” Quáº£n lÃ½ secret &amp; cáº¥u hÃ¬nh an toÃ n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#token-phan-quyen">
<span class="md-ellipsis">
      ğŸ“¦ Token &amp; phÃ¢n quyá»n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#owasp-api-security-cac-lo-hong-can-e-phong">
<span class="md-ellipsis">
      ğŸ“› OWASP API Security â€“ CÃ¡c lá»— há»•ng cáº§n Ä‘á» phÃ²ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#logging-auditing">
<span class="md-ellipsis">
      ğŸ§¯ Logging &amp; Auditing
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#15-performance-tips-toi-uu-hieu-nang-backend">
<span class="md-ellipsis">
      15. Performance Tips â€“ Tá»‘i Æ°u hiá»‡u nÄƒng Backend
    </span>
</a>
<nav aria-label="15. Performance Tips â€“ Tá»‘i Æ°u hiá»‡u nÄƒng Backend" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#truy-van-db-hieu-qua">
<span class="md-ellipsis">
      ğŸ“¥ Truy váº¥n DB hiá»‡u quáº£
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#caching-neu-can-thiet">
<span class="md-ellipsis">
      ğŸ“¤ Caching náº¿u cáº§n thiáº¿t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#toi-uu-luong-xu-ly">
<span class="md-ellipsis">
      ğŸª„ Tá»‘i Æ°u luá»“ng xá»­ lÃ½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#giam-thieu-io-blocking">
<span class="md-ellipsis">
      ğŸ§® Giáº£m thiá»ƒu I/O Blocking
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#o-luong-va-theo-doi">
<span class="md-ellipsis">
      ğŸ§ª Äo lÆ°á»ng vÃ  theo dÃµi
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ops-guide/">
<span class="md-ellipsis">
    Váº­n hÃ nh &amp; DevOps (Ops Guide)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Thiáº¿t káº¿ Services
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Thiáº¿t káº¿ Services
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
<span class="md-ellipsis">
    User Service
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            User Service
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/design/">
<span class="md-ellipsis">
    Tá»•ng quan Thiáº¿t káº¿
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/interface-contract/">
<span class="md-ellipsis">
    Há»£p Ä‘á»“ng Giao diá»‡n
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/data-model/">
<span class="md-ellipsis">
    MÃ´ hÃ¬nh Dá»¯ liá»‡u
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../services/user-service/openapi.yaml">
<span class="md-ellipsis">
    Äáº·c táº£ OpenAPI
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../ADR/">
<span class="md-ellipsis">
    Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
    
  </span>
</a>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc (ADRs)
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Má»¥c lá»¥c" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Má»¥c lá»¥c
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-luc">
<span class="md-ellipsis">
      Má»¥c lá»¥c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#1-pham-vi-nguyen-tac">
<span class="md-ellipsis">
      1. Pháº¡m vi &amp; nguyÃªn táº¯c
    </span>
</a>
<nav aria-label="1. Pháº¡m vi &amp; nguyÃªn táº¯c" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#muc-tieu">
<span class="md-ellipsis">
      Má»¥c tiÃªu
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pham-vi-ap-dung">
<span class="md-ellipsis">
      Pháº¡m vi Ã¡p dá»¥ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nguyen-tac-cot-loi">
<span class="md-ellipsis">
      NguyÃªn táº¯c cá»‘t lÃµi
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-cau-truc-thu-muc-backend-chuan">
<span class="md-ellipsis">
      2. Cáº¥u trÃºc thÆ° má»¥c backend chuáº©n
    </span>
</a>
<nav aria-label="2. Cáº¥u trÃºc thÆ° má»¥c backend chuáº©n" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mot-so-quy-uoc-chung">
<span class="md-ellipsis">
      ğŸ“Œ Má»™t sá»‘ quy Æ°á»›c chung
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y">
<span class="md-ellipsis">
      ğŸ“ Gá»£i Ã½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quan-ly-dependency-depspy">
<span class="md-ellipsis">
      ğŸ”§ Quáº£n lÃ½ Dependency (deps.py)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-phan-tang-logic-vai-tro">
<span class="md-ellipsis">
      3. PhÃ¢n táº§ng logic &amp; vai trÃ²
    </span>
</a>
<nav aria-label="3. PhÃ¢n táº§ng logic &amp; vai trÃ²" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tang-1-api-handler-appapi">
<span class="md-ellipsis">
      ğŸ§± Táº§ng 1: API Handler (app/api/)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tang-2-service-layer-appservices">
<span class="md-ellipsis">
      âš™ï¸ Táº§ng 2: Service Layer (app/services/)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tang-3-repository-layer-apprepositories">
<span class="md-ellipsis">
      ğŸ—ƒï¸ Táº§ng 3: Repository Layer (app/repositories/)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-bo-sung">
<span class="md-ellipsis">
      ğŸ’¡ LÆ°u Ã½ bá»• sung
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#so-o-kien-truc-3-layer-luong-xu-ly-ien-hinh-trong-mot-backend-service">
<span class="md-ellipsis">
      ğŸ“Š SÆ¡ Ä‘á»“ kiáº¿n trÃºc 3-layer â€“ luá»“ng xá»­ lÃ½ Ä‘iá»ƒn hÃ¬nh trong má»™t backend service
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-nang-cao-unit-of-work-uow">
<span class="md-ellipsis">
      ğŸ’¡ Gá»£i Ã½ nÃ¢ng cao â€“ Unit of Work (UoW)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-at-ten-convention-code">
<span class="md-ellipsis">
      4. Äáº·t tÃªn &amp; convention code
    </span>
</a>
<nav aria-label="4. Äáº·t tÃªn &amp; convention code" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-file-thu-muc">
<span class="md-ellipsis">
      ğŸ“ TÃªn file &amp; thÆ° má»¥c
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-class">
<span class="md-ellipsis">
      ğŸ”¤ TÃªn class
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#at-ten-route-api-path">
<span class="md-ellipsis">
      ğŸŒ Äáº·t tÃªn route (API path)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ten-bien-ham">
<span class="md-ellipsis">
      ğŸ’¬ TÃªn biáº¿n &amp; hÃ m
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-xu-ly-nghiep-vu-usecase-mau">
<span class="md-ellipsis">
      5. Xá»­ lÃ½ nghiá»‡p vá»¥ &amp; usecase máº«u
    </span>
</a>
<nav aria-label="5. Xá»­ lÃ½ nghiá»‡p vá»¥ &amp; usecase máº«u" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mot-usecase-mau-cap-nhat-thong-tin-hoc-sinh">
<span class="md-ellipsis">
      ğŸ§© Má»™t usecase máº«u â€“ Cáº­p nháº­t thÃ´ng tin há»c sinh
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ghi-nho-khi-viet-usecase">
<span class="md-ellipsis">
      âœ… Ghi nhá»› khi viáº¿t usecase
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-nang-cao-idempotency-cho-usecase-ong-bo">
<span class="md-ellipsis">
      ğŸ” LÆ°u Ã½ nÃ¢ng cao: Idempotency cho usecase Ä‘á»“ng bá»™
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-schema-validation-pydantic">
<span class="md-ellipsis">
      6. Schema &amp; validation (Pydantic)
    </span>
</a>
<nav aria-label="6. Schema &amp; validation (Pydantic)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#phan-loai-schema">
<span class="md-ellipsis">
      ğŸ“¦ PhÃ¢n loáº¡i schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vi-du-schema-student">
<span class="md-ellipsis">
      âœ… VÃ­ dá»¥ schema â€“ Student
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#custom-validator-vi-du">
<span class="md-ellipsis">
      ğŸ§ª Custom validator vÃ­ dá»¥
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-khi-dung-schema">
<span class="md-ellipsis">
      âš ï¸ LÆ°u Ã½ khi dÃ¹ng schema
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tips-nang-cao">
<span class="md-ellipsis">
      ğŸ“ Tips nÃ¢ng cao
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-xu-ly-loi-thong-bao">
<span class="md-ellipsis">
      7. Xá»­ lÃ½ lá»—i &amp; thÃ´ng bÃ¡o
    </span>
</a>
<nav aria-label="7. Xá»­ lÃ½ lá»—i &amp; thÃ´ng bÃ¡o" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-loi-chuan">
<span class="md-ellipsis">
      ğŸš§ Cáº¥u trÃºc lá»—i chuáº©n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phan-tang-xu-ly-loi">
<span class="md-ellipsis">
      ğŸ’¢ PhÃ¢n táº§ng xá»­ lÃ½ lá»—i
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#base-error-dung-chung">
<span class="md-ellipsis">
      ğŸ§± Base error dÃ¹ng chung
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mapping-loi-ma-http">
<span class="md-ellipsis">
      ğŸ” Mapping lá»—i â†’ mÃ£ HTTP
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-repository-truy-xuat-du-lieu">
<span class="md-ellipsis">
      8. Repository &amp; truy xuáº¥t dá»¯ liá»‡u
    </span>
</a>
<nav aria-label="8. Repository &amp; truy xuáº¥t dá»¯ liá»‡u" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vai-tro-cua-repository">
<span class="md-ellipsis">
      ğŸ“¦ Vai trÃ² cá»§a repository
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mau-repository-studentrepo">
<span class="md-ellipsis">
      ğŸ§± Máº«u repository â€“ StudentRepo
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y">
<span class="md-ellipsis">
      ğŸ§¯ LÆ°u Ã½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tao-session-db">
<span class="md-ellipsis">
      ğŸ›  Táº¡o session DB
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#9-pubsub-subscriber-idempotency">
<span class="md-ellipsis">
      9. Pub/Sub subscriber &amp; idempotency
    </span>
</a>
<nav aria-label="9. Pub/Sub subscriber &amp; idempotency" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-thu-muc-goi-y">
<span class="md-ellipsis">
      ğŸ“¦ Cáº¥u trÃºc thÆ° má»¥c gá»£i Ã½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#viet-mot-subscriber-handler">
<span class="md-ellipsis">
      ğŸ“¥ Viáº¿t má»™t subscriber handler
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#idempotency-cach-am-bao">
<span class="md-ellipsis">
      ğŸ§ª Idempotency: cÃ¡ch Ä‘áº£m báº£o
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#framework-ho-tro">
<span class="md-ellipsis">
      ğŸ§­ Framework há»— trá»£
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cleanup">
<span class="md-ellipsis">
      ğŸ§¼ Cleanup
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#10-test-on-vi-tich-hop">
<span class="md-ellipsis">
      10. Test Ä‘Æ¡n vá»‹ &amp; tÃ­ch há»£p
    </span>
</a>
<nav aria-label="10. Test Ä‘Æ¡n vá»‹ &amp; tÃ­ch há»£p" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-thu-muc-test">
<span class="md-ellipsis">
      ğŸ§ª Cáº¥u trÃºc thÆ° má»¥c test
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#unit-test-service-khong-phu-thuoc-db">
<span class="md-ellipsis">
      âœ… Unit test â€“ Service khÃ´ng phá»¥ thuá»™c DB
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#integration-test-route-db">
<span class="md-ellipsis">
      ğŸ” Integration test â€“ Route + DB
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pytest-fixture-goi-y-conftestpy">
<span class="md-ellipsis">
      ğŸ§© Pytest fixture gá»£i Ã½ (conftest.py)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#luu-y-khi-viet-test">
<span class="md-ellipsis">
      ğŸ’¡ LÆ°u Ã½ khi viáº¿t test
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#11-checklist-khi-tao-pr-backend">
<span class="md-ellipsis">
      11. Checklist khi táº¡o PR backend
    </span>
</a>
<nav aria-label="11. Checklist khi táº¡o PR backend" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#checklist-ky-thuat">
<span class="md-ellipsis">
      âœ… Checklist ká»¹ thuáº­t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#checklist-logic-nghiep-vu">
<span class="md-ellipsis">
      ğŸ“ Checklist logic nghiá»‡p vá»¥
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-review">
<span class="md-ellipsis">
      ğŸ” Gá»£i Ã½ review
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-tai-lieu-lien-quan">
<span class="md-ellipsis">
      12. TÃ i liá»‡u liÃªn quan
    </span>
</a>
<nav aria-label="12. TÃ i liá»‡u liÃªn quan" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tai-lieu-kien-truc-luong-he-thong">
<span class="md-ellipsis">
      ğŸ“š TÃ i liá»‡u kiáº¿n trÃºc &amp; luá»“ng há»‡ thá»‘ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dev-guide-cicd">
<span class="md-ellipsis">
      ğŸ§ª Dev Guide &amp; CI/CD
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#service-template-example">
<span class="md-ellipsis">
      ğŸ›  Service template &amp; example
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-logging-best-practices">
<span class="md-ellipsis">
      13. Logging Best Practices
    </span>
</a>
<nav aria-label="13. Logging Best Practices" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cap-o-log">
<span class="md-ellipsis">
      ğŸ” Cáº¥p Ä‘á»™ log
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cau-truc-log">
<span class="md-ellipsis">
      ğŸ“¦ Cáº¥u trÃºc log
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#goi-y-log-theo-tang">
<span class="md-ellipsis">
      ğŸ§­ Gá»£i Ã½ log theo táº§ng
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-security-considerations-can-nhac-bao-mat-cho-backend">
<span class="md-ellipsis">
      14. Security Considerations â€“ CÃ¢n nháº¯c báº£o máº­t cho Backend
    </span>
</a>
<nav aria-label="14. Security Considerations â€“ CÃ¢n nháº¯c báº£o máº­t cho Backend" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#nguyen-tac-cot-loi_1">
<span class="md-ellipsis">
      ğŸ” NguyÃªn táº¯c cá»‘t lÃµi
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#input-validation-sanity-check">
<span class="md-ellipsis">
      ğŸ§ª Input validation &amp; Sanity Check
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#quan-ly-secret-cau-hinh-an-toan">
<span class="md-ellipsis">
      ğŸ” Quáº£n lÃ½ secret &amp; cáº¥u hÃ¬nh an toÃ n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#token-phan-quyen">
<span class="md-ellipsis">
      ğŸ“¦ Token &amp; phÃ¢n quyá»n
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#owasp-api-security-cac-lo-hong-can-e-phong">
<span class="md-ellipsis">
      ğŸ“› OWASP API Security â€“ CÃ¡c lá»— há»•ng cáº§n Ä‘á» phÃ²ng
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#logging-auditing">
<span class="md-ellipsis">
      ğŸ§¯ Logging &amp; Auditing
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#15-performance-tips-toi-uu-hieu-nang-backend">
<span class="md-ellipsis">
      15. Performance Tips â€“ Tá»‘i Æ°u hiá»‡u nÄƒng Backend
    </span>
</a>
<nav aria-label="15. Performance Tips â€“ Tá»‘i Æ°u hiá»‡u nÄƒng Backend" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#truy-van-db-hieu-qua">
<span class="md-ellipsis">
      ğŸ“¥ Truy váº¥n DB hiá»‡u quáº£
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#caching-neu-can-thiet">
<span class="md-ellipsis">
      ğŸ“¤ Caching náº¿u cáº§n thiáº¿t
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#toi-uu-luong-xu-ly">
<span class="md-ellipsis">
      ğŸª„ Tá»‘i Æ°u luá»“ng xá»­ lÃ½
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#giam-thieu-io-blocking">
<span class="md-ellipsis">
      ğŸ§® Giáº£m thiá»ƒu I/O Blocking
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#o-luong-va-theo-doi">
<span class="md-ellipsis">
      ğŸ§ª Äo lÆ°á»ng vÃ  theo dÃµi
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="backend-dev-guide-dx-vas">ğŸ› ï¸ Backend Dev Guide â€“ dx-vas<a class="headerlink" href="#backend-dev-guide-dx-vas" title="Permanent link">Â¶</a></h1>
<p>TÃ i liá»‡u nÃ y dÃ nh cho láº­p trÃ¬nh viÃªn backend trong há»‡ thá»‘ng dx-vas. Má»¥c tiÃªu lÃ  cung cáº¥p quy chuáº©n vÃ  hÆ°á»›ng dáº«n chi tiáº¿t vá» cÃ¡ch phÃ¡t triá»ƒn service backend: cáº¥u trÃºc thÆ° má»¥c, phÃ¢n táº§ng logic, xá»­ lÃ½ nghiá»‡p vá»¥, viáº¿t test, vÃ  thá»±c thi cÃ¡c tiÃªu chuáº©n cháº¥t lÆ°á»£ng code.</p>
<hr/>
<h2 id="muc-luc">Má»¥c lá»¥c<a class="headerlink" href="#muc-luc" title="Permanent link">Â¶</a></h2>
<ol>
<li><a href="#1-pháº¡m-vi--nguyÃªn-táº¯c">Pháº¡m vi &amp; nguyÃªn táº¯c</a></li>
<li><a href="#2-cáº¥u-trÃºc-thÆ°-má»¥c-backend-chuáº©n">Cáº¥u trÃºc thÆ° má»¥c backend chuáº©n</a></li>
<li><a href="#3-phÃ¢n-táº§ng-logic--vai-trÃ²">PhÃ¢n táº§ng logic &amp; vai trÃ²</a></li>
<li><a href="#4-Ä‘áº·t-tÃªn--convention-code">Äáº·t tÃªn &amp; convention code</a></li>
<li><a href="#5-xá»­-lÃ½-nghiá»‡p-vá»¥--usecase-máº«u">Xá»­ lÃ½ nghiá»‡p vá»¥ &amp; usecase máº«u</a></li>
<li><a href="#6-schema--validation-pydantic">Schema &amp; validation (Pydantic)</a></li>
<li><a href="#7-xá»­-lÃ½-lá»—i--thÃ´ng-bÃ¡o">Xá»­ lÃ½ lá»—i &amp; thÃ´ng bÃ¡o</a></li>
<li><a href="#8-repository--truy-xuáº¥t-dá»¯-liá»‡u">Repository &amp; truy xuáº¥t dá»¯ liá»‡u</a></li>
<li><a href="#9-pubsub-subscriber--idempotency">Pub/Sub subscriber &amp; idempotency</a></li>
<li><a href="#10-test-Ä‘Æ¡n-vá»‹--tÃ­ch-há»£p">Test Ä‘Æ¡n vá»‹ &amp; tÃ­ch há»£p</a></li>
<li><a href="#11-checklist-khi-táº¡o-pr-backend">Checklist khi táº¡o PR backend</a></li>
<li><a href="#12-tÃ i-liá»‡u-liÃªn-quan">TÃ i liá»‡u liÃªn quan</a></li>
<li><a href="#13-logging-best-practices">Logging Best Practices</a></li>
<li><a href="#14-security-considerations--cÃ¢n-nháº¯c-báº£o-máº­t-cho-backend">Security Considerations â€“ CÃ¢n nháº¯c báº£o máº­t cho Backend</a></li>
<li><a href="#15-performance-tips--tá»‘i-Æ°u-hiá»‡u-nÄƒng-backend">Performance Tips â€“ Tá»‘i Æ°u hiá»‡u nÄƒng Backend</a></li>
</ol>
<hr/>
<h2 id="1-pham-vi-nguyen-tac">1. Pháº¡m vi &amp; nguyÃªn táº¯c<a class="headerlink" href="#1-pham-vi-nguyen-tac" title="Permanent link">Â¶</a></h2>
<p>TÃ i liá»‡u nÃ y dÃ nh riÃªng cho cÃ¡c thÃ nh viÃªn phÃ¡t triá»ƒn backend trong há»‡ thá»‘ng dx-vas â€“ nÆ¡i má»i service backend Ä‘Æ°á»£c viáº¿t theo kiáº¿n trÃºc microservice, má»—i service lÃ  1 repo riÃªng biá»‡t (multi-repo), triá»ƒn khai qua Cloud Run.</p>
<h3 id="muc-tieu">Má»¥c tiÃªu<a class="headerlink" href="#muc-tieu" title="Permanent link">Â¶</a></h3>
<p>HÆ°á»›ng dáº«n láº­p trÃ¬nh viÃªn backend phÃ¡t triá»ƒn service trong há»‡ thá»‘ng dx_vas má»™t cÃ¡ch nháº¥t quÃ¡n, báº£o máº­t, dá»… má»Ÿ rá»™ng vÃ  dá»… báº£o trÃ¬.</p>
<h3 id="pham-vi-ap-dung">Pháº¡m vi Ã¡p dá»¥ng<a class="headerlink" href="#pham-vi-ap-dung" title="Permanent link">Â¶</a></h3>
<ul>
<li>Táº¥t cáº£ cÃ¡c backend service viáº¿t báº±ng Python 3.11+ (FastAPI + SQLAlchemy + Pydantic)</li>
<li>Cáº¥u trÃºc dá»±a trÃªn mÃ´ hÃ¬nh microservice (multi-repo)</li>
</ul>
<h3 id="nguyen-tac-cot-loi">NguyÃªn táº¯c cá»‘t lÃµi<a class="headerlink" href="#nguyen-tac-cot-loi" title="Permanent link">Â¶</a></h3>
<ul>
<li>Separation of concerns: tÃ¡ch biá»‡t rÃµ tá»«ng táº§ng (Handler â€“ Service â€“ Repo)</li>
<li>Äáº£m báº£o <strong>idempotency</strong> vÃ  <strong>transactional consistency</strong> cho cÃ¡c nghiá»‡p vá»¥</li>
<li>Response chuáº©n hÃ³a theo envelope (meta + data / error)</li>
<li>Service khÃ´ng raise HTTPException | chá»‰ raise DomainError</li>
<li>Schema rÃµ rÃ ng: phÃ¢n biá»‡t DTO (schema), model (ORM), entity (náº¿u cÃ³)</li>
<li>PhÃ¢n quyá»n theo RBAC Ä‘á»™ng â€“ backend chá»‰ nháº­n <code>X-Permissions</code></li>
<li><strong>Security by Design</strong>: má»i input Ä‘á»u pháº£i validate â€“ ká»ƒ cáº£ event ná»™i bá»™</li>
<li><strong>Context</strong>: phÃ¢n biá»‡t rÃµ DTO, ORM model, user context (vai trÃ² ngÆ°á»i dÃ¹ng, Ä‘iá»u kiá»‡n RBAC), vÃ  request context (trace_id, source_ip...)</li>
</ul>
<p>ğŸ“Œ LÆ°u Ã½: Service khÃ´ng phá»¥ thuá»™c gateway â€“ cÃ³ thá»ƒ test Ä‘á»™c láº­p</p>
<p>ğŸ“ TÃ i liá»‡u nÃ y khÃ´ng láº·p láº¡i CI/CD hay cáº¥u trÃºc repo (Ä‘Ã£ cÃ³ á»Ÿ Dev Guide), mÃ  táº­p trung vÃ o:
- Usecase backend (handlers, service, repo)
- Convention phÃ¢n táº§ng
- Test vÃ  best practice</p>
<hr/>
<h2 id="2-cau-truc-thu-muc-backend-chuan">2. Cáº¥u trÃºc thÆ° má»¥c backend chuáº©n<a class="headerlink" href="#2-cau-truc-thu-muc-backend-chuan" title="Permanent link">Â¶</a></h2>
<p>Táº¥t cáº£ cÃ¡c service backend trong dx-vas nÃªn tuÃ¢n theo cáº¥u trÃºc thÆ° má»¥c chuáº©n dÆ°á»›i Ä‘Ã¢y Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n vÃ  dá»… báº£o trÃ¬:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>app/
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>â”œâ”€â”€ api/              # Router, route handler (FastAPI)
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>â”‚   â””â”€â”€ v1/
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>â”‚       â””â”€â”€ user.py   # Endpoint Ä‘á»‹nh nghÄ©a HTTP
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>â”œâ”€â”€ schemas/          # Pydantic schema (request, response)
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>â”‚   â””â”€â”€ user.py
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>â”œâ”€â”€ services/         # Business logic (Usecase Layer)
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>â”‚   â””â”€â”€ user\_service.py
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>â”œâ”€â”€ repositories/     # Truy cáº­p DB, ORM / SQL
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>â”‚   â””â”€â”€ user\_repo.py
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>â”œâ”€â”€ models/           # SQLAlchemy model (DB mapping)
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>â”‚   â””â”€â”€ user.py
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>â”œâ”€â”€ core/             # Cáº¥u hÃ¬nh, DI, security
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>â”‚   â”œâ”€â”€ config.py
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>â”‚   â””â”€â”€ security.py
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>â”œâ”€â”€ events/           # Xá»­ lÃ½ Pub/Sub
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>â”‚   â”œâ”€â”€ subscriber/   # Nháº­n sá»± kiá»‡n, xá»­ lÃ½
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>â”‚   â””â”€â”€ publisher/    # Gá»­i sá»± kiá»‡n Ä‘i
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>â”œâ”€â”€ deps.py           # Dependency Injection (DB, current\_user...)
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>â””â”€â”€ main.py           # Entry point FastAPI
</span></code></pre></div>
<h3 id="mot-so-quy-uoc-chung">ğŸ“Œ Má»™t sá»‘ quy Æ°á»›c chung<a class="headerlink" href="#mot-so-quy-uoc-chung" title="Permanent link">Â¶</a></h3>
<ul>
<li><code>services/</code> chá»‰ chá»©a logic nghiá»‡p vá»¥, khÃ´ng gá»i trá»±c tiáº¿p DB hay HTTP</li>
<li><code>repositories/</code> lÃ  lá»›p duy nháº¥t tÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p vá»›i DB</li>
<li><code>schemas/</code> chá»‰ dÃ¹ng cho request/response â€“ khÃ´ng dÃ¹ng lÃ m entity hoáº·c DB model</li>
<li><code>events/</code> cÃ³ thá»ƒ chia nhá» thÃ nh <code>subscriber/</code>, <code>publisher/</code> náº¿u cáº§n</li>
</ul>
<h3 id="goi-y">ğŸ“ Gá»£i Ã½<a class="headerlink" href="#goi-y" title="Permanent link">Â¶</a></h3>
<ul>
<li>Náº¿u service cÃ³ pháº§n xá»­ lÃ½ RBAC riÃªng â†’ cÃ³ thá»ƒ thÃªm <code>rbac/</code></li>
<li>Náº¿u cáº§n chia nhá» service lá»›n (VD: SIS Adapter) â†’ chia thÃ nh module theo domain (<code>student/</code>, <code>classroom/</code>, <code>fee/</code>)</li>
</ul>
<h3 id="quan-ly-dependency-depspy">ğŸ”§ Quáº£n lÃ½ Dependency (deps.py)<a class="headerlink" href="#quan-ly-dependency-depspy" title="Permanent link">Â¶</a></h3>
<p>Táº­p tin <code>deps.py</code> lÃ  nÆ¡i Ä‘á»‹nh nghÄ©a cÃ¡c <strong>provider function</strong> Ä‘á»ƒ inject dependency nhÆ° <code>db_session</code>, <code>current_user</code>, hoáº·c <code>service instance</code> vÃ o cÃ¡c route.</p>
<p>VÃ­ dá»¥:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="k">yield</span> <span class="n">session</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_service</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">UserService</span><span class="p">:</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">UserRepo</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
</span></code></pre></div>
<blockquote>
<p>ğŸ“ TÃ¡ch riÃªng cÃ¡c provider vÃ o deps.py giÃºp dá»… tÃ¡i sá»­ dá»¥ng, test vÃ  thay tháº¿ (mock).</p>
</blockquote>
<hr/>
<h2 id="3-phan-tang-logic-vai-tro">3. PhÃ¢n táº§ng logic &amp; vai trÃ²<a class="headerlink" href="#3-phan-tang-logic-vai-tro" title="Permanent link">Â¶</a></h2>
<p>dx-vas Ã¡p dá»¥ng mÃ´ hÃ¬nh <strong>3-layer architecture</strong> cho backend, nháº±m tÃ¡ch biá»‡t rÃµ rÃ ng giá»¯a:</p>
<ol>
<li><strong>Presentation Layer (API Handler)</strong> â€“ tiáº¿p nháº­n request tá»« client</li>
<li><strong>Service Layer (Usecase)</strong> â€“ xá»­ lÃ½ logic nghiá»‡p vá»¥</li>
<li><strong>Data Layer (Repository)</strong> â€“ truy xuáº¥t dá»¯ liá»‡u tá»« DB hoáº·c bÃªn thá»© ba</li>
</ol>
<hr/>
<h3 id="tang-1-api-handler-appapi">ğŸ§± Táº§ng 1: API Handler (<code>app/api/</code>)<a class="headerlink" href="#tang-1-api-handler-appapi" title="Permanent link">Â¶</a></h3>
<ul>
<li>NÆ¡i Ä‘á»‹nh nghÄ©a cÃ¡c route, sá»­ dá»¥ng FastAPI router</li>
<li>Gá»i service layer, validate input, tráº£ response</li>
<li>KhÃ´ng chá»©a logic nghiá»‡p vá»¥ hoáº·c xá»­ lÃ½ dá»¯ liá»‡u phá»©c táº¡p</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>\<span class="s2">"/users/</span><span class="si">{id}</span><span class="se">\"</span><span class="s2">, response_model=UserOut)</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">user_svc</span><span class="p">:</span> <span class="n">UserService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_user_service</span><span class="p">)):</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>    <span class="k">return</span> <span class="n">user_svc</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="ghi-chu-ve-dependency">ğŸ“ Ghi chÃº vá» Dependency<a class="headerlink" href="#ghi-chu-ve-dependency" title="Permanent link">Â¶</a></h4>
<p>Biáº¿n <code>user_svc: UserService = Depends(get_user_service)</code> sá»­ dá»¥ng Dependency Injection (DI) cá»§a FastAPI. HÃ m <code>get_user_service</code> thÆ°á»ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># deps.py</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_service</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">UserService</span><span class="p">:</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">UserRepo</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="k">return</span> <span class="n">UserService</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span></code></pre></div>
<blockquote>
<p>âœ… Äiá»u nÃ y giÃºp tÃ¡ch rÃµ logic khá»Ÿi táº¡o vÃ  inject cÃ¡c thÃ nh pháº§n nhÆ° session, repository, vÃ  service â€“ há»— trá»£ test vÃ  maintain dá»… dÃ ng.</p>
</blockquote>
<hr/>
<h3 id="tang-2-service-layer-appservices">âš™ï¸ Táº§ng 2: Service Layer (<code>app/services/</code>)<a class="headerlink" href="#tang-2-service-layer-appservices" title="Permanent link">Â¶</a></h3>
<ul>
<li>NÆ¡i xá»­ lÃ½ toÃ n bá»™ logic nghiá»‡p vá»¥: validate rule, xá»­ lÃ½ business exception, gá»i repository</li>
<li>ÄÆ°á»£c test riÃªng báº±ng unit test</li>
<li>KhÃ´ng gá»i trá»±c tiáº¿p HTTP, DB, FastAPI context</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_repo</span><span class="p">:</span> <span class="n">UserRepo</span><span class="p">):</span>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">user_repo</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserOut</span><span class="p">:</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="k">raise</span> <span class="n">UserNotFound</span><span class="p">()</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>        <span class="k">return</span> <span class="n">user</span>
</span></code></pre></div>
<hr/>
<h3 id="tang-3-repository-layer-apprepositories">ğŸ—ƒï¸ Táº§ng 3: Repository Layer (<code>app/repositories/</code>)<a class="headerlink" href="#tang-3-repository-layer-apprepositories" title="Permanent link">Â¶</a></h3>
<ul>
<li>TÆ°Æ¡ng tÃ¡c vá»›i DB qua SQLAlchemy / SQLModel</li>
<li>LÃ  nÆ¡i duy nháº¥t Ä‘Æ°á»£c gá»i DB query trá»±c tiáº¿p</li>
<li>CÃ³ thá»ƒ chia nhá» theo entity</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserRepo</span><span class="p">:</span>
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span></code></pre></div>
<hr/>
<h3 id="luu-y-bo-sung">ğŸ’¡ LÆ°u Ã½ bá»• sung<a class="headerlink" href="#luu-y-bo-sung" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>ThÃ nh pháº§n</th>
<th>ÄÆ°á»£c phÃ©p gá»i</th>
<th>KhÃ´ng Ä‘Æ°á»£c gá»i</th>
</tr>
</thead>
<tbody>
<tr>
<td>Handler</td>
<td>Service, Schema</td>
<td>Repo, Model</td>
</tr>
<tr>
<td>Service</td>
<td>Repo, Schema</td>
<td>Handler, DB</td>
</tr>
<tr>
<td>Repo</td>
<td>Model</td>
<td>Schema, Service</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… MÃ´ hÃ¬nh nÃ y giÃºp dá»… test, dá»… refactor, vÃ  dá»… scale tá»«ng táº§ng khi cáº§n.</p>
<p>ğŸ“ Service Layer nÃªn tráº£ vá» DTO (Pydantic Schema), khÃ´ng tráº£ trá»±c tiáº¿p SQLAlchemy model.  </p>
<p>Äiá»u nÃ y giÃºp API Handler tÃ¡ch biá»‡t khá»i ORM logic vÃ  tÄƒng kháº£ nÄƒng test.</p>
<p>ğŸ“Œ Náº¿u usecase nghiá»‡p vá»¥ yÃªu cáº§u nhiá»u bÆ°á»›c (update + audit + gá»­i event), hÃ£y cÃ¢n nháº¯c tá»• chá»©c thÃ nh context hoáº·c pattern Unit of Work Ä‘á»ƒ Ä‘áº£m báº£o rollback Ä‘á»“ng bá»™ náº¿u cÃ³ lá»—i.</p>
</blockquote>
<hr/>
<h3 id="so-o-kien-truc-3-layer-luong-xu-ly-ien-hinh-trong-mot-backend-service">ğŸ“Š SÆ¡ Ä‘á»“ kiáº¿n trÃºc 3-layer â€“ luá»“ng xá»­ lÃ½ Ä‘iá»ƒn hÃ¬nh trong má»™t backend service<a class="headerlink" href="#so-o-kien-truc-3-layer-luong-xu-ly-ien-hinh-trong-mot-backend-service" title="Permanent link">Â¶</a></h3>
<pre class="mermaid"><code>flowchart LR
  subgraph Client Request
    UI[API Client / Gateway]
  end

  subgraph FastAPI App
    UI --&gt; Handler[API Handler - Router]
    Handler --&gt; Service[Service Layer]
    Service --&gt; Repo[Repository Layer]
    Repo --&gt; DB[Database]
  end

  subgraph External
    Service --&gt; PubSub[Pub/Sub]
    Service --&gt; Redis[Cache]
    Service --&gt; NotiAPI[Notification Service]
  end

  classDef main fill:#e8f0fe,stroke:#4285f4,stroke-width:1px;
  class Handler,Service,Repo main
</code></pre>
<p>ğŸ“Œ SÆ¡ Ä‘á»“ mÃ´ táº£ rÃµ flow xá»­ lÃ½ tá»« API Gateway â†’ Handler â†’ Service â†’ Repo â†’ DB
CÃ¡c call phá»¥ nhÆ° Pub/Sub, Cache, hoáº·c Notification thÆ°á»ng xuáº¥t phÃ¡t tá»« Service Layer.</p>
<h3 id="goi-y-nang-cao-unit-of-work-uow">ğŸ’¡ Gá»£i Ã½ nÃ¢ng cao â€“ Unit of Work (UoW)<a class="headerlink" href="#goi-y-nang-cao-unit-of-work-uow" title="Permanent link">Â¶</a></h3>
<p>Khi usecase bao gá»“m nhiá»u bÆ°á»›c quan trá»ng (VD: cáº­p nháº­t há»c sinh, ghi audit, gá»­i thÃ´ng bÃ¡o), nÃªn gÃ³i cÃ¡c hÃ nh Ä‘á»™ng nÃ y trong má»™t context hoáº·c pattern "Unit of Work" Ä‘á»ƒ Ä‘áº£m báº£o rollback Ä‘á»“ng bá»™ náº¿u cÃ³ lá»—i:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentUoW</span><span class="p">:</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">student_repo</span> <span class="o">=</span> <span class="n">StudentRepo</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">audit_repo</span> <span class="o">=</span> <span class="n">AuditRepo</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="__span-6-6"><a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>
</span><span id="__span-6-7"><a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-8"><a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-6-9"><a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>
</span><span id="__span-6-10"><a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-6-11"><a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-6-12"><a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>
</span><span id="__span-6-13"><a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="c1"># Trong service</span>
</span><span id="__span-6-14"><a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_student_and_audit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">StudentUpdateIn</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">StudentUoW</span><span class="p">):</span>
</span><span id="__span-6-15"><a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>    <span class="n">student</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">student_repo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span id="__span-6-16"><a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>    <span class="n">uow</span><span class="o">.</span><span class="n">audit_repo</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"Cáº­p nháº­t HS"</span><span class="p">,</span> <span class="n">student</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-6-17"><a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a>    <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></code></pre></div>
<p>ğŸ“Œ UoW pattern giÃºp gom logic nghiá»‡p vá»¥ Ä‘a bÆ°á»›c vÃ o má»™t transaction duy nháº¥t, vÃ  giáº£m rá»§i ro bá» sÃ³t commit hoáº·c rollback.</p>
<hr/>
<h2 id="4-at-ten-convention-code">4. Äáº·t tÃªn &amp; convention code<a class="headerlink" href="#4-at-ten-convention-code" title="Permanent link">Â¶</a></h2>
<p>Viá»‡c Ä‘áº·t tÃªn rÃµ rÃ ng, nháº¥t quÃ¡n giÃºp code dá»… Ä‘á»c, dá»… review vÃ  dá»… báº£o trÃ¬. dx-vas sá»­ dá»¥ng convention theo kiá»ƒu <strong>snake_case cho file/biáº¿n</strong>, <strong>CamelCase cho class</strong>, vÃ  <strong>lowercase-with-dash cho route</strong>.</p>
<hr/>
<h3 id="ten-file-thu-muc">ğŸ“ TÃªn file &amp; thÆ° má»¥c<a class="headerlink" href="#ten-file-thu-muc" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Loáº¡i</th>
<th>Quy táº¯c</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>ThÆ° má»¥c module</td>
<td>snake_case</td>
<td><code>user_service/</code>, <code>classroom/</code></td>
</tr>
<tr>
<td>File schema</td>
<td>snake_case</td>
<td><code>user.py</code>, <code>role.py</code></td>
</tr>
<tr>
<td>File repo/service</td>
<td>snake_case</td>
<td><code>user_repo.py</code>, <code>user_service.py</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ“ Náº¿u microservice cÃ³ nhiá»u domain (VD: SIS Adapter) â†’ nÃªn chia theo module con:<br/>
<code>app/student/schemas/</code>, <code>app/student/services/</code>, <code>app/student/repositories/</code><br/>
Khi Ä‘Ã³, má»—i module sáº½ cÃ³ thÆ° má»¥c <code>services/</code>, <code>schemas/</code> riÃªng thay vÃ¬ dÃ¹ng thÆ° má»¥c cáº¥p cao.</p>
</blockquote>
<hr/>
<h3 id="ten-class">ğŸ”¤ TÃªn class<a class="headerlink" href="#ten-class" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Loáº¡i</th>
<th>Quy táº¯c</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pydantic schema</td>
<td>CamelCase</td>
<td><code>UserCreate</code>, <code>RoleOut</code></td>
</tr>
<tr>
<td>Service</td>
<td>CamelCase</td>
<td><code>UserService</code>, <code>PermissionService</code></td>
</tr>
<tr>
<td>SQLAlchemy model</td>
<td>CamelCase</td>
<td><code>User</code>, <code>Classroom</code></td>
</tr>
<tr>
<td>Exception</td>
<td>CamelCase + <code>Error</code></td>
<td><code>UserNotFoundError</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="at-ten-route-api-path">ğŸŒ Äáº·t tÃªn route (API path)<a class="headerlink" href="#at-ten-route-api-path" title="Permanent link">Â¶</a></h3>
<ul>
<li>Lowercase, ná»‘i báº±ng <code>-</code>, dÃ¹ng danh tá»«</li>
<li>PhiÃªn báº£n hÃ³a báº±ng prefix <code>/v1</code></li>
<li>HÃ nh Ä‘á»™ng thá»ƒ hiá»‡n qua method: GET/POST/PATCH/DELETE</li>
</ul>
<table>
<thead>
<tr>
<th>Má»¥c tiÃªu</th>
<th>Method</th>
<th>Route</th>
</tr>
</thead>
<tbody>
<tr>
<td>Láº¥y user</td>
<td>GET</td>
<td><code>/v1/users/{id}</code></td>
</tr>
<tr>
<td>Táº¡o má»›i user</td>
<td>POST</td>
<td><code>/v1/users</code></td>
</tr>
<tr>
<td>Cáº­p nháº­t user</td>
<td>PATCH</td>
<td><code>/v1/users/{id}</code></td>
</tr>
<tr>
<td>XoÃ¡ user</td>
<td>DELETE</td>
<td><code>/v1/users/{id}</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="ten-bien-ham">ğŸ’¬ TÃªn biáº¿n &amp; hÃ m<a class="headerlink" href="#ten-bien-ham" title="Permanent link">Â¶</a></h3>
<ul>
<li>snake_case cho biáº¿n, hÃ m, argument</li>
<li>TÃªn nÃªn rÃµ rÃ ng, khÃ´ng viáº¿t táº¯t khÃ³ hiá»ƒu</li>
</ul>
<table>
<thead>
<tr>
<th>KhÃ´ng nÃªn</th>
<th>NÃªn dÃ¹ng</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>u</code>, <code>res</code></td>
<td><code>user</code>, <code>response</code></td>
</tr>
<tr>
<td><code>get()</code></td>
<td><code>get_user_by_id()</code></td>
</tr>
<tr>
<td><code>svc</code></td>
<td><code>user_service</code></td>
</tr>
</tbody>
</table>
<hr/>
<p>ğŸ“ Tham kháº£o convention PEP8 + Black formatting (auto format Ä‘Æ°á»£c trong CI/CD).</p>
<hr/>
<h2 id="5-xu-ly-nghiep-vu-usecase-mau">5. Xá»­ lÃ½ nghiá»‡p vá»¥ &amp; usecase máº«u<a class="headerlink" href="#5-xu-ly-nghiep-vu-usecase-mau" title="Permanent link">Â¶</a></h2>
<p>Táº§ng Service (Usecase Layer) lÃ  nÆ¡i xá»­ lÃ½ logic nghiá»‡p vá»¥ chÃ­nh trong má»—i service. CÃ¡c class á»Ÿ táº§ng nÃ y cáº§n Ä‘á»™c láº­p vá»›i framework (FastAPI, SQLAlchemy...) vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c test Ä‘Æ¡n láº».</p>
<hr/>
<h3 id="mot-usecase-mau-cap-nhat-thong-tin-hoc-sinh">ğŸ§© Má»™t usecase máº«u â€“ Cáº­p nháº­t thÃ´ng tin há»c sinh<a class="headerlink" href="#mot-usecase-mau-cap-nhat-thong-tin-hoc-sinh" title="Permanent link">Â¶</a></h3>
<p>Giáº£ sá»­ route PATCH <code>/students/{id}</code> nháº­n thÃ´ng tin cáº­p nháº­t vÃ  gá»i Ä‘áº¿n táº§ng Service nhÆ° sau:</p>
<h4 id="1-schema-au-vao-schemasstudentpy">1. Schema Ä‘áº§u vÃ o (<code>schemas/student.py</code>)<a class="headerlink" href="#1-schema-au-vao-schemasstudentpy" title="Permanent link">Â¶</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="n">birthday</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
</span></code></pre></div>
<h4 id="2-api-handler-apiv1studentpy">2. API Handler (<code>api/v1/student.py</code>)<a class="headerlink" href="#2-api-handler-apiv1studentpy" title="Permanent link">Â¶</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@router</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>\<span class="s2">"/students/</span><span class="si">{id}</span><span class="se">\"</span><span class="s2">, response_model=StudentOut)</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_student</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">StudentUpdate</span><span class="p">,</span> <span class="n">svc</span><span class="p">:</span> <span class="n">StudentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_service</span><span class="p">)):</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="k">return</span> <span class="n">svc</span><span class="o">.</span><span class="n">update_student</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="3-service-servicesstudent_servicepy">3. Service (<code>services/student_service.py</code>)<a class="headerlink" href="#3-service-servicesstudent_servicepy" title="Permanent link">Â¶</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentService</span><span class="p">:</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">StudentRepo</span><span class="p">):</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_student</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">StudentUpdate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StudentOut</span><span class="p">:</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>        <span class="n">student</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">student</span><span class="p">:</span>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>            <span class="k">raise</span> <span class="n">StudentNotFoundError</span><span class="p">()</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>        <span class="n">student</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">student</span><span class="o">.</span><span class="n">name</span>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>        <span class="n">student</span><span class="o">.</span><span class="n">birthday</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">birthday</span> <span class="ow">or</span> <span class="n">student</span><span class="o">.</span><span class="n">birthday</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>        <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>        <span class="k">return</span> <span class="n">StudentOut</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="4-repository-repositoriesstudent_repopy">4. Repository (<code>repositories/student_repo.py</code>)<a class="headerlink" href="#4-repository-repositoriesstudent_repopy" title="Permanent link">Â¶</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># repositories/student_repo.py</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentRepo</span><span class="p">:</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Student</span><span class="p">]:</span>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>
</span><span id="__span-10-10"><a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student</span><span class="p">:</span> <span class="n">Student</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Student</span><span class="p">:</span>
</span><span id="__span-10-11"><a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
</span><span id="__span-10-12"><a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>        <span class="k">return</span> <span class="n">student</span>
</span></code></pre></div>
<p>ğŸ“ Repo chá»‰ nÃªn thá»±c hiá»‡n add() hoáº·c update() vÃ  khÃ´ng gá»i commit() â€“ viá»‡c commit/rollback sáº½ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi get_db() hoáº·c unit-of-work á»Ÿ táº§ng trÃªn.</p>
<hr/>
<h3 id="ghi-nho-khi-viet-usecase">âœ… Ghi nhá»› khi viáº¿t usecase<a class="headerlink" href="#ghi-nho-khi-viet-usecase" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>YÃªu cáº§u</th>
<th>Giáº£i thÃ­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td>KhÃ´ng gá»i trá»±c tiáº¿p DB trong service</td>
<td>LuÃ´n qua repository</td>
</tr>
<tr>
<td>KhÃ´ng xá»­ lÃ½ response trong service</td>
<td>Service tráº£ object/data, khÃ´ng <code>JSONResponse</code></td>
</tr>
<tr>
<td>KhÃ´ng raise HTTPException trong service</td>
<td>Chá»‰ raise <code>domain error</code>, handler sáº½ map sang HTTP code</td>
</tr>
<tr>
<td>Logic ráº½ nhÃ¡nh nÃªn rÃµ rÃ ng</td>
<td>TrÃ¡nh if/else lá»“ng quÃ¡ sÃ¢u</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="luu-y-nang-cao-idempotency-cho-usecase-ong-bo">ğŸ” LÆ°u Ã½ nÃ¢ng cao: Idempotency cho usecase Ä‘á»“ng bá»™<a class="headerlink" href="#luu-y-nang-cao-idempotency-cho-usecase-ong-bo" title="Permanent link">Â¶</a></h3>
<p>Vá»›i cÃ¡c API <code>POST</code>, <code>PATCH</code> quan trá»ng (VD: táº¡o há»£p Ä‘á»“ng, gá»­i Ä‘Æ¡n), nÃªn cÃ¢n nháº¯c cho phÃ©p client gá»­i <code>Idempotency-Key</code> Ä‘á»ƒ trÃ¡nh xá»­ lÃ½ trÃ¹ng náº¿u retry. Service layer nÃªn kiá»ƒm tra key nÃ y trÆ°á»›c khi tiáº¿p tá»¥c.</p>
<p>ğŸ“Œ Náº¿u há»‡ thá»‘ng khÃ´ng dÃ¹ng Idempotency-Key, cÃ³ thá»ƒ dá»±a vÃ o unique constraint (VD: email há»c sinh) Ä‘á»ƒ Ä‘áº£m báº£o gá»i nhiá»u láº§n khÃ´ng gÃ¢y lá»—i hoáº·c xá»­ lÃ½ trÃ¹ng.</p>
<p>ğŸ“ Tham kháº£o máº«u toÃ n diá»‡n táº¡i: <a href="https://github.com/vas-org/dx-user-service"><code>dx-user-service</code></a></p>
<hr/>
<h2 id="6-schema-validation-pydantic">6. Schema &amp; validation (Pydantic)<a class="headerlink" href="#6-schema-validation-pydantic" title="Permanent link">Â¶</a></h2>
<p>Táº¥t cáº£ request/response Ä‘áº§u vÃ o ra cá»§a API trong dx-vas Ä‘á»u sá»­ dá»¥ng <strong>Pydantic schema</strong> Ä‘á»ƒ Ä‘áº£m báº£o type safety, validate dá»¯ liá»‡u vÃ  sinh tÃ i liá»‡u OpenAPI.</p>
<hr/>
<h3 id="phan-loai-schema">ğŸ“¦ PhÃ¢n loáº¡i schema<a class="headerlink" href="#phan-loai-schema" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Má»¥c Ä‘Ã­ch</th>
<th>Äáº·t tÃªn</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>Input tá»« request</td>
<td><code>*Create</code>, <code>*Update</code>, <code>*In</code></td>
<td><code>UserCreate</code>, <code>StudentUpdate</code></td>
</tr>
<tr>
<td>Output tráº£ vá»</td>
<td><code>*Out</code>, <code>*Response</code></td>
<td><code>UserOut</code>, <code>ScoreResponse</code></td>
</tr>
<tr>
<td>DB schema (tuá»³ chá»n)</td>
<td><code>*DB</code></td>
<td><code>UserDB</code></td>
</tr>
<tr>
<td>Schema ná»™i bá»™</td>
<td><code>*Payload</code>, <code>*Data</code></td>
<td><code>NotificationPayload</code></td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="vi-du-schema-student">âœ… VÃ­ dá»¥ schema â€“ Student<a class="headerlink" href="#vi-du-schema-student" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>    <span class="n">birthday</span><span class="p">:</span> <span class="n">date</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a>    <span class="n">class_id</span><span class="p">:</span> <span class="n">UUID</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentOut</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span>
</span><span id="__span-11-8"><a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-11-9"><a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="n">birthday</span><span class="p">:</span> <span class="n">date</span>
</span><span id="__span-11-10"><a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="n">class_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></code></pre></div>
<hr/>
<h3 id="custom-validator-vi-du">ğŸ§ª Custom validator vÃ­ dá»¥<a class="headerlink" href="#custom-validator-vi-du" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="n">birthday</span><span class="p">:</span> <span class="n">date</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"TÃªn chá»‰ Ä‘Æ°á»£c chá»©a chá»¯ cÃ¡i"</span><span class="p">)</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span class="k">return</span> <span class="n">value</span>
</span></code></pre></div>
<p>ğŸ“ DÃ¹ng @validator khi cáº§n kiá»ƒm tra hoáº·c chuáº©n hÃ³a dá»¯ liá»‡u Ä‘áº§u vÃ o â€“ ráº¥t há»¯u Ã­ch cho rule nghiá»‡p vá»¥ nhÆ° kiá»ƒm tra Ä‘á»‹nh dáº¡ng mÃ£ há»c sinh, tÃªn khÃ´ng chá»©a sá»‘, v.v.</p>
<hr/>
<h3 id="luu-y-khi-dung-schema">âš ï¸ LÆ°u Ã½ khi dÃ¹ng schema<a class="headerlink" href="#luu-y-khi-dung-schema" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng <code>Field(...)</code> Ä‘á»ƒ validate field rÃµ rÃ ng</li>
<li>KhÃ´ng Ä‘áº·t default = None náº¿u field báº¯t buá»™c</li>
<li>KhÃ´ng dÃ¹ng schema output lÃ m model DB hoáº·c input</li>
<li>TrÃ¡nh schema quÃ¡ sÃ¢u/lá»“ng nhau phá»©c táº¡p â€“ nÃªn tÃ¡ch nhá»</li>
<li>Náº¿u <code>orm_mode = True</code> â†’ schema dÃ¹ng Ä‘Æ°á»£c <code>.from_orm(obj)</code></li>
</ul>
<hr/>
<h3 id="tips-nang-cao">ğŸ“ Tips nÃ¢ng cao<a class="headerlink" href="#tips-nang-cao" title="Permanent link">Â¶</a></h3>
<ul>
<li>CÃ³ thá»ƒ káº¿ thá»«a schema:</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span class="n">birthday</span><span class="p">:</span> <span class="n">date</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentCreate</span><span class="p">(</span><span class="n">StudentBase</span><span class="p">):</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="n">class_id</span><span class="p">:</span> <span class="n">UUID</span>
</span></code></pre></div>
<ul>
<li>TÃ¡ch riÃªng <code>PaginationMeta</code>, <code>ErrorEnvelope</code>... dÃ¹ng chung toÃ n há»‡ thá»‘ng táº¡i <code>schemas/common.py</code></li>
</ul>
<blockquote>
<p>ğŸ“ Náº¿u há»‡ thá»‘ng dÃ¹ng camelCase trong JSON response:
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="n">alias_generator</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="n">word</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">))</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="p">)</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>    <span class="n">allow_population_by_field_name</span> <span class="o">=</span> <span class="kc">True</span>
</span></code></pre></div></p>
</blockquote>
<hr/>
<p>ğŸ“ Schema chuáº©n cá»§a toÃ n há»‡ thá»‘ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a táº¡i:
<a href="https://github.com/vas-org/dx-service-template"><code>dx-service-template/schemas/common.py</code></a></p>
<hr/>
<h2 id="7-xu-ly-loi-thong-bao">7. Xá»­ lÃ½ lá»—i &amp; thÃ´ng bÃ¡o<a class="headerlink" href="#7-xu-ly-loi-thong-bao" title="Permanent link">Â¶</a></h2>
<p>dx-vas chuáº©n hoÃ¡ cÆ¡ cháº¿ xá»­ lÃ½ lá»—i Ä‘á»ƒ API consistent, dá»… debug vÃ  dá»… theo dÃµi log. Má»—i service Ä‘á»u tráº£ vá» lá»—i theo dáº¡ng <code>ErrorEnvelope</code> chuáº©n vÃ  sá»­ dá»¥ng exception theo tá»«ng táº§ng.</p>
<hr/>
<h3 id="cau-truc-loi-chuan">ğŸš§ Cáº¥u trÃºc lá»—i chuáº©n<a class="headerlink" href="#cau-truc-loi-chuan" title="Permanent link">Â¶</a></h3>
<div class="language-json highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="p">{</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USER_NOT_FOUND"</span><span class="p">,</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i"</span><span class="p">,</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="nt">"details"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">  </span><span class="nt">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="nt">"request_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc-xyz-123"</span><span class="p">,</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="nt">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2025-06-01T12:00:00Z"</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="p">}</span>
</span></code></pre></div>
<hr/>
<h3 id="phan-tang-xu-ly-loi">ğŸ’¢ PhÃ¢n táº§ng xá»­ lÃ½ lá»—i<a class="headerlink" href="#phan-tang-xu-ly-loi" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Táº§ng</th>
<th>Loáº¡i exception</th>
<th>VÃ­ dá»¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>API (router)</td>
<td>HTTPException, 422</td>
<td>FastAPI sáº½ auto catch</td>
</tr>
<tr>
<td>Service</td>
<td>DomainError</td>
<td><code>UserNotFoundError</code>, <code>InvalidScoreError</code></td>
</tr>
<tr>
<td>Repo</td>
<td>Optional + catch DB error</td>
<td><code>SQLAlchemyError</code>, rollback</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="base-error-dung-chung">ğŸ§± Base error dÃ¹ng chung<a class="headerlink" href="#base-error-dung-chung" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DomainError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">400</span><span class="p">):</span>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a>    <span class="n">code</span> <span class="o">=</span> \<span class="s2">"UNSPECIFIED_ERROR</span><span class="se">\"</span>
</span><span id="__span-16-8"><a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a>    <span class="n">message</span> <span class="o">=</span> \<span class="s2">"CÃ³ lá»—i xáº£y ra</span><span class="se">\"</span>
</span><span id="__span-16-9"><a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a>
</span><span id="__span-16-10"><a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-16-11"><a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span>
</span><span id="__span-16-12"><a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a>
</span><span id="__span-16-13"><a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserNotFoundError</span><span class="p">(</span><span class="n">DomainError</span><span class="p">):</span>
</span><span id="__span-16-14"><a href="#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a>    <span class="n">code</span> <span class="o">=</span> \<span class="s2">"USER_NOT_FOUND</span><span class="se">\"</span>
</span><span id="__span-16-15"><a href="#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a>    <span class="n">message</span> <span class="o">=</span> \<span class="s2">"NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i</span><span class="se">\"</span>
</span></code></pre></div>
<p>Trong route handler:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">svc</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="k">except</span> <span class="n">DomainError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>        \<span class="s2">"code</span><span class="se">\"</span><span class="s2">: e.code,</span>
</span><span id="__span-17-6"><a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>        \<span class="s2">"message</span><span class="se">\"</span><span class="s2">: e.message,</span>
</span><span id="__span-17-7"><a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a>        \<span class="s2">"details</span><span class="se">\"</span><span class="s2">: e.detail</span>
</span><span id="__span-17-8"><a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a>    <span class="p">})</span>
</span></code></pre></div>
<hr/>
<h3 id="mapping-loi-ma-http">ğŸ” Mapping lá»—i â†’ mÃ£ HTTP<a class="headerlink" href="#mapping-loi-ma-http" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Domain Error</th>
<th>HTTP code</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NotFoundError</code></td>
<td>404</td>
</tr>
<tr>
<td><code>ValidationError</code></td>
<td>400</td>
</tr>
<tr>
<td><code>PermissionDenied</code></td>
<td>403</td>
</tr>
<tr>
<td><code>Conflict</code></td>
<td>409</td>
</tr>
<tr>
<td><code>InternalError</code></td>
<td>500</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… Service khÃ´ng Ä‘Æ°á»£c raise <code>HTTPException</code>, mÃ  chá»‰ raise domain-level error
ğŸ“Œ CÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a má»™t global exception handler trong FastAPI Ä‘á»ƒ tá»± Ä‘á»™ng map <code>DomainError</code> sang HTTPException vá»›i <code>ErrorEnvelope</code>, giÃºp code táº¡i route gá»n hÆ¡n:</p>
</blockquote>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">DomainError</span><span class="p">)</span>
</span><span id="__span-18-2"><a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_domain_error</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">DomainError</span><span class="p">):</span>
</span><span id="__span-18-3"><a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
</span><span id="__span-18-4"><a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="__span-18-5"><a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a>        <span class="n">content</span><span class="o">=</span><span class="n">ErrorEnvelope</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-18-6"><a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a>            <span class="s2">"code"</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
</span><span id="__span-18-7"><a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a>            <span class="s2">"message"</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
</span><span id="__span-18-8"><a href="#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a>        <span class="p">})</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
</span><span id="__span-18-9"><a href="#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a>    <span class="p">)</span>
</span></code></pre></div>
<hr/>
<p>ğŸ“ Máº«u <code>ErrorEnvelope</code>, <code>BaseError</code> cÃ³ sáºµn trong: <a href="https://github.com/vas-org/dx-service-template"><code>dx-service-template/schemas/common.py</code></a></p>
<hr/>
<h2 id="8-repository-truy-xuat-du-lieu">8. Repository &amp; truy xuáº¥t dá»¯ liá»‡u<a class="headerlink" href="#8-repository-truy-xuat-du-lieu" title="Permanent link">Â¶</a></h2>
<p>Repository lÃ  táº§ng duy nháº¥t tÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u. Má»¥c tiÃªu lÃ  tÃ¡ch biá»‡t logic nghiá»‡p vá»¥ khá»i chi tiáº¿t truy váº¥n SQL hoáº·c ORM.</p>
<hr/>
<h3 id="vai-tro-cua-repository">ğŸ“¦ Vai trÃ² cá»§a repository<a class="headerlink" href="#vai-tro-cua-repository" title="Permanent link">Â¶</a></h3>
<ul>
<li>Quáº£n lÃ½ session DB (commit, rollback)</li>
<li>TÆ°Æ¡ng tÃ¡c SQLAlchemy model</li>
<li>Tráº£ vá» entity/raw data, khÃ´ng map sang schema</li>
<li>CÃ³ thá»ƒ group theo domain (<code>student_repo.py</code>, <code>classroom_repo.py</code>)</li>
</ul>
<hr/>
<h3 id="mau-repository-studentrepo">ğŸ§± Máº«u repository â€“ StudentRepo<a class="headerlink" href="#mau-repository-studentrepo" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StudentRepo</span><span class="p">:</span>
</span><span id="__span-19-2"><a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
</span><span id="__span-19-3"><a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="__span-19-4"><a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a>
</span><span id="__span-19-5"><a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Student</span><span class="p">]:</span>
</span><span id="__span-19-6"><a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="__span-19-7"><a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a>
</span><span id="__span-19-8"><a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student</span><span class="p">:</span> <span class="n">Student</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Student</span><span class="p">:</span>
</span><span id="__span-19-9"><a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
</span><span id="__span-19-10"><a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a>        <span class="k">return</span> <span class="n">student</span>
</span><span id="__span-19-11"><a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a>
</span><span id="__span-19-12"><a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student</span><span class="p">:</span> <span class="n">Student</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Student</span><span class="p">:</span>
</span><span id="__span-19-13"><a href="#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a>        <span class="k">return</span> <span class="n">student</span>
</span><span id="__span-19-14"><a href="#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a>
</span><span id="__span-19-15"><a href="#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a>
</span><span id="__span-19-16"><a href="#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_by_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Student</span><span class="p">]:</span>
</span><span id="__span-19-17"><a href="#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">class_id</span> <span class="o">==</span> <span class="n">class_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></code></pre></div>
<hr/>
<h3 id="luu-y">ğŸ§¯ LÆ°u Ã½<a class="headerlink" href="#luu-y" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Quy táº¯c</th>
<th>Giáº£i thÃ­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td>KhÃ´ng tráº£ vá» Pydantic schema</td>
<td>Chá»‰ tráº£ vá» SQLAlchemy model</td>
</tr>
<tr>
<td>KhÃ´ng gá»i schema trong repo</td>
<td>Repo khÃ´ng biáº¿t gÃ¬ vá» táº§ng trÃªn</td>
</tr>
<tr>
<td>LuÃ´n kiá»ƒm soÃ¡t session commit</td>
<td>KhÃ´ng Ä‘á»ƒ service tá»± commit DB</td>
</tr>
<tr>
<td>Transaction nhiá»u bÆ°á»›c â†’ gÃ³i láº¡i báº±ng context hoáº·c unit of work</td>
<td>TrÃ¡nh lá»—i rollback thiáº¿u bÆ°á»›c</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="tao-session-db">ğŸ›  Táº¡o session DB<a class="headerlink" href="#tao-session-db" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>        <span class="k">yield</span> <span class="n">session</span>
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-20-8"><a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a>        <span class="k">raise</span>
</span><span id="__span-20-9"><a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-20-10"><a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></div>
<p>Trong service:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1"># Trong FastAPI handler</span>
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/students/</span><span class="si">{id}</span><span class="s2">"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">StudentOut</span><span class="p">)</span>
</span><span id="__span-21-3"><a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_student_api_handler</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">student_svc</span><span class="p">:</span> <span class="n">StudentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_student_service</span><span class="p">)):</span>
</span><span id="__span-21-4"><a href="#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a>    <span class="n">student</span> <span class="o">=</span> <span class="n">student_svc</span><span class="o">.</span><span class="n">get_student_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span id="__span-21-5"><a href="#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">student</span><span class="p">:</span>
</span><span id="__span-21-6"><a href="#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a>        <span class="k">raise</span> <span class="n">StudentNotFoundError</span><span class="p">()</span>
</span><span id="__span-21-7"><a href="#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a>    <span class="k">return</span> <span class="n">StudentOut</span><span class="o">.</span><span class="n">from_orm</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>
</span></code></pre></div>
<blockquote>
<p>ğŸ“ StudentService vÃ  StudentRepo nÃªn Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ´ng qua DI â€“ hoáº·c thÃ´ng qua hÃ m get_student_service() nhÆ° mÃ´ táº£ á»Ÿ Má»¥c 3.</p>
</blockquote>
<hr/>
<p>ğŸ“ DB schema â†’ xem <code>models/student.py</code></p>
<p>ğŸ“ Cáº¥u hÃ¬nh DB trong <code>core/config.py</code>, session á»Ÿ <code>deps.py</code></p>
<hr/>
<h2 id="9-pubsub-subscriber-idempotency">9. Pub/Sub subscriber &amp; idempotency<a class="headerlink" href="#9-pubsub-subscriber-idempotency" title="Permanent link">Â¶</a></h2>
<p>Má»™t sá»‘ service backend cá»§a dx-vas hoáº¡t Ä‘á»™ng theo mÃ´ hÃ¬nh event-driven â€“ nghÄ©a lÃ  nháº­n sá»± kiá»‡n tá»« cÃ¡c topic Pub/Sub vÃ  xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™. Viá»‡c Ä‘áº£m báº£o <strong>idempotency</strong> (xá»­ lÃ½ láº·p láº¡i khÃ´ng gÃ¢y lá»—i) lÃ  báº¯t buá»™c.</p>
<hr/>
<h3 id="cau-truc-thu-muc-goi-y">ğŸ“¦ Cáº¥u trÃºc thÆ° má»¥c gá»£i Ã½<a class="headerlink" href="#cau-truc-thu-muc-goi-y" title="Permanent link">Â¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>events/
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a>â”œâ”€â”€ subscriber/
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>â”‚   â””â”€â”€ user\_event\_handler.py
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a>â”œâ”€â”€ publisher/
</span><span id="__span-22-5"><a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>â”‚   â””â”€â”€ notify\_event.py
</span></code></pre></div>
<hr/>
<h3 id="viet-mot-subscriber-handler">ğŸ“¥ Viáº¿t má»™t subscriber handler<a class="headerlink" href="#viet-mot-subscriber-handler" title="Permanent link">Â¶</a></h3>
<blockquote>
<p>ğŸ“ Schema báº£ng <code>processed_messages</code>:
<div class="language-sql highlight"><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">processed_messages</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">  </span><span class="n">message_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-23-3"><a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">  </span><span class="n">processed_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
</span><span id="__span-23-4"><a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">'success'</span>
</span><span id="__span-23-5"><a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="p">);</span>
</span></code></pre></div></p>
</blockquote>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_user_created</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">PubSubMessage</span><span class="p">):</span>
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>    <span class="n">db_session_event</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
</span><span id="__span-24-3"><a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-24-4"><a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a>        <span class="n">repo</span> <span class="o">=</span> <span class="n">UserRepo</span><span class="p">(</span><span class="n">db_session_event</span><span class="p">)</span>
</span><span id="__span-24-5"><a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>
</span><span id="__span-24-6"><a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span>
</span><span id="__span-24-7"><a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a>
</span><span id="__span-24-8"><a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a>        <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">has_processed</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="p">):</span>
</span><span id="__span-24-9"><a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a>            <span class="k">return</span>
</span><span id="__span-24-10"><a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a>
</span><span id="__span-24-11"><a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a>        <span class="n">user</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span id="__span-24-12"><a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span id="__span-24-13"><a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a>            <span class="k">raise</span> <span class="n">UserNotFoundError</span><span class="p">()</span>
</span><span id="__span-24-14"><a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a>
</span><span id="__span-24-15"><a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a>        <span class="c1"># ... xá»­ lÃ½ sá»± kiá»‡n ...</span>
</span><span id="__span-24-16"><a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a>
</span><span id="__span-24-17"><a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a>        <span class="n">repo</span><span class="o">.</span><span class="n">mark_processed</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
</span><span id="__span-24-18"><a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a>        <span class="n">db_session_event</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-24-19"><a href="#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-24-20"><a href="#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a>        <span class="n">db_session_event</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-24-21"><a href="#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a>        <span class="k">raise</span>
</span><span id="__span-24-22"><a href="#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-24-23"><a href="#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a>        <span class="n">db_session_event</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></div>
<blockquote>
<p>âœ… Sá»­ dá»¥ng SessionLocal() riÃªng cho background worker, Ä‘áº£m báº£o quáº£n lÃ½ transaction tÃ¡ch biá»‡t vá»›i request.</p>
</blockquote>
<hr/>
<h3 id="idempotency-cach-am-bao">ğŸ§ª Idempotency: cÃ¡ch Ä‘áº£m báº£o<a class="headerlink" href="#idempotency-cach-am-bao" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Ká»¹ thuáº­t</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ghi log message Ä‘Ã£ xá»­ lÃ½</td>
<td>Táº¡o báº£ng <code>processed_messages(message_id)</code></td>
</tr>
<tr>
<td>TrÃ¡nh logic gÃ¢y side effect nhiá»u láº§n</td>
<td>Gá»­i noti 1 láº§n, táº¡o record 1 láº§n</td>
</tr>
<tr>
<td>Transaction toÃ n bá»™ handler</td>
<td>Commit/rollback toÃ n pháº§n</td>
</tr>
<tr>
<td>Retry-safe</td>
<td>Náº¿u lá»—i do máº¡ng â†’ message sáº½ Ä‘Æ°á»£c retry</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="framework-ho-tro">ğŸ§­ Framework há»— trá»£<a class="headerlink" href="#framework-ho-tro" title="Permanent link">Â¶</a></h3>
<ul>
<li>Google Pub/Sub client (<code>google-cloud-pubsub</code>)</li>
<li>Wrapper: <code>pubsub_fastapi</code>, <code>pubsub-consumer</code> custom</li>
<li>CÃ³ thá»ƒ tÃ­ch há»£p vÃ o background task trong <code>main.py</code></li>
</ul>
<hr/>
<h3 id="cleanup">ğŸ§¼ Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng TTL hoáº·c cronjob Ä‘á»ƒ xoÃ¡ báº£n ghi <code>processed_messages</code> cÅ©</li>
<li>CÃ³ thá»ƒ dÃ¹ng Redis thay DB náº¿u cáº§n tá»‘c Ä‘á»™ cao vÃ  lÆ°u ngáº¯n háº¡n</li>
</ul>
<hr/>
<p>ğŸ“ Máº«u event flow: <a href="../../architecture/system-diagrams/#5-data-synchronization-flow--Ä‘á»“ng-bá»™-há»c-sinh-crm--sis--lms">System Diagrams</a></p>
<p>ğŸ“ Quy Æ°á»›c Pub/Sub topic: <a href="../ops-guide/#8-quáº£n-lÃ½-pubsub--dead-letter">Dev Ops Guide</a></p>
<hr/>
<h2 id="10-test-on-vi-tich-hop">10. Test Ä‘Æ¡n vá»‹ &amp; tÃ­ch há»£p<a class="headerlink" href="#10-test-on-vi-tich-hop" title="Permanent link">Â¶</a></h2>
<p>Viáº¿t test lÃ  báº¯t buá»™c trong má»—i backend service. dx-vas Æ°u tiÃªn <strong>unit test cho service layer</strong> vÃ  <strong>integration test cho route + DB + Pub/Sub</strong>.</p>
<hr/>
<h3 id="cau-truc-thu-muc-test">ğŸ§ª Cáº¥u trÃºc thÆ° má»¥c test<a class="headerlink" href="#cau-truc-thu-muc-test" title="Permanent link">Â¶</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>tests/
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>â”œâ”€â”€ unit/
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a>â”‚   â””â”€â”€ test\_user\_service.py
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a>â”œâ”€â”€ integration/
</span><span id="__span-25-5"><a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a>â”‚   â”œâ”€â”€ test\_user\_routes.py
</span><span id="__span-25-6"><a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a>â”‚   â””â”€â”€ test\_pubsub\_event.py
</span><span id="__span-25-7"><a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a>â”œâ”€â”€ conftest.py
</span></code></pre></div>
<hr/>
<h3 id="unit-test-service-khong-phu-thuoc-db">âœ… Unit test â€“ Service khÃ´ng phá»¥ thuá»™c DB<a class="headerlink" href="#unit-test-service-khong-phu-thuoc-db" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_get_user_success</span><span class="p">():</span>
</span><span id="__span-26-2"><a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a>    <span class="n">fake_repo</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span id="__span-26-3"><a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>    <span class="n">fake_repo</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span>\<span class="s2">"John</span><span class="se">\"</span><span class="s2">)</span>
</span><span id="__span-26-4"><a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a>
</span><span id="__span-26-5"><a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a>    <span class="n">svc</span> <span class="o">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">fake_repo</span><span class="p">)</span>
</span><span id="__span-26-6"><a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">svc</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-7"><a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a>
</span><span id="__span-26-8"><a href="#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> \<span class="s2">"John</span><span class="se">\"</span>
</span></code></pre></div>
<ul>
<li>DÃ¹ng <code>MagicMock</code> Ä‘á»ƒ mÃ´ phá»ng repository</li>
<li>KhÃ´ng cáº§n DB hoáº·c HTTP client</li>
<li>Cháº¡y nhanh, dá»… debug</li>
</ul>
<hr/>
<h3 id="integration-test-route-db">ğŸ” Integration test â€“ Route + DB<a class="headerlink" href="#integration-test-route-db" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_create_user</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
</span><span id="__span-27-2"><a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a>    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>\<span class="s2">"name</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">John</span><span class="se">\"</span><span class="s2">}</span>
</span><span id="__span-27-3"><a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>\<span class="s2">"/v1/users</span><span class="se">\"</span><span class="s2">, json=payload)</span>
</span><span id="__span-27-4"><a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
</span></code></pre></div>
<ul>
<li>DÃ¹ng <code>TestClient</code> cá»§a FastAPI + session test DB</li>
<li>CÃ³ thá»ƒ seed dá»¯ liá»‡u báº±ng fixture</li>
</ul>
<hr/>
<h3 id="pytest-fixture-goi-y-conftestpy">ğŸ§© Pytest fixture gá»£i Ã½ (<code>conftest.py</code>)<a class="headerlink" href="#pytest-fixture-goi-y-conftestpy" title="Permanent link">Â¶</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-28-2"><a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">():</span>
</span><span id="__span-28-3"><a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
</span><span id="__span-28-4"><a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a>    <span class="k">yield</span> <span class="n">session</span>
</span><span id="__span-28-5"><a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a>    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-28-6"><a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a>    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-28-7"><a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a>
</span><span id="__span-28-8"><a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
</span><span id="__span-28-9"><a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
</span><span id="__span-28-10"><a href="#__codelineno-28-10" id="__codelineno-28-10" name="__codelineno-28-10"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
</span><span id="__span-28-11"><a href="#__codelineno-28-11" id="__codelineno-28-11" name="__codelineno-28-11"></a>    <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></code></pre></div>
<hr/>
<h3 id="luu-y-khi-viet-test">ğŸ’¡ LÆ°u Ã½ khi viáº¿t test<a class="headerlink" href="#luu-y-khi-viet-test" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>NguyÃªn táº¯c</th>
<th>Giáº£i thÃ­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td>TÃªn test rÃµ rÃ ng</td>
<td><code>test_create_user_fail_invalid_email()</code></td>
</tr>
<tr>
<td>Test khÃ´ng phá»¥ thuá»™c nhau</td>
<td>KhÃ´ng dÃ¹ng shared global state</td>
</tr>
<tr>
<td>Bao phá»§ logic ráº½ nhÃ¡nh</td>
<td>Test success, fail, edge case</td>
</tr>
<tr>
<td>Mock Ä‘Ãºng chá»—</td>
<td>Repo, API external, Pub/Sub client</td>
</tr>
</tbody>
</table>
<ul>
<li>CÃ³ thá»ƒ dÃ¹ng <code>pytest-mock</code> hoáº·c <code>unittest.mock</code> Ä‘á»ƒ mock nhanh logic phá»¥ thuá»™c (Pub/Sub, Redis)</li>
<li>Äá»‘i vá»›i integration test:</li>
<li>DÃ¹ng Alembic Ä‘á»ƒ apply schema lÃªn test DB (hoáº·c táº¡o file <code>.sql</code>)</li>
<li>Seed data máº«u báº±ng fixture (VD: 1 há»c sinh, 1 lá»›p há»c)</li>
<li>Rollback sau má»—i test Ä‘á»ƒ Ä‘áº£m báº£o isolation</li>
</ul>
<hr/>
<p>ğŸ“ Coverage tá»‘i thiá»ƒu yÃªu cáº§u: 85% cho unit, 70% cho integration
ğŸ“ Lá»‡nh test máº«u:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a>make<span class="w"> </span><span class="nb">test</span>
</span><span id="__span-29-2"><a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a>pytest<span class="w"> </span>tests/unit/
</span><span id="__span-29-3"><a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a>pytest<span class="w"> </span>--cov<span class="o">=</span>app
</span></code></pre></div>
<hr/>
<h2 id="11-checklist-khi-tao-pr-backend">11. Checklist khi táº¡o PR backend<a class="headerlink" href="#11-checklist-khi-tao-pr-backend" title="Permanent link">Â¶</a></h2>
<p>Má»—i Pull Request (PR) backend trong dx-vas cáº§n tuÃ¢n theo checklist sau Ä‘á»ƒ Ä‘áº£m báº£o cháº¥t lÆ°á»£ng, tÃ­nh nháº¥t quÃ¡n vÃ  trÃ¡nh lá»—i khi merge vÃ o nhÃ¡nh chÃ­nh.</p>
<hr/>
<h3 id="checklist-ky-thuat">âœ… Checklist ká»¹ thuáº­t<a class="headerlink" href="#checklist-ky-thuat" title="Permanent link">Â¶</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> TÃªn PR rÃµ rÃ ng, theo format: <code>[feature] Add create student usecase</code></li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> Code Ä‘Ã£ format báº±ng Black / isort / lint pass</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> ÄÃ£ thÃªm unit test cho logic nghiá»‡p vá»¥</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> ÄÃ£ thÃªm integration test cho API / DB / PubSub</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> Äáº£m báº£o test pass (<code>make test</code>, CI green)</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> KhÃ´ng commit <code>.env</code>, file secret hoáº·c credential</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> KhÃ´ng hardcode config, API key trong code</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> Schema Ä‘áº§u vÃ o cÃ³ validate Ä‘áº§y Ä‘á»§ (Pydantic)</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> Error tráº£ vá» Ä‘Ãºng <code>ErrorEnvelope</code> chuáº©n</li>
</ul>
<hr/>
<h3 id="checklist-logic-nghiep-vu">ğŸ“ Checklist logic nghiá»‡p vá»¥<a class="headerlink" href="#checklist-logic-nghiep-vu" title="Permanent link">Â¶</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> Náº¿u cÃ³ sá»­a DB â†’ Ä‘Ã£ viáº¿t migration</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"><span class="task-list-indicator"></span></input></label> Náº¿u thÃªm permission â†’ cáº­p nháº­t file RBAC <code>permissions.yaml</code>
    ğŸ“ Xem cÃ¡ch Ä‘á»‹nh nghÄ©a permission táº¡i <a href="../../architecture/rbac-deep-dive/#5-permission-cÃ³-Ä‘iá»u-kiá»‡n-condition-jsonb">RBAC Deep Dive</a></li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> Náº¿u thay Ä‘á»•i API â†’ cáº­p nháº­t OpenAPI / Interface Contracts</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> Náº¿u áº£nh hÆ°á»Ÿng cross-service â†’ Ä‘Ã£ thÃ´ng bÃ¡o/ghi chÃº rÃµ</li>
<li class="task-list-item"><label class="task-list-control"><input disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> Náº¿u cáº§n sync dá»¯ liá»‡u â†’ viáº¿t rÃµ flow trong commit message</li>
</ul>
<hr/>
<h3 id="goi-y-review">ğŸ” Gá»£i Ã½ review<a class="headerlink" href="#goi-y-review" title="Permanent link">Â¶</a></h3>
<ul>
<li>Xem flow tá»« API â†’ Service â†’ Repo â†’ Test</li>
<li>Xem logging cÃ³ Ä‘Ãºng cáº¥p Ä‘á»™, khÃ´ng log sensitive</li>
<li>Xem logic ráº½ nhÃ¡nh Ä‘áº§y Ä‘á»§ chÆ°a (success, fail, edge case)</li>
<li>Comment rÃµ TODO náº¿u cÃ²n dá»Ÿ dang (vÃ  ghi task follow-up)</li>
</ul>
<hr/>
<p>ğŸ“ Format commit message â†’ xem Dev Guide  </p>
<p>ğŸ“ Quáº£n lÃ½ permission â†’ xem RBAC Deep Dive  </p>
<p>ğŸ“ Migration &amp; version DB â†’ xem Dev Ops Guide má»¥c 7</p>
<hr/>
<h2 id="12-tai-lieu-lien-quan">12. TÃ i liá»‡u liÃªn quan<a class="headerlink" href="#12-tai-lieu-lien-quan" title="Permanent link">Â¶</a></h2>
<p>DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c tÃ i liá»‡u ná»™i bá»™ há»— trá»£ cho quÃ¡ trÃ¬nh phÃ¡t triá»ƒn backend trong há»‡ thá»‘ng dx-vas. Developer nÃªn tham kháº£o Ä‘áº§y Ä‘á»§ Ä‘á»ƒ náº¯m Ä‘Æ°á»£c toÃ n bá»™ bá»©c tranh kiáº¿n trÃºc, quy trÃ¬nh CI/CD, RBAC, interface contracts, vÃ  váº­n hÃ nh.</p>
<hr/>
<h3 id="tai-lieu-kien-truc-luong-he-thong">ğŸ“š TÃ i liá»‡u kiáº¿n trÃºc &amp; luá»“ng há»‡ thá»‘ng<a class="headerlink" href="#tai-lieu-kien-truc-luong-he-thong" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃ i liá»‡u</th>
<th>Má»¥c tiÃªu</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../../architecture/system-diagrams/">System Diagrams</a></td>
<td>Tá»•ng quan kiáº¿n trÃºc, sÆ¡ Ä‘á»“ cÃ¡c luá»“ng nghiá»‡p vá»¥</td>
</tr>
<tr>
<td><a href="../../architecture/rbac-deep-dive/">RBAC Deep Dive</a></td>
<td>Kiáº¿n trÃºc RBAC Ä‘á»™ng, JSONB, phÃ¢n quyá»n &amp; cache</td>
</tr>
<tr>
<td><a href="../interfaces/">Interface Contracts</a></td>
<td>Äá»‹nh nghÄ©a OpenAPI + schema liÃªn service</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="dev-guide-cicd">ğŸ§ª Dev Guide &amp; CI/CD<a class="headerlink" href="#dev-guide-cicd" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>TÃ i liá»‡u</th>
<th>Má»¥c tiÃªu</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../dev-guide/">Dev Guide</a></td>
<td>HÆ°á»›ng dáº«n CI/CD, test, lint, docker hÃ³a, PR flow</td>
</tr>
<tr>
<td><a href="../ops-guide/">Dev Ops Guide</a></td>
<td>HÆ°á»›ng dáº«n váº­n hÃ nh: Cloud Run, Redis, Pub/Sub</td>
</tr>
<tr>
<td><a href="../../ADR/">ADR Index</a></td>
<td>Danh sÃ¡ch cÃ¡c quyáº¿t Ä‘á»‹nh kiáº¿n trÃºc quan trá»ng</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="service-template-example">ğŸ›  Service template &amp; example<a class="headerlink" href="#service-template-example" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Repo</th>
<th>Vai trÃ²</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/vas-org/dx-service-template"><code>dx-service-template</code></a></td>
<td>Máº«u service chuáº©n (FastAPI, pubsub, test, CI)</td>
</tr>
<tr>
<td><a href="https://github.com/vas-org/dx-user-service"><code>dx-user-service</code></a></td>
<td>Triá»ƒn khai máº«u: RBAC, JWT, user CRUD</td>
</tr>
<tr>
<td><a href="https://github.com/vas-org/dx-notification-service"><code>dx-notification-service</code></a></td>
<td>Gá»­i thÃ´ng bÃ¡o Web/Zalo/Email, Pub/Sub event-driven</td>
</tr>
</tbody>
</table>
<hr/>
<p>ğŸ“ Developer má»›i nÃªn Ä‘á»c theo thá»© tá»±:</p>
<ol>
<li><code>backend-dev-guide.md</code> (tÃ i liá»‡u nÃ y)</li>
<li>System Diagrams â†’ RBAC Deep Dive</li>
<li>Dev Guide â†’ Dev Ops Guide</li>
</ol>
<hr/>
<h2 id="13-logging-best-practices">13. Logging Best Practices<a class="headerlink" href="#13-logging-best-practices" title="Permanent link">Â¶</a></h2>
<p>Há»‡ thá»‘ng nÃªn sá»­ dá»¥ng logging chuáº©n vá»›i cÃ¡c nguyÃªn táº¯c sau Ä‘á»ƒ Ä‘áº£m báº£o kháº£ nÄƒng giÃ¡m sÃ¡t vÃ  trace dá»… dÃ ng:</p>
<h3 id="cap-o-log">ğŸ” Cáº¥p Ä‘á»™ log<a class="headerlink" href="#cap-o-log" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>Má»¥c Ä‘Ã­ch</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td>Chi tiáº¿t ká»¹ thuáº­t Ä‘á»ƒ debug (khÃ´ng log á»Ÿ production)</td>
</tr>
<tr>
<td>INFO</td>
<td>BÆ°á»›c xá»­ lÃ½ chÃ­nh, hÃ nh vi ngÆ°á»i dÃ¹ng</td>
</tr>
<tr>
<td>WARNING</td>
<td>Báº¥t thÆ°á»ng khÃ´ng gÃ¢y lá»—i</td>
</tr>
<tr>
<td>ERROR</td>
<td>Lá»—i nghiÃªm trá»ng, nÃªn cÃ³ traceback</td>
</tr>
</tbody>
</table>
<h3 id="cau-truc-log">ğŸ“¦ Cáº¥u trÃºc log<a class="headerlink" href="#cau-truc-log" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng structured log (JSON format) â†’ dá»… tÃ­ch há»£p vá»›i Cloud Logging</li>
<li>Bao gá»“m <code>request_id</code>, <code>user_id</code> náº¿u cÃ³ thá»ƒ</li>
<li>Log theo trace-id náº¿u dÃ¹ng OpenTelemetry hoáº·c tÆ°Æ¡ng tá»±</li>
</ul>
<h3 id="goi-y-log-theo-tang">ğŸ§­ Gá»£i Ã½ log theo táº§ng<a class="headerlink" href="#goi-y-log-theo-tang" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Táº§ng</th>
<th>Log gÃ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>Handler</td>
<td>Báº¯t Ä‘áº§u/káº¿t thÃºc xá»­ lÃ½ request, input</td>
</tr>
<tr>
<td>Service</td>
<td>BÆ°á»›c nghiá»‡p vá»¥ quan trá»ng, Ä‘iá»u kiá»‡n phÃ¢n nhÃ¡nh</td>
</tr>
<tr>
<td>Repo</td>
<td>Truy váº¥n Ä‘áº·c biá»‡t hoáº·c lá»—i DB</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ“ KhÃ´ng log dá»¯ liá»‡u nháº¡y cáº£m (password, token, email há»c sinh...)</p>
</blockquote>
<hr/>
<h2 id="14-security-considerations-can-nhac-bao-mat-cho-backend">14. Security Considerations â€“ CÃ¢n nháº¯c báº£o máº­t cho Backend<a class="headerlink" href="#14-security-considerations-can-nhac-bao-mat-cho-backend" title="Permanent link">Â¶</a></h2>
<h3 id="nguyen-tac-cot-loi_1">ğŸ” NguyÃªn táº¯c cá»‘t lÃµi<a class="headerlink" href="#nguyen-tac-cot-loi_1" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Security by Design:</strong> Báº£o máº­t khÃ´ng pháº£i lÃ  tÃ­nh nÄƒng phá»¥ trá»£ â€“ nÃ³ pháº£i Ä‘Æ°á»£c tÃ­ch há»£p ngay tá»« kiáº¿n trÃºc vÃ  quy trÃ¬nh phÃ¡t triá»ƒn.</li>
<li><strong>Zero Trust</strong>: KhÃ´ng giáº£ Ä‘á»‹nh báº¥t ká»³ nguá»“n dá»¯ liá»‡u nÃ o lÃ  an toÃ n, ká»ƒ cáº£ tá»« ná»™i bá»™.</li>
</ul>
<hr/>
<h3 id="input-validation-sanity-check">ğŸ§ª Input validation &amp; Sanity Check<a class="headerlink" href="#input-validation-sanity-check" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>LuÃ´n dÃ¹ng Pydantic Schema</strong> Ä‘á»ƒ kiá»ƒm soÃ¡t input cho API &amp; Pub/Sub.</li>
<li><strong>Validation bá»• sung á»Ÿ táº§ng Service</strong> náº¿u logic phá»©c táº¡p hÆ¡n (vÃ­ dá»¥: chá»‰ giÃ¡o viÃªn chá»§ nhiá»‡m má»›i sá»­a Ä‘iá»ƒm).</li>
<li><strong>KhÃ´ng tin tÆ°á»Ÿng payload ná»™i bá»™</strong> â€“ khÃ´ng Ä‘Æ°á»£c skip validation khi nháº­n request tá»« API Gateway hoáº·c tá»« event Pub/Sub.</li>
</ul>
<hr/>
<h3 id="quan-ly-secret-cau-hinh-an-toan">ğŸ” Quáº£n lÃ½ secret &amp; cáº¥u hÃ¬nh an toÃ n<a class="headerlink" href="#quan-ly-secret-cau-hinh-an-toan" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>KhÃ´ng bao giá» commit file <code>.env</code></strong> hoáº·c biáº¿n mÃ´i trÆ°á»ng chá»©a token, DB URL, v.v.</li>
<li><strong>Secrets nÃªn Ä‘Æ°á»£c quáº£n lÃ½ qua</strong>:</li>
<li>Google Secret Manager (hoáº·c <code>doppler</code>, <code>Vault</code> náº¿u dÃ¹ng self-hosted)</li>
<li>Inject vÃ o mÃ´i trÆ°á»ng Cloud Run qua <code>env var</code> hoáº·c <code>mount volume</code></li>
<li>TÃ¡ch biá»‡t <code>config.py</code> chá»©a biáº¿n cÃ´ng khai vÃ  <code>env var</code> chá»©a thÃ´ng tin nháº¡y cáº£m.</li>
</ul>
<hr/>
<h3 id="token-phan-quyen">ğŸ“¦ Token &amp; phÃ¢n quyá»n<a class="headerlink" href="#token-phan-quyen" title="Permanent link">Â¶</a></h3>
<ul>
<li>KhÃ´ng decode token JWT táº¡i backend náº¿u Ä‘Ã£ cÃ³ API Gateway kiá»ƒm tra rá»“i â€“ thay vÃ o Ä‘Ã³:</li>
<li><strong>Tin tÆ°á»Ÿng <code>X-User-ID</code>, <code>X-User-Role</code>, <code>X-Permissions</code></strong> Ä‘Æ°á»£c Gateway gáº¯n vÃ o header Ä‘Ã£ Ä‘Æ°á»£c kÃ½ (<code>X-Signature</code>)</li>
<li><strong>KhÃ´ng dÃ¹ng token client-side trá»±c tiáº¿p gá»i vÃ o backend</strong> â€“ má»i truy cáº­p báº¯t buá»™c qua Gateway.</li>
</ul>
<hr/>
<h3 id="owasp-api-security-cac-lo-hong-can-e-phong">ğŸ“› OWASP API Security â€“ CÃ¡c lá»— há»•ng cáº§n Ä‘á» phÃ²ng<a class="headerlink" href="#owasp-api-security-cac-lo-hong-can-e-phong" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Váº¥n Ä‘á»</th>
<th>Biá»‡n phÃ¡p</th>
</tr>
</thead>
<tbody>
<tr>
<td>Injection</td>
<td>DÃ¹ng ORM (SQLAlchemy), trÃ¡nh query raw náº¿u khÃ´ng escape</td>
</tr>
<tr>
<td>Broken Auth</td>
<td>KhÃ´ng dÃ¹ng xÃ¡c thá»±c riÃªng táº¡i backend â€“ chá»‰ kiá»ƒm tra phÃ¢n quyá»n</td>
</tr>
<tr>
<td>Excessive Data Exposure</td>
<td>DÃ¹ng <code>response_model</code> Ä‘á»ƒ giá»›i háº¡n dá»¯ liá»‡u tráº£ ra</td>
</tr>
<tr>
<td>Improper Asset Mgmt</td>
<td>KhÃ´ng expose <code>/docs</code>, <code>/openapi.json</code> trÃªn production</td>
</tr>
<tr>
<td>Lack of Rate Limit</td>
<td>ÄÃ£ xá»­ lÃ½ á»Ÿ API Gateway, nhÆ°ng váº«n cáº§n audit log local</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="logging-auditing">ğŸ§¯ Logging &amp; Auditing<a class="headerlink" href="#logging-auditing" title="Permanent link">Â¶</a></h3>
<ul>
<li>KhÃ´ng log dá»¯ liá»‡u nháº¡y cáº£m (email há»c sinh, mÃ£ OTP, token).</li>
<li>LuÃ´n log <code>request_id</code>, <code>user_id</code>, <code>endpoint</code>, vÃ  <code>status</code>.</li>
<li>Xem thÃªm pháº§n <a href="#13-logging-best-practices"><code>13. Logging Best Practices</code></a></li>
</ul>
<hr/>
<p>ğŸ“Œ Xem thÃªm chÃ­nh sÃ¡ch báº£o máº­t toÃ n há»‡ thá»‘ng táº¡i ADR: <a href="../../ADR/adr-004-security/"><code>adr-004-security.md</code></a></p>
<hr/>
<h2 id="15-performance-tips-toi-uu-hieu-nang-backend">15. Performance Tips â€“ Tá»‘i Æ°u hiá»‡u nÄƒng Backend<a class="headerlink" href="#15-performance-tips-toi-uu-hieu-nang-backend" title="Permanent link">Â¶</a></h2>
<p>Hiá»‡u nÄƒng há»‡ thá»‘ng khÃ´ng chá»‰ phá»¥ thuá»™c vÃ o háº¡ táº§ng mÃ  cÃ²n bá»‹ áº£nh hÆ°á»Ÿng trá»±c tiáº¿p bá»Ÿi cÃ¡ch viáº¿t code á»Ÿ táº§ng service vÃ  repository.</p>
<hr/>
<h3 id="truy-van-db-hieu-qua">ğŸ“¥ Truy váº¥n DB hiá»‡u quáº£<a class="headerlink" href="#truy-van-db-hieu-qua" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Máº¹o</th>
<th>Ghi chÃº</th>
</tr>
</thead>
<tbody>
<tr>
<td>DÃ¹ng <code>.limit()</code> thay vÃ¬ <code>.all()</code> náº¿u dá»¯ liá»‡u nhiá»u</td>
<td>TrÃ¡nh load toÃ n bá»™ báº£ng vÃ o RAM</td>
</tr>
<tr>
<td>DÃ¹ng <code>selectinload()</code> hoáº·c <code>joinedload()</code> khi cáº§n truy cáº­p nhiá»u báº£n ghi liÃªn quan</td>
<td>TrÃ¡nh N+1 query</td>
</tr>
<tr>
<td>TrÃ¡nh <code>.count()</code> trong báº£ng lá»›n</td>
<td>Náº¿u cÃ³ thá»ƒ, dÃ¹ng limit + exists/check</td>
</tr>
<tr>
<td>TÃ¡ch cÃ¡c truy váº¥n phÃ¢n tÃ­ch/phá»©c táº¡p ra background</td>
<td>TrÃ¡nh block API request</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="caching-neu-can-thiet">ğŸ“¤ Caching náº¿u cáº§n thiáº¿t<a class="headerlink" href="#caching-neu-can-thiet" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>KhÃ´ng nÃªn cache sá»›m</strong> â€“ chá»‰ cache khi tháº¥y rÃµ bottleneck</li>
<li>Æ¯u tiÃªn cache káº¿t quáº£ <code>read-only</code> (VD: danh sÃ¡ch ngÃ nh há»c)</li>
<li>DÃ¹ng Redis hoáº·c local in-memory cache (VD: <code>lru_cache</code>) náº¿u phÃ¹ há»£p</li>
<li>Cáº©n trá»ng vá»›i cache invalidation náº¿u dá»¯ liá»‡u thÆ°á»ng xuyÃªn thay Ä‘á»•i</li>
</ul>
<hr/>
<h3 id="toi-uu-luong-xu-ly">ğŸª„ Tá»‘i Æ°u luá»“ng xá»­ lÃ½<a class="headerlink" href="#toi-uu-luong-xu-ly" title="Permanent link">Â¶</a></h3>
<table>
<thead>
<tr>
<th>Ká»¹ thuáº­t</th>
<th>DÃ¹ng khi nÃ o</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BackgroundTasks</code> (FastAPI)</td>
<td>Gá»­i email, sync webhook, audit, log external</td>
</tr>
<tr>
<td><code>Pub/Sub</code> hoáº·c message queue</td>
<td>TÃ¡ch cÃ¡c hÃ nh Ä‘á»™ng khÃ´ng cáº§n blocking user</td>
</tr>
<tr>
<td>Batch insert/update</td>
<td>Náº¿u cáº§n ghi hÃ ng loáº¡t (VD: Ä‘iá»ƒm há»c sinh)</td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="giam-thieu-io-blocking">ğŸ§® Giáº£m thiá»ƒu I/O Blocking<a class="headerlink" href="#giam-thieu-io-blocking" title="Permanent link">Â¶</a></h3>
<ul>
<li>LuÃ´n dÃ¹ng <code>async def</code> á»Ÿ API handler náº¿u gá»i I/O (DB, HTTP)</li>
<li>TrÃ¡nh cÃ¡c blocking call trong async context (VD: <code>requests.get()</code> â†’ dÃ¹ng <code>httpx.AsyncClient</code>)</li>
</ul>
<hr/>
<h3 id="o-luong-va-theo-doi">ğŸ§ª Äo lÆ°á»ng vÃ  theo dÃµi<a class="headerlink" href="#o-luong-va-theo-doi" title="Permanent link">Â¶</a></h3>
<ul>
<li>DÃ¹ng <code>OpenTelemetry</code> Ä‘á»ƒ trace request &amp; Ä‘o thá»i gian xá»­ lÃ½ tá»«ng táº§ng</li>
<li>Äo <code>latency</code> vÃ  <code>throughput</code> theo tá»«ng API</li>
<li>GiÃ¡m sÃ¡t sá»‘ lÆ°á»£ng request lá»—i (5xx), timeout, vÃ  retry qua cÃ¡c biá»ƒu Ä‘á»“ Cloud Monitoring</li>
</ul>
<hr/>
<p>ğŸ“Œ Xem thÃªm cáº¥u trÃºc log vÃ  trace táº¡i Má»¥c <a href="#13-logging-best-practices"><code>13. Logging</code></a> vÃ  cáº¥u hÃ¬nh háº¡ táº§ng táº¡i <a href="../ops-guide/">Dev Ops Guide</a></p>
<hr/>
<blockquote>
<p>ğŸ“ Developer má»›i nÃªn Ä‘á»c theo thá»© tá»±:</p>
<ol>
<li><code>backend-dev-guide.md</code> (tÃ i liá»‡u nÃ y)</li>
<li>System Diagrams â†’ RBAC Deep Dive</li>
<li>Dev Guide â†’ Dev Ops Guide</li>
</ol>
</blockquote>
<hr/>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Trá»Ÿ láº¡i má»¥c lá»¥c
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.indexes", "search.suggest", "search.highlight", "content.code.annotate", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u0110\u00e3 sao ch\u00e9p", "clipboard.copy": "Sao ch\u00e9p v\u00e0o b\u1ed9 nh\u1edb t\u1ea1m", "search.result.more.one": "1 t\u1eeb kh\u00e1c trong trang", "search.result.more.other": "# t\u1eeb kh\u00e1c trong trang", "search.result.none": "Kh\u00f4ng t\u00ecm th\u1ea5y t\u00e0i li\u1ec7u li\u00ean quan", "search.result.one": "1 t\u00e0i li\u1ec7u li\u00ean quan", "search.result.other": "# t\u00e0i li\u1ec7u li\u00ean quan", "search.result.placeholder": "Nh\u1eadp \u0111\u1ec3 b\u1eaft \u0111\u1ea7u t\u00ecm ki\u1ebfm", "search.result.term.missing": "Kh\u00f4ng", "select.version": "Ch\u1ecdn phi\u00ean b\u1ea3n"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>